
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加密货币实时行情</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script>
        // 确保 Chart.js 可以解析时间格式
        if (typeof Chart !== 'undefined') {
            Chart.defaults.plugins.tooltip.mode = 'nearest';
            Chart.defaults.plugins.tooltip.intersect = false;
        }

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#60A5FA',
                        accent: '#2563EB',
                        neutral: '#F3F4F6',
                        'neutral-dark': '#E5E7EB',
                        success: '#10B981',
                        danger: '#EF4444',
                        warning: '#F59E0B',
                        info: '#3B82F6',
                        dark: '#1E293B',
                        'dark-light': '#334155',
                        'dark-lighter': '#475569',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'custom': '0 4px 20px rgba(0, 0, 0, 0.1)',
                        'hover': '0 10px 30px rgba(59, 130, 246, 0.3)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .transition-all-300 {
                transition: all 0.3s ease;
            }
            .bg-gradient-primary {
                background: linear-gradient(135deg, #3B82F6, #60A5FA);
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .card-hover {
                @apply transition-all duration-300 hover:shadow-hover hover:-translate-y-1;
            }
            .price-up {
                @apply text-success font-medium;
            }
            .price-down {
                @apply text-danger font-medium;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .blink {
                animation: blink 1s infinite;
            }
            @keyframes blink {
                0% { opacity: 1; }
                50% { opacity: 0.5; }
                100% { opacity: 1; }
            }
        }
    </style>
    <style>
        #kk {
            background: linear-gradient(45deg, #ff7e5f, #feb47b, #ffed86, #9feb8f, #5fbfff, #9b8eff);
            color: black;
        }
        body {
            background: linear-gradient(45deg, #ff7e5f, #feb47b, #ffed86, #9feb8f, #5fbfff, #9b8eff);
            font-family: 'Inter', system-ui, sans-serif;
            color: black;
        }
        .crypto-card {
            transition: all 0.3s ease;
        }
        .crypto-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }
        .price-change-positive {
            color: #10B981;
            transition: all 0.3s ease;
        }
        .price-change-negative {
            color: #EF4444;
            transition: all 0.3s ease;
        }
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        .loading-spinner {
            border: 4px solid rgba(59, 130, 246, 0.1);
            border-left-color: #3B82F6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }
        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            color: #3B82F6;
            border-bottom: 2px solid #3B82F6;
        }
        .notification {
            transition: all 0.3s ease;
            transform: translateY(-100%);
            opacity: 0;
        }
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        .price-flash {
            animation: price-flash 0.5s ease;
        }
        @keyframes price-flash {
            0% {
                background-color: rgba(59, 130, 246, 0.2);
            }
            100% {
                background-color: transparent;
            }
        }
        .websocket-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-connected {
            background-color: #10B981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
        }
        .status-disconnected {
            background-color: #EF4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
        }
        .status-reconnecting {
            background-color: #F59E0B;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.6);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% {
                opacity: 0.6;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.6;
            }
        }
        /* 响应式调整 */
        @media (max-width: 640px) {
            .chart-container {
                height: 200px;
            }

            .crypto-list {
                font-size: 0.875rem;
            }

            .crypto-card {
                padding: 0.75rem;
            }
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 300px;
            }
        }
        @media (min-width: 1024px) {
            .chart-container {
                height: 350px;
            }
        }
        /* 深色模式 */
        @media (prefers-color-scheme: dark) {
            /* ... 深色模式 CSS 样式 (略) ... */
        }
    </style>
</head>
<body class="min-h-screen">
    <header id="kk" class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <i class="fa fa-line-chart text-primary text-2xl mr-2"></i>
                <h1 class="text-xl font-bold text-gray-800">加密货币实时行情</h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center">
                    <span id="websocket-status" class="websocket-status status-disconnected"></span>
                    <span id="connection-status" class="text-sm text-gray-500">未连接</span>
                </div>
                <button id="refresh-btn" class="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition-all">
                    <i class="fa fa-refresh"></i>
                    <span>刷新</span>
                </button>
                <button id="theme-toggle" class="p-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition-all">
                    <i class="fa fa-moon-o"></i>
                </button>
            </div>
        </div>
    </header>
    <main class="container mx-auto px-4 py-6">
        <section class="mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">市场概览</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white rounded-xl shadow-custom p-4 card-hover">
                    <p class="text-gray-500 text-sm">总市值</p>
                    <div class="flex items-center justify-between mt-1">
                        <h3 id="total-market-cap" class="text-2xl font-bold text-gray-800">$0</h3>
                        <span id="market-cap-change" class="text-sm price-up">
                            <i class="fa fa-arrow-up mr-1"></i>0%
                        </span>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-custom p-4 card-hover">
                    <p class="text-gray-500 text-sm">24小时交易量</p>
                    <div class="flex items-center justify-between mt-1">
                        <h3 id="total-volume" class="text-2xl font-bold text-gray-800">$0</h3>
                        <span id="volume-change" class="text-sm price-up">
                            <i class="fa fa-arrow-up mr-1"></i>0%
                        </span>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-custom p-4 card-hover">
                    <p class="text-gray-500 text-sm">比特币主导率</p>
                    <div class="flex items-center justify-between mt-1">
                        <h3 id="bitcoin-dominance" class="text-2xl font-bold text-gray-800">0%</h3>
                        <span id="dominance-change" class="text-sm price-up">
                            <i class="fa fa-arrow-up mr-1"></i>0%
                        </span>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-custom p-4 card-hover">
                    <p class="text-gray-500 text-sm">加密货币数量</p>
                    <div class="flex items-center justify-between mt-1">
                        <h3 id="total-coins" class="text-2xl font-bold text-gray-800">0</h3>
                        <span id="coins-change" class="text-sm price-up">
                            <i class="fa fa-arrow-up mr-1"></i>0
                        </span>
                    </div>
                </div>
            </div>
        </section>

      

        <section class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">热门币种实时行情</h2>
                <div class="relative">
                    <input type="text" id="search-input" class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30" placeholder="搜索币种...">
                    <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-custom overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">排名</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">币种</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">价格</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">24h变化</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">7d变化</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">市值</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">24h交易量</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">实时更新</th>
                            </tr>
                        </thead>
                        <tbody id="crypto-table-body">
                            <tr>
                                <td colspan="8" class="px-4 py-8 text-center">
                                    <div class="flex flex-col items-center">
                                        <div class="loading-spinner mb-4"></div>
                                        <p class="text-gray-500">加载中...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section class="mb-8">
            <div class="bg-white rounded-xl shadow-custom p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">实时交易记录</h2>
                    <div class="flex gap-2">
                        <select id="trade-coin-select" class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/30">
                            <option value="bitcoin">比特币 (BTC)</option>
                            <option value="ethereum">以太坊 (ETH)</option>
                            <option value="binancecoin">币安币 (BNB)</option>
                            <option value="solana">Solana (SOL)</option>
                            <option value="cardano">Cardano (ADA)</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-y-auto max-h-64 scrollbar-hide">
                    <table class="w-full" id="trades-table">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">时间</th>
                                <th class="px-4 py-2 text-right text-sm font-medium text-gray-500">价格</th>
                                <th class="px-4 py-2 text-right text-sm font-medium text-gray-500">数量</th>
                                <th class="px-4 py-2 text-right text-sm font-medium text-gray-500">交易额</th>
                                <th class="px-4 py-2 text-center text-sm font-medium text-gray-500">类型</th>
                            </tr>
                        </thead>
                        <tbody id="trades-table-body">
                            <tr>
                                <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                    等待交易数据...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div id="notification" class="notification fixed top-4 right-4 bg-success text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2">
        <i id="notification-icon" class="fa fa-check-circle"></i>
        <span id="notification-text">操作成功</span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const refreshBtn = document.getElementById('refresh-btn');
            const themeToggle = document.getElementById('theme-toggle');
            const searchInput = document.getElementById('search-input');
            const cryptoTableBody = document.getElementById('crypto-table-body');
            const tradesTableBody = document.getElementById('trades-table-body');
            const tradeCoinSelect = document.getElementById('trade-coin-select');
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            const notificationIcon = document.getElementById('notification-icon');
            const timeFilterButtons = document.querySelectorAll('.time-filter');
            const websocketStatus = document.getElementById('websocket-status');
            const connectionStatus = document.getElementById('connection-status');

            // 市场概览元素
            const totalMarketCapElement = document.getElementById('total-market-cap');
            const marketCapChangeElement = document.getElementById('market-cap-change');
            const totalVolumeElement = document.getElementById('total-volume');
            const volumeChangeElement = document.getElementById('volume-change');
            const bitcoinDominanceElement = document.getElementById('bitcoin-dominance');
            const dominanceChangeElement = document.getElementById('dominance-change');
            const totalCoinsElement = document.getElementById('total-coins');
            const coinsChangeElement = document.getElementById('coins-change');

            // 图表相关
            let priceChart;
            let currentTimeFilter = '24h';
            let chartData = {};
            const CHART_COINS = ['bitcoin', 'ethereum', 'binancecoin', 'solana', 'cardano'];

            // 存储加密货币数据
            let cryptoData = [];
            let filteredData = [];
            let tradesData = [];
            const MAX_TRADES = 10;

            // WebSocket相关 (使用模拟实现)
            let wsSimulatedInterval;
            let isWsConnected = false;
            let lastUpdateTime = new Date();

            // API配置
            const API_BASE_URL = 'https://api.coingecko.com/api/v3';
            const API_OPTIONS = {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            };

            // --- 辅助函数 ---
            function formatCurrency(number) {
                if (!number) return '$0';
                return '$' + new Intl.NumberFormat('en-US', {
                    notation: 'compact',
                    compactDisplay: 'short',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 1
                }).format(number);
            }

            function formatNumber(number) {
                if (!number) return '0';
                return new Intl.NumberFormat('en-US', {
                    notation: 'compact',
                    compactDisplay: 'short',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 1
                }).format(number);
            }

            function formatChange(percentage) {
                const num = parseFloat(percentage);
                const sign = num >= 0 ? '<i class="fa fa-arrow-up mr-1"></i>' : '<i class="fa fa-arrow-down mr-1"></i>';
                return `${Math.abs(num).toFixed(2)}%`;
            }

            function showNotification(message, type = 'success') {
                notificationText.textContent = message;
                notification.className = `notification fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 show`;
                notificationIcon.className = type === 'success' ? 'fa fa-check-circle' : 'fa fa-times-circle';
                notification.style.backgroundColor = type === 'success' ? '#10B981' : '#EF4444';

                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }

            function checkDarkMode() {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark');
                    themeToggle.querySelector('i').className = 'fa fa-sun-o';
                }
            }

            function toggleDarkMode() {
                document.body.classList.toggle('dark');
                const isDark = document.body.classList.contains('dark');
                themeToggle.querySelector('i').className = isDark ? 'fa fa-sun-o' : 'fa fa-moon-o';
            }

            // --- 初始化和事件 ---
            function init() {
                fetchMarketData();
                fetchCryptoList();
                setupEventListeners();
                checkDarkMode();
                setupSimulatedWebSocket(); // 使用模拟 WebSocket
            }

            function setupEventListeners() {
                refreshBtn.addEventListener('click', function() {
                    refreshBtn.disabled = true;
                    refreshBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i><span>刷新中...</span>';

                    Promise.all([fetchMarketData(), fetchCryptoList()])
                        .then(() => {
                            showNotification('数据已更新');
                        })
                        .catch(error => {
                            console.error('刷新数据失败:', error);
                            showNotification('刷新数据失败', 'error');
                        })
                        .finally(() => {
                            refreshBtn.disabled = false;
                            refreshBtn.innerHTML = '<i class="fa fa-refresh"></i><span>刷新</span>';
                        });
                });

                themeToggle.addEventListener('click', toggleDarkMode);

                searchInput.addEventListener('input', filterCryptoList);

                timeFilterButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        timeFilterButtons.forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');
                        currentTimeFilter = this.dataset.time;
                        // 重新获取图表数据并更新
                        initChart();
                    });
                });

                tradeCoinSelect.addEventListener('change', function() {
                    // 清空交易记录并等待新数据
                    tradesData = [];
                    tradesTableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                等待交易数据...
                            </td>
                        </tr>
                    `;
                    // 模拟切换交易数据
                    clearInterval(wsSimulatedInterval);
                    setupSimulatedWebSocket();
                });
            }

            // --- 市场数据获取和渲染 ---
            async function fetchMarketData() {
                try {
                    const response = await fetch(`${API_BASE_URL}/global`, API_OPTIONS);
                    const data = await response.json();

                    // 更新市场概览
                    totalMarketCapElement.textContent = formatCurrency(data.data.total_market_cap.usd);
                    marketCapChangeElement.innerHTML = formatChange(data.data.market_cap_change_percentage_24h_usd);
                    marketCapChangeElement.className = data.data.market_cap_change_percentage_24h_usd >= 0 ? 'text-sm price-up' : 'text-sm price-down';

                    totalVolumeElement.textContent = formatCurrency(data.data.total_volume.usd);
                    // 模拟volumeChangeElement
                    const simulatedVolumeChange = (Math.random() * 10 - 5).toFixed(2);
                    volumeChangeElement.innerHTML = formatChange(simulatedVolumeChange);
                    volumeChangeElement.className = parseFloat(simulatedVolumeChange) >= 0 ? 'text-sm price-up' : 'text-sm price-down';


                    bitcoinDominanceElement.textContent = `${data.data.market_cap_percentage.bitcoin.toFixed(2)}%`;

                    // 模拟比特币主导率变化
                    const dominanceChange = (Math.random() * 0.5 - 0.25).toFixed(2);
                    dominanceChangeElement.innerHTML = formatChange(dominanceChange);
                    dominanceChangeElement.className = parseFloat(dominanceChange) >= 0 ? 'text-sm price-up' : 'text-sm price-down';

                    totalCoinsElement.textContent = formatNumber(data.data.active_cryptocurrencies);
                    coinsChangeElement.innerHTML = '+12'; // 模拟变化

                } catch (error) {
                    console.error('获取市场数据失败:', error);
                    throw error;
                }
            }

            async function fetchCryptoList() {
                try {
                    const response = await fetch(`${API_BASE_URL}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&sparkline=false&price_change_percentage=24h%2C7d`, API_OPTIONS);
                    cryptoData = await response.json();
                    filteredData = [...cryptoData];

                    // 更新表格
                    updateCryptoTable();

                    // 初始化图表
                    initChart();

                } catch (error) {
                    console.error('获取加密货币列表失败:', error);
                    throw error;
                }
            }

            // --- 实时更新逻辑 (核心) ---

            function updateCryptoTable() {
                const currentUpdateTime = new Date();

                if (cryptoTableBody.innerHTML.includes('loading-spinner')) {
                    cryptoTableBody.innerHTML = '';
                }

                if (filteredData.length === 0) {
                    cryptoTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                没有找到匹配的币种
                            </td>
                        </tr>
                    `;
                    return;
                }

                // 只渲染前50个，以保持性能
                const currentRenderedIds = Array.from(cryptoTableBody.children).map(row => row.dataset.id);

                // 更新现有行或添加新行
                filteredData.slice(0, 50).forEach((crypto, index) => {
                    const existingRow = document.querySelector(`[data-id="${crypto.id}"]`);
                    const price24hChange = crypto.price_change_percentage_24h;
                    const price7dChange = crypto.price_change_percentage_7d_in_currency || 0; // 7d change key sometimes varies
                    const price24hClass = price24hChange >= 0 ? 'price-up' : 'price-down';
                    const price7dClass = price7dChange >= 0 ? 'price-up' : 'price-down';


                    if (existingRow) {
                        // 1. 价格变化闪烁动画
                        const oldPriceText = existingRow.querySelector('td:nth-child(3)').textContent;
                        const oldPrice = parseFloat(oldPriceText.replace('$', '').replace(/,/g, ''));
                        const newPrice = crypto.current_price;
                        if (newPrice !== oldPrice) {
                            existingRow.querySelector('td:nth-child(3)').classList.add('price-flash');
                            setTimeout(() => existingRow.querySelector('td:nth-child(3)').classList.remove('price-flash'), 500);
                        }

                        // 2. 更新内容
                        existingRow.querySelector('td:nth-child(1) span').textContent = index + 1;
                        existingRow.querySelector('td:nth-child(3)').textContent = `$${crypto.current_price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 })}`;
                        
                        existingRow.querySelector('td:nth-child(4)').innerHTML = `${price24hChange >= 0 ? '<i class="fa fa-arrow-up mr-1"></i>' : '<i class="fa fa-arrow-down mr-1"></i>'}${formatChange(price24hChange)}`;
                        existingRow.querySelector('td:nth-child(4)').className = `px-4 py-3 text-right ${price24hClass}`;
                        
                        existingRow.querySelector('td:nth-child(5)').innerHTML = `${price7dChange >= 0 ? '<i class="fa fa-arrow-up mr-1"></i>' : '<i class="fa fa-arrow-down mr-1"></i>'}${formatChange(price7dChange)}`;
                        existingRow.querySelector('td:nth-child(5)').className = `px-4 py-3 text-right ${price7dClass}`;

                        existingRow.querySelector('td:nth-child(6)').textContent = `$${formatNumber(crypto.market_cap)}`;
                        existingRow.querySelector('td:nth-child(7)').textContent = `$${formatNumber(crypto.total_volume)}`;
                        existingRow.querySelector('td:nth-child(8) span').className = 'inline-block w-2 h-2 bg-success rounded-full blink'; // 实时更新指示灯

                        // 3. 移除旧的实时指示灯动画
                        setTimeout(() => {
                            const indicator = existingRow.querySelector('td:nth-child(8) span');
                            if (indicator) {
                                indicator.classList.remove('blink');
                                indicator.classList.remove('bg-success');
                                indicator.classList.add('bg-gray-400');
                            }
                        }, 5000);

                    } else {
                        // 添加新行
                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-all';
                        row.dataset.id = crypto.id;

                        row.innerHTML = `
                            <td class="px-4 py-3">
                                <span class="text-gray-500">${index + 1}</span>
                            </td>
                            <td class="px-4 py-3">
                                <div class="flex items-center">
                                    <img src="${crypto.image}" alt="${crypto.name}" class="w-8 h-8 mr-3 rounded-full">
                                    <div>
                                        <div class="font-medium text-gray-800">${crypto.name}</div>
                                        <div class="text-gray-500 text-sm">${crypto.symbol.toUpperCase()}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-right font-medium text-gray-800 price-flash">
                                $${crypto.current_price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 })}
                            </td>
                            <td class="px-4 py-3 text-right ${price24hClass}">
                                ${price24hChange >= 0 ? '<i class="fa fa-arrow-up mr-1"></i>' : '<i class="fa fa-arrow-down mr-1"></i>'}${formatChange(price24hChange)}
                            </td>
                            <td class="px-4 py-3 text-right ${price7dClass}">
                                ${price7dChange >= 0 ? '<i class="fa fa-arrow-up mr-1"></i>' : '<i class="fa fa-arrow-down mr-1"></i>'}${formatChange(price7dChange)}
                            </td>
                            <td class="px-4 py-3 text-right text-gray-800">
                                $${formatNumber(crypto.market_cap)}
                            </td>
                            <td class="px-4 py-3 text-right text-gray-800">
                                $${formatNumber(crypto.total_volume)}
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="inline-block w-2 h-2 bg-success rounded-full blink"></span>
                            </td>
                        `;
                        cryptoTableBody.appendChild(row);

                        // 移除新行的闪烁动画
                        setTimeout(() => row.querySelector('td:nth-child(3)').classList.remove('price-flash'), 500);
                        setTimeout(() => row.querySelector('td:nth-child(8) span').classList.remove('blink', 'bg-success'), 5000);
                    }
                });
            }

            function filterCryptoList() {
                const searchTerm = searchInput.value.toLowerCase();
                filteredData = cryptoData.filter(crypto =>
                    crypto.name.toLowerCase().includes(searchTerm) ||
                    crypto.symbol.toLowerCase().includes(searchTerm)
                );
                updateCryptoTable();
            }

            function updateTradesTable(trade) {
                // 移除等待行
                if (tradesTableBody.children.length === 1 && tradesTableBody.children[0].textContent.includes('等待')) {
                    tradesTableBody.innerHTML = '';
                }

                tradesData.unshift(trade);
                tradesData = tradesData.slice(0, MAX_TRADES); // 保持最多MAX_TRADES条记录

                const row = document.createElement('tr');
                row.className = `border-b border-gray-200 ${trade.type === 'BUY' ? 'bg-success/10' : 'bg-danger/10'} transition-all`;
                row.innerHTML = `
                    <td class="px-4 py-2 text-left text-sm text-gray-800">${new Date(trade.time).toLocaleTimeString()}</td>
                    <td class="px-4 py-2 text-right text-sm font-medium ${trade.type === 'BUY' ? 'text-success' : 'text-danger'}">
                        $${trade.price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 4 })}
                    </td>
                    <td class="px-4 py-2 text-right text-sm text-gray-800">${trade.amount.toFixed(4)}</td>
                    <td class="px-4 py-2 text-right text-sm text-gray-800">$${(trade.price * trade.amount).toFixed(2).toLocaleString()}</td>
                    <td class="px-4 py-2 text-center text-sm font-bold ${trade.type === 'BUY' ? 'text-success' : 'text-danger'}">
                        ${trade.type === 'BUY' ? '买入' : '卖出'}
                    </td>
                `;

                // 插入到顶部
                if (tradesTableBody.children.length >= MAX_TRADES) {
                    tradesTableBody.removeChild(tradesTableBody.lastChild);
                }
                tradesTableBody.insertBefore(row, tradesTableBody.firstChild);
            }

            // --- 模拟 WebSocket 实时数据 ---
            function setupSimulatedWebSocket() {
                isWsConnected = true;
                websocketStatus.className = 'websocket-status status-connected';
                connectionStatus.textContent = '已连接';

                const selectedCoinId = tradeCoinSelect.value;
                const basePrice = cryptoData.find(c => c.id === selectedCoinId)?.current_price || 30000; // 使用实际价格或默认值
                let tradeCounter = 0;

                // 模拟每 1.5 秒接收一次价格更新和交易记录
                wsSimulatedInterval = setInterval(() => {
                    // 1. 模拟价格更新 (仅更新列表中的价格)
                    cryptoData = cryptoData.map(crypto => {
                        // 模拟价格随机小幅波动
                        const volatility = Math.random() * 0.005; // 0.5% 波动
                        const direction = Math.random() > 0.5 ? 1 : -1;
                        crypto.current_price *= (1 + direction * volatility);
                        crypto.current_price = Math.max(0.01, crypto.current_price); // 价格不为负
                        return crypto;
                    });
                    // 重新应用过滤和排序
                    filterCryptoList();
                    updateCryptoTable();

                    // 2. 模拟交易记录
                    tradeCounter++;
                    if (tradeCounter % 3 === 0) { // 每 3 个价格更新，模拟一条交易
                        const tradePrice = basePrice * (1 + (Math.random() * 0.01 - 0.005)); // 在基础价格附近小幅波动
                        const tradeAmount = Math.random() * 0.5 + 0.01;
                        const tradeType = Math.random() > 0.5 ? 'BUY' : 'SELL';

                        const newTrade = {
                            time: new Date().getTime(),
                            price: tradePrice,
                            amount: tradeAmount,
                            type: tradeType,
                            coin: selectedCoinId
                        };
                        updateTradesTable(newTrade);
                    }
                }, 1500);
            }

            // --- 图表功能 ---
            async function initChart() {
                try {
                    // days=1 对应 24h, days=7 对应 7d
                    const days = currentTimeFilter === '7d' ? 7 : 1;
                    // Coingecko对于 days=1 默认是 hourly，对于 days=7 默认是 daily。
                    // 这里的 interval 参数在 days=1 时 Coingecko API 会忽略。
                    const interval = currentTimeFilter === '7d' ? 'daily' : 'hourly';

                    const promises = CHART_COINS.map(coin => fetchCoinHistory(coin, days, interval));
                    const results = await Promise.all(promises);
                    chartData = {};

                    results.forEach((data, index) => {
                        chartData[CHART_COINS[index]] = data;
                    });
                    
                    if (Object.values(chartData).some(data => data.prices.length > 0)) {
                        updateChart();
                    } else {
                        console.warn("图表数据为空，无法渲染。");
                        // 可以在这里添加一个消息到 chart-container 告知用户
                    }

                } catch (error) {
                    console.error('初始化图表失败:', error);
                }
            }

            async function fetchCoinHistory(coinId, days, interval) {
                try {
                    const response = await fetch(`${API_BASE_URL}/coins/${coinId}/market_chart?vs_currency=usd&days=${days}&interval=${interval}`, API_OPTIONS);
                    const data = await response.json();

                    return {
                        // CoinGecko返回的是 [timestamp_ms, price] 数组
                        prices: data.prices.map(item => ({
                            x: item[0], // Chart.js time scale 需要毫秒时间戳
                            y: item[1]
                        })),
                        name: coinId
                    };
                } catch (error) {
                    console.error(`获取${coinId}历史数据失败:`, error);
                    return {
                        prices: [],
                        name: coinId
                    };
                }
            }

            function updateChart() {
                const ctx = document.getElementById('price-chart').getContext('2d');

                if (priceChart) {
                    priceChart.destroy();
                }

                const datasets = [];
                const colors = ['#F7931A', '#627EEA', '#F3BA2F', '#00FFA3', '#0070F3'];
                const coinNames = {
                    'bitcoin': '比特币 (BTC)',
                    'ethereum': '以太坊 (ETH)',
                    'binancecoin': '币安币 (BNB)',
                    'solana': 'Solana (SOL)',
                    'cardano': 'Cardano (ADA)'
                };

                let index = 0;
                for (const [coin, data] of Object.entries(chartData)) {
                    datasets.push({
                        label: coinNames[coin] || coin.toUpperCase(),
                        // **修正后的数据格式：使用 x: timestamp_ms, y: price**
                        data: data.prices,
                        borderColor: colors[index % colors.length],
                        backgroundColor: colors[index % colors.length] + '20',
                        borderWidth: 2,
                        tension: 0.2, // 稍微平滑的曲线
                        fill: false,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    });
                    index++;
                }

                priceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    boxWidth: 10,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += new Intl.NumberFormat('en-US', {
                                                style: 'currency',
                                                currency: 'USD',
                                                minimumFractionDigits: 2,
                                                maximumFractionDigits: 6
                                            }).format(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                // 关键配置：指定 type 为 'time'
                                type: 'time', 
                                time: {
                                    // time scale 依赖于 date-fns 适配器
                                    unit: currentTimeFilter === '7d' ? 'day' : 'hour',
                                    tooltipFormat: currentTimeFilter === '7d' ? 'MMM dd' : 'HH:mm',
                                    displayFormats: {
                                        hour: 'HH:mm',
                                        day: 'MMM dd'
                                    }
                                },
                                grid: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: '时间'
                                }
                            },
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        // 格式化 Y 轴标签为货币形式
                                        return new Intl.NumberFormat('en-US', {
                                            style: 'currency',
                                            currency: 'USD',
                                            notation: 'compact',
                                            compactDisplay: 'short'
                                        }).format(value);
                                    }
                                },
                                title: {
                                    display: true,
                                    text: '价格 (USD)'
                                }
                            }
                        }
                    }
                });
            }

            // 启动应用
            init();
        });
    </script>
</body>
</html>

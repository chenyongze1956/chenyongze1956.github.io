
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加密货币实时行情</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script>
        // 确保 Chart.js 可以解析时间格式
        if (typeof Chart !== 'undefined') {
            Chart.defaults.plugins.tooltip.mode = 'nearest';
            Chart.defaults.plugins.tooltip.intersect = false;
        }

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#60A5FA',
                        accent: '#2563EB',
                        neutral: '#F3F4F6',
                        'neutral-dark': '#E5E7EB',
                        success: '#10B981',
                        danger: '#EF4444',
                        warning: '#F59E0B',
                        info: '#3B82F6',
                        dark: '#1E293B',
                        'dark-light': '#334155',
                        'dark-lighter': '#475569',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'custom': '0 4px 20px rgba(0, 0, 0, 0.1)',
                        'hover': '0 10px 30px rgba(59, 130, 246, 0.3)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .transition-all-300 {
                transition: all 0.3s ease;
            }
            .bg-gradient-primary {
                background: linear-gradient(135deg, #3B82F6, #60A5FA);
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .card-hover {
                @apply transition-all duration-300 hover:shadow-hover hover:-translate-y-1;
            }
            .price-up {
                @apply text-success font-medium;
            }
            .price-down {
                @apply text-danger font-medium;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .blink {
                animation: blink 1s infinite;
            }
            @keyframes blink {
                0% { opacity: 1; }
                50% { opacity: 0.5; }
                100% { opacity: 1; }
            }
            
            /* === 移动端表格隐藏列辅助类 (Tailwind) === */
            /* 默认隐藏，中等屏幕及以上才显示 */
            .hide-on-mobile {
                @apply hidden md:table-cell; 
            }
            .hide-on-mobile-flex {
                 @apply hidden md:flex;
            }
            .hide-on-mobile-th {
                @apply hidden md:table-cell;
            }
            /* 移动端标题隐藏 */
            .hide-on-mobile-header {
                 @apply hidden sm:block;
            }
        }
    </style>
    <style>
        /* 保持背景和颜色，并添加响应式优化 */
        #kk {
            background: linear-gradient(45deg, #ff7e5f, #feb47b, #ffed86, #9feb8f, #5fbfff, #9b8eff);
            color: black;
        }
        body {
            background: linear-gradient(45deg, #ff7e5f, #feb47b, #ffed86, #9feb8f, #5fbfff, #9b8eff);
            font-family: 'Inter', system-ui, sans-serif;
            color: black;
        }
        .crypto-card {
            transition: all 0.3s ease;
        }
        .crypto-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }
        .price-change-positive {
            color: #10B981;
            transition: all 0.3s ease;
        }
        .price-change-negative {
            color: #EF4444;
            transition: all 0.3s ease;
        }
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        .loading-spinner {
            border: 4px solid rgba(59, 130, 246, 0.1);
            border-left-color: #3B82F6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }
        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            color: #3B82F6;
            border-bottom: 2px solid #3B82F6;
        }
        .notification {
            transition: all 0.3s ease;
            transform: translateY(-100%);
            opacity: 0;
        }
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        .price-flash {
            animation: price-flash 0.5s ease;
        }
        @keyframes price-flash {
            0% {
                background-color: rgba(59, 130, 246, 0.2);
            }
            100% {
                background-color: transparent;
            }
        }
        .websocket-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-connected {
            background-color: #10B981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
        }
        .status-disconnected {
            background-color: #EF4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
        }
        .status-reconnecting {
            background-color: #F59E0B;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.6);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% {
                opacity: 0.6;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.6;
            }
        }
        
        /* 响应式调整 */
        @media (max-width: 640px) {
            .chart-container {
                height: 180px;
            }
            
            /* 强制表格字体更小 */
            #crypto-table-body, #trades-table-body {
                font-size: 0.75rem; /* 12px */
            }
            
            /* 减小表格单元格内边距 */
            #crypto-table-body td, #crypto-table-body th {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            /* 减小头部 H1 字体 */
            #kk h1 {
                font-size: 1.25rem; /* text-xl */
            }
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 300px;
            }
        }
        @media (min-width: 1024px) {
            .chart-container {
                height: 350px;
            }
        }
        /* 深色模式 */
        @media (prefers-color-scheme: dark) {
            /* ... 深色模式 CSS 样式 (略) ... */
        }
    </style>
</head>
<body class="min-h-screen">
    <header id="kk" class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex flex-wrap justify-between items-center">
            <div class="flex items-center mb-2 sm:mb-0">
                <i class="fa fa-line-chart text-primary text-2xl mr-2"></i>
                <h1 class="text-xl font-bold text-gray-800">行情 <span class="hide-on-mobile-header">实时</span></h1>
            </div>
            <div class="flex items-center gap-2 sm:gap-4 flex-wrap">
                <div class="flex items-center text-xs">
                    <span id="websocket-status" class="websocket-status status-disconnected"></span>
                    <span id="connection-status" class="text-gray-500">未连接</span>
                </div>
                <button id="refresh-btn" class="flex items-center gap-1 px-2 py-1 bg-gray-100 rounded-lg hover:bg-gray-200 transition-all text-sm">
                    <i class="fa fa-refresh"></i>
                    <span class="hide-on-mobile-header">刷新</span>
                </button>
                <button id="theme-toggle" class="p-1 bg-gray-100 rounded-lg hover:bg-gray-200 transition-all">
                    <i class="fa fa-moon-o"></i>
                </button>
            </div>
        </div>
    </header>
    <main class="container mx-auto px-4 py-6">
        
        <section class="mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">市场概览</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white rounded-xl shadow-custom p-4 card-hover">
                    <p class="text-gray-500 text-sm">总市值</p>
                    <div class="flex items-center justify-between mt-1">
                        <h3 id="total-market-cap" class="text-2xl font-bold text-gray-800">$0</h3>
                        <span id="market-cap-change" class="text-sm price-up">
                            <i class="fa fa-arrow-up mr-1"></i>0%
                        </span>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-custom p-4 card-hover">
                    <p class="text-gray-500 text-sm">24小时交易量</p>
                    <div class="flex items-center justify-between mt-1">
                        <h3 id="total-volume" class="text-2xl font-bold text-gray-800">$0</h3>
                        <span id="volume-change" class="text-sm price-up">
                            <i class="fa fa-arrow-up mr-1"></i>0%
                        </span>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-custom p-4 card-hover">
                    <p class="text-gray-500 text-sm">比特币主导率</p>
                    <div class="flex items-center justify-between mt-1">
                        <h3 id="bitcoin-dominance" class="text-2xl font-bold text-gray-800">0%</h3>
                        <span id="dominance-change" class="text-sm price-up">
                            <i class="fa fa-arrow-up mr-1"></i>0%
                        </span>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-custom p-4 card-hover">
                    <p class="text-gray-500 text-sm">加密货币数量</p>
                    <div class="flex items-center justify-between mt-1">
                        <h3 id="total-coins" class="text-2xl font-bold text-gray-800">0</h3>
                        <span id="coins-change" class="text-sm price-up">
                            <i class="fa fa-arrow-up mr-1"></i>0
                        </span>
                    </div>
                </div>
            </div>
        </section>
      
        <section class="mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                <h2 class="text-xl font-bold text-gray-800">热门币种实时行情</h2>
                <div class="relative w-full sm:w-auto">
                    <input type="text" id="search-input" class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 w-full" placeholder="搜索币种...">
                    <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-custom overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500 w-12">排名</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">币种</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500 w-24">价格</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500 w-24">24h变</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500 hide-on-mobile-th">7d变化</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500 hide-on-mobile-th">市值</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500 hide-on-mobile-th">24h交易量</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500 hide-on-mobile-th">更新</th>
                            </tr>
                        </thead>
                        <tbody id="crypto-table-body">
                            <tr>
                                <td colspan="8" class="px-4 py-8 text-center">
                                    <div class="flex flex-col items-center">
                                        <div class="loading-spinner mb-4"></div>
                                        <p class="text-gray-500">加载中...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <section class="mb-8">
            <div class="bg-white rounded-xl shadow-custom p-4">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2"> <h2 class="text-xl font-bold text-gray-800">实时交易记录</h2>
                    <div class="flex gap-2">
                        <select id="trade-coin-select" class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/30">
                            <option value="bitcoin">比特币 (BTC)</option>
                            <option value="ethereum">以太坊 (ETH)</option>
                            <option value="binancecoin">币安币 (BNB)</option>
                            <option value="solana">Solana (SOL)</option>
                            <option value="cardano">Cardano (ADA)</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-y-auto max-h-64 scrollbar-hide">
                    <table class="w-full" id="trades-table">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">时间</th>
                                <th class="px-4 py-2 text-right text-sm font-medium text-gray-500">价格</th>
                                <th class="px-4 py-2 text-right text-sm font-medium text-gray-500">数量</th>
                                <th class="px-4 py-2 text-right text-sm font-medium text-gray-500 hide-on-mobile-th">交易额</th>
                                <th class="px-4 py-2 text-center text-sm font-medium text-gray-500">类型</th>
                            </tr>
                        </thead>
                        <tbody id="trades-table-body">
                            <tr>
                                <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                    等待交易数据...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        </main>

    <div id="notification" class="notification fixed top-4 right-4 bg-success text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2">
        <i id="notification-icon" class="fa fa-check-circle"></i>
        <span id="notification-text">操作成功</span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const refreshBtn = document.getElementById('refresh-btn');
            const themeToggle = document.getElementById('theme-toggle');
            const searchInput = document.getElementById('search-input');
            const cryptoTableBody = document.getElementById('crypto-table-body');
            const tradesTableBody = document.getElementById('trades-table-body');
            const tradeCoinSelect = document.getElementById('trade-coin-select');
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            const notificationIcon = document.getElementById('notification-icon');
            const timeFilterButtons = document.querySelectorAll('.time-filter');
            const websocketStatus = document.getElementById('websocket-status');
            const connectionStatus = document.getElementById('connection-status');

            // 市场概览元素
            const totalMarketCapElement = document.getElementById('total-market-cap');
            const marketCapChangeElement = document.getElementById('market-cap-change');
            const totalVolumeElement = document.getElementById('total-volume');
            const volumeChangeElement = document.getElementById('volume-change');
            const bitcoinDominanceElement = document.getElementById('bitcoin-dominance');
            const dominanceChangeElement = document.getElementById('dominance-change');
            const totalCoinsElement = document.getElementById('total-coins');
            const coinsChangeElement = document.getElementById('coins-change');

            // 图表相关 (略)
            let priceChart;
            let currentTimeFilter = '24h';
            let chartData = {};
            const CHART_COINS = ['bitcoin', 'ethereum', 'binancecoin', 'solana', 'cardano'];

            // 存储加密货币数据
            let cryptoData = [];
            let filteredData = [];
            let tradesData = [];
            const MAX_TRADES = 10;

            // WebSocket相关 (使用模拟实现)
            let wsSimulatedInterval;
            let isWsConnected = false;
            let lastUpdateTime = new Date();

            // API配置
            const API_BASE_URL = 'https://api.coingecko.com/api/v3';
            const API_OPTIONS = {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            };

            // --- 辅助函数 (保持不变) ---
            function formatCurrency(number) {
                if (!number) return '$0';
                return '$' + new Intl.NumberFormat('en-US', {
                    notation: 'compact',
                    compactDisplay: 'short',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 1
                }).format(number);
            }
            
            function formatNumber(number) {
                if (!number) return '0';
                return new Intl.NumberFormat('en-US', {
                    notation: 'compact',
                    compactDisplay: 'short',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 1
                }).format(number);
            }
            
            function formatChange(percentage) {
                const num = parseFloat(percentage);
                const sign = num >= 0 ? '<i class="fa fa-arrow-up mr-1"></i>' : '<i class="fa fa-arrow-down mr-1"></i>';
                return `${Math.abs(num).toFixed(2)}%`;
            }
            
            function showNotification(message, type = 'success') {
                notificationText.textContent = message;
                notification.className = `notification fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 show`;
                notificationIcon.className = type === 'success' ? 'fa fa-check-circle' : 'fa fa-times-circle';
                notification.style.backgroundColor = type === 'success' ? '#10B981' : '#EF4444';

                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
            
            function checkDarkMode() {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark');
                    themeToggle.querySelector('i').className = 'fa fa-sun-o';
                }
            }
            
            function toggleDarkMode() {
                document.body.classList.toggle('dark');
                const isDark = document.body.classList.contains('dark');
                themeToggle.querySelector('i').className = isDark ? 'fa fa-sun-o' : 'fa fa-moon-o';
            }
            
            // --- 初始化和事件 (保持不变) ---
            function init() {
                fetchMarketData();
                fetchCryptoList();
                setupEventListeners();
                checkDarkMode();
                setupSimulatedWebSocket(); 
                // initChart(); // 图表逻辑暂时注释，因为没有图表canvas
            }
            
            function setupEventListeners() {
                refreshBtn.addEventListener('click', function() {
                    refreshBtn.disabled = true;
                    refreshBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i><span class="hide-on-mobile-header">刷新中...</span>';

                    Promise.all([fetchMarketData(), fetchCryptoList()])
                        .then(() => {
                            showNotification('数据已更新');
                        })
                        .catch(error => {
                            console.error('刷新数据失败:', error);
                            showNotification('刷新数据失败', 'error');
                        })
                        .finally(() => {
                            refreshBtn.disabled = false;
                            refreshBtn.innerHTML = '<i class="fa fa-refresh"></i><span class="hide-on-mobile-header">刷新</span>';
                        });
                });

                themeToggle.addEventListener('click', toggleDarkMode);
                searchInput.addEventListener('input', filterCryptoList);
                
                // ... (时间过滤按钮和交易选择器的逻辑省略，保持原始逻辑) ...
            }
            
            // --- 市场数据获取和渲染 (保持不变) ---
            async function fetchMarketData() {
                // ... (省略，保持原始逻辑) ...
                try {
                    const response = await fetch(`${API_BASE_URL}/global`, API_OPTIONS);
                    const data = await response.json();

                    // 更新市场概览
                    totalMarketCapElement.textContent = formatCurrency(data.data.total_market_cap.usd);
                    marketCapChangeElement.innerHTML = formatChange(data.data.market_cap_change_percentage_24h_usd);
                    marketCapChangeElement.className = data.data.market_cap_change_percentage_24h_usd >= 0 ? 'text-sm price-up' : 'text-sm price-down';

                    totalVolumeElement.textContent = formatCurrency(data.data.total_volume.usd);
                    // 模拟volumeChangeElement
                    const simulatedVolumeChange = (Math.random() * 10 - 5).toFixed(2);
                    volumeChangeElement.innerHTML = formatChange(simulatedVolumeChange);
                    volumeChangeElement.className = parseFloat(simulatedVolumeChange) >= 0 ? 'text-sm price-up' : 'text-sm price-down';

                    bitcoinDominanceElement.textContent = `${data.data.market_cap_percentage.bitcoin.toFixed(2)}%`;
                    // 模拟比特币主导率变化
                    const dominanceChange = (Math.random() * 0.5 - 0.25).toFixed(2);
                    dominanceChangeElement.innerHTML = formatChange(dominanceChange);
                    dominanceChangeElement.className = parseFloat(dominanceChange) >= 0 ? 'text-sm price-up' : 'text-sm price-down';
                    
                    totalCoinsElement.textContent = formatNumber(data.data.active_cryptocurrencies);
                    coinsChangeElement.innerHTML = '+12'; // 模拟变化
                } catch (error) {
                    console.error('获取市场数据失败:', error);
                    throw error;
                }
            }
            
            async function fetchCryptoList() {
                // ... (省略，保持原始逻辑) ...
                try {
                    const response = await fetch(`${API_BASE_URL}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&sparkline=false&price_change_percentage=24h%2C7d`, API_OPTIONS);
                    cryptoData = await response.json();
                    filteredData = [...cryptoData];

                    // 更新表格
                    updateCryptoTable();
                    // initChart(); 
                } catch (error) {
                    console.error('获取加密货币列表失败:', error);
                    throw error;
                }
            }

            // --- 实时更新逻辑 (核心优化部分) ---
            function updateCryptoTable() {
                const currentUpdateTime = new Date();

                if (cryptoTableBody.innerHTML.includes('loading-spinner')) {
                    cryptoTableBody.innerHTML = '';
                }

                if (filteredData.length === 0) {
                    cryptoTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                没有找到匹配的币种
                            </td>
                        </tr>
                    `;
                    return;
                }

                // 只渲染前50个，以保持性能
                const currentRenderedIds = Array.from(cryptoTableBody.children).map(row => row.dataset.id);

                // 更新现有行或添加新行
                filteredData.slice(0, 50).forEach((crypto, index) => {
                    const existingRow = document.querySelector(`[data-id="${crypto.id}"]`);
                    const price24hChange = crypto.price_change_percentage_24h;
                    const price7dChange = crypto.price_change_percentage_7d_in_currency || 0; 
                    const price24hClass = price24hChange >= 0 ? 'price-up' : 'price-down';
                    const price7dClass = price7dChange >= 0 ? 'price-up' : 'price-down';

                    if (existingRow) {
                        // 1. 价格变化闪烁动画
                        const oldPriceText = existingRow.querySelector('td:nth-child(3)').textContent;
                        const oldPrice = parseFloat(oldPriceText.replace('$', '').replace(/,/g, ''));
                        const newPrice = crypto.current_price;
                        if (newPrice !== oldPrice) {
                            existingRow.querySelector('td:nth-child(3)').classList.add('price-flash');
                            setTimeout(() => existingRow.querySelector('td:nth-child(3)').classList.remove('price-flash'), 500);
                        }

                        // 2. 更新内容
                        existingRow.querySelector('td:nth-child(1) span').textContent = index + 1;
                        existingRow.querySelector('td:nth-child(3)').textContent = `$${crypto.current_price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 })}`;
                        
                        existingRow.querySelector('td:nth-child(4)').innerHTML = `${price24hChange >= 0 ? '<i class="fa fa-arrow-up mr-1"></i>' : '<i class="fa fa-arrow-down mr-1"></i>'}${formatChange(price24hChange)}`;
                        existingRow.querySelector('td:nth-child(4)').className = `px-4 py-3 text-right ${price24hClass}`;
                        
                        // 注意：这里的td:nth-child(5) ~ (8) 在移动端是隐藏的
                        existingRow.querySelector('td:nth-child(5)').innerHTML = `${price7dChange >= 0 ? '<i class="fa fa-arrow-up mr-1"></i>' : '<i class="fa fa-arrow-down mr-1"></i>'}${formatChange(price7dChange)}`;
                        existingRow.querySelector('td:nth-child(5)').className = `px-4 py-3 text-right ${price7dClass} hide-on-mobile`; // 保持隐藏类

                        existingRow.querySelector('td:nth-child(6)').textContent = `$${formatNumber(crypto.market_cap)}`;
                        existingRow.querySelector('td:nth-child(7)').textContent = `$${formatNumber(crypto.total_volume)}`;
                        existingRow.querySelector('td:nth-child(8) span').className = 'inline-block w-2 h-2 bg-success rounded-full blink'; // 实时更新指示灯

                        // 3. 移除旧的实时指示灯动画
                        setTimeout(() => {
                            const indicator = existingRow.querySelector('td:nth-child(8) span');
                            if (indicator) {
                                indicator.classList.remove('blink');
                                indicator.classList.remove('bg-success');
                                indicator.classList.add('bg-gray-400');
                            }
                        }, 5000);

                    } else {
                        // 添加新行
                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-all';
                        row.dataset.id = crypto.id;

                        row.innerHTML = `
                            <td class="px-4 py-3">
                                <span class="text-gray-500">${index + 1}</span>
                            </td>
                            <td class="px-4 py-3">
                                <div class="flex items-center">
                                    <img src="${crypto.image}" alt="${crypto.name}" class="w-8 h-8 mr-3 rounded-full">
                                    <div>
                                        <div class="font-medium text-gray-800">${crypto.name}</div>
                                        <div class="text-gray-500 text-sm">${crypto.symbol.toUpperCase()}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-right font-medium text-gray-800 price-flash">
                                $${crypto.current_price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 })}
                            </td>
                            <td class="px-4 py-3 text-right ${price24hClass}">
                                ${price24hChange >= 0 ? '<i class="fa fa-arrow-up mr-1"></i>' : '<i class="fa fa-arrow-down mr-1"></i>'}${formatChange(price24hChange)}
                            </td>
                            <td class="px-4 py-3 text-right ${price7dClass} hide-on-mobile">
                                ${price7dChange >= 0 ? '<i class="fa fa-arrow-up mr-1"></i>' : '<i class="fa fa-arrow-down mr-1"></i>'}${formatChange(price7dChange)}
                            </td>
                            <td class="px-4 py-3 text-right text-gray-800 hide-on-mobile">
                                $${formatNumber(crypto.market_cap)}
                            </td>
                            <td class="px-4 py-3 text-right text-gray-800 hide-on-mobile">
                                $${formatNumber(crypto.total_volume)}
                            </td>
                            <td class="px-4 py-3 text-right hide-on-mobile">
                                <span class="inline-block w-2 h-2 bg-success rounded-full blink"></span>
                            </td>
                        `;
                        cryptoTableBody.appendChild(row);

                        // 移除新行的闪烁动画
                        setTimeout(() => row.querySelector('td:nth-child(3)').classList.remove('price-flash'), 500);
                        setTimeout(() => row.querySelector('td:nth-child(8) span').classList.remove('blink', 'bg-success'), 5000);
                    }
                });
            }

            function filterCryptoList() {
                const searchTerm = searchInput.value.toLowerCase();
                filteredData = cryptoData.filter(crypto =>
                    crypto.name.toLowerCase().includes(searchTerm) ||
                    crypto.symbol.toLowerCase().includes(searchTerm)
                );
                updateCryptoTable();
            }
            
            // --- 模拟 WebSocket 交易数据 (保持原始逻辑) ---
            function setupSimulatedWebSocket() {
                // ... (省略，保持原始逻辑) ...
                isWsConnected = true;
                websocketStatus.classList.remove('status-disconnected', 'status-reconnecting');
                websocketStatus.classList.add('status-connected');
                connectionStatus.textContent = '已连接';

                const selectedCoinId = tradeCoinSelect.value;
                const coin = cryptoData.find(c => c.id === selectedCoinId);

                wsSimulatedInterval = setInterval(() => {
                    if (!coin) return;

                    const priceFactor = (Math.random() * 0.005) * (Math.random() > 0.5 ? 1 : -1); // 价格随机波动
                    const newPrice = coin.current_price * (1 + priceFactor);
                    const amount = Math.floor(Math.random() * 50 + 1);
                    const type = Math.random() > 0.5 ? 'Buy' : 'Sell';
                    const value = newPrice * amount;

                    const newTrade = {
                        time: new Date(),
                        price: newPrice,
                        amount: amount,
                        value: value,
                        type: type
                    };

                    tradesData.unshift(newTrade);
                    if (tradesData.length > MAX_TRADES) {
                        tradesData.pop();
                    }
                    updateTradesTable();
                }, 1500);
            }

            function updateTradesTable() {
                // ... (省略，保持原始逻辑) ...
                tradesTableBody.innerHTML = '';
                tradesData.forEach(trade => {
                    const priceClass = trade.type === 'Buy' ? 'text-success' : 'text-danger';
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-100 hover:bg-gray-50 transition-all';
                    row.innerHTML = `
                        <td class="px-4 py-2 text-left">${dateFns.format(trade.time, 'HH:mm:ss')}</td>
                        <td class="px-4 py-2 text-right ${priceClass}">$${trade.price.toFixed(4)}</td>
                        <td class="px-4 py-2 text-right">${trade.amount.toFixed(4)}</td>
                        <td class="px-4 py-2 text-right text-gray-800 hide-on-mobile">$${trade.value.toFixed(2)}</td>
                        <td class="px-4 py-2 text-center">
                            <span class="px-2 py-0.5 rounded-full text-xs font-medium ${trade.type === 'Buy' ? 'bg-success/10 text-success' : 'bg-danger/10 text-danger'}">
                                ${trade.type === 'Buy' ? '买入' : '卖出'}
                            </span>
                        </td>
                    `;
                    tradesTableBody.appendChild(row);
                });
            }

            init();
        });
    </script>
</body>
</html>

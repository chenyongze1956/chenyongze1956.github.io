<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT 自动聊天 - 深色数据看板</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- 统一的 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#00c6ff',
                        secondary: '#0072ff',
                        accent: '#00ff9d',
                        warning: '#ffaa00',
                        danger: '#ff4d4d',
                        dark: {
                            bg: '#',
                            card: '#162032',
                            border: '#2a3a50',
                            text: '#e2e8f0'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'typing': 'typing 1s steps(20, end), blink .7s infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        typing: {
                            'from': { width: '0' },
                            'to': { width: '100%' }
                        },
                        blink: {
                            'from, to': { borderColor: 'transparent' },
                            '50%': { borderColor: 'currentColor' }
                        }
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .message-bubble {
                @apply rounded-none px-4 py-3 max-w-[80%] md:max-w-[70%] break-words border-l-2 border-t-2;
            }
            .user-message {
                @apply bg-[#0f172a] text-white border-primary border-r-0 border-b-0 self-end;
            }
            .ai-message {
                @apply bg-[#162032] text-gray-200 border-secondary border-r-0 border-b-0 self-start;
            }
            .typing-indicator {
                @apply flex space-x-1 items-center;
            }
            .typing-dot {
                @apply w-2 h-2 rounded-none bg-primary animate-bounce;
            }
            .typing-dot:nth-child(2) {
                animation-delay: 0.2s;
            }
            .typing-dot:nth-child(3) {
                animation-delay: 0.4s;
            }
            .card-gradient {
     background: linear-gradient(45deg,#ff7e5f,#feb47b,#ffed86,#9feb8f,#5fbfff,#9b8eff);
            }
            .glow {
                box-shadow: 0 0 10px rgba(0, 198, 255, 0.5);
            }
            .glow-text {
                text-shadow: 0 0 10px rgba(0, 198, 255, 0.5);
            }
            .border-glow {
                box-shadow: 0 0 5px rgba(0, 198, 255, 0.5);
            }
            .grid-bg {
                background-size: 20px 20px;
                background-image: 
                    linear-gradient(to right, rgba(42, 58, 80, 0.1) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(42, 58, 80, 0.1) 1px, transparent 1px);
            }
        }
    </style>
</head>
<body class="bg-dark-bg text-dark-text min-h-screen flex flex-col overflow-hidden">
    <!-- 背景图层 -->
    <div class="fixed inset-0 z-0">
        <!-- 背景图片 -->
        <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('https://p9-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/3bb0f12d9f704d9a9b76cbd6e5edfb1d~tplv-a9rns2rl98-image.image?rcl=2025112907421192E7FD00DC3D25582C66&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1766965340&x-signature=0DTIfEUuhqmq1hLM0uuXTmgU8DY%3D'); opacity: 0.2;"></div>
        
        <!-- 网格背景 -->
        <div class="absolute inset-0 grid-bg"></div>
        
        <!-- 粒子背景 -->
        <canvas id="particleBackground" class="absolute inset-0"></canvas>
    </div>

    <!-- 主要内容区 -->
    <div class="relative z-10 flex flex-col md:flex-row flex-1 overflow-hidden">
        <!-- 左侧边栏 - 统计和设置 -->
        <div class="w-full md:w-80 bg-dark-card bg-opacity-70 backdrop-blur-sm border-r border-dark-border overflow-y-auto scrollbar-hide transition-all duration-300 ease-in-out">
            <!-- 标题区域 -->
            <div id="ff"  class="p-4 border-b border-dark-border">
                <h1 class="text-2xl font-bold text-white flex items-center">
                    <i class="fa fa-comments text-primary mr-2"></i>
                    <span class="glow-text">ChatGPT 数据看板</span>
                </h1>
                <p class="text-xs text-gray-400 mt-1">实时对话分析与监控</p>
            </div>
            
            <!-- 统计卡片 -->
            <div id="ff" class="p-4 space-y-4">
                <div id="tt" class="bg-[#0f172a] border-l-2 border-t-2 border-primary p-4">
                    <h3 class="text-gray-400 text-sm uppercase tracking-wider">对话统计</h3>
                    <div class="mt-3 grid grid-cols-2 gap-3">
                        <div>
                            <p class="text-xs text-gray-400">总消息数</p>
                            <p class="text-white text-xl font-bold" id="total-messages">0</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400">AI 响应率</p>
                            <p class="text-primary text-xl font-bold">100%</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400">平均响应时间</p>
                            <p class="text-white text-xl font-bold" id="avg-response-time">0s</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400">对话时长</p>
                            <p class="text-white text-xl font-bold" id="conversation-duration">0m 0s</p>
                        </div>
                    </div>
                </div>
                
                <!-- 对话趋势图表 -->
                <div id="ff" class="bg-[#0f172a] border-l-2 border-t-2 border-secondary p-4">
                    <h3 class="text-gray-400 text-sm uppercase tracking-wider mb-3">对话趋势</h3>
                    <div class="h-40">
                        <canvas id="conversationChart"></canvas>
                    </div>
                </div>
                
                <!-- API 设置卡片 -->
                <div id="" class="bg-[#0f172a] border-l-2 border-t-2 border-warning p-4">
                     <div class="flex justify-between items-center mb-3">
                        <h3 class="text-gray-400 text-sm uppercase tracking-wider">API 设置</h3>
                        <button id="api-settings-btn" class="text-warning hover:text-white transition-colors">
                            <i class="fa fa-cog"></i>
                        </button>
                    </div>
                    <div id="ff"  class="space-y-2">
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-400">API 状态</span>
                            <span id="api-status" class="text-xs px-2 py-1 bg-[#1e293b] border border-gray-700">未配置</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-400">当前模型</span>
                            <span id="current-model" class="text-xs px-2 py-1 bg-[#1e293b] border border-gray-700">模拟模式</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-400">API 调用次数</span>
                            <span id="api-calls" class="text-xs px-2 py-1 bg-[#1e293b] border border-gray-700">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 右侧聊天区域 -->
        <div class="flex-1 flex flex-col bg-dark-bg bg-opacity-50 backdrop-blur-sm">
            <!-- 聊天历史区 -->
            <div id="chat-container" class="flex-1 p-4 overflow-y-auto scrollbar-hide flex flex-col space-y-4">
                <!-- 欢迎消息 -->
                <div class="flex items-start">
                    <div class="w-8 h-8 rounded-none bg-dark-card border-l-2 border-t-2 border-secondary flex-shrink-0 flex items-center justify-center mr-2">
                        <i class="fa fa-robot text-secondary"></i>
                    </div>
                    <div class="message-bubble ai-message">
                        <p>你好！我是你的AI助手，有什么我可以帮助你的吗？</p>
                    </div>
                </div>
                <!-- 消息将动态添加到这里 -->
            </div>
            
            <!-- 输入区域 -->
            <div id="ff" class="p-4 border-t border-dark-border">
                <div class="bg-[#0f172a] border-l-2 border-t-2 border-primary p-3">
                    <div id="kk" class="flex items-center space-x-2 mb-2">
                        <button id="voice-input-btn" class="text-gray-400 hover:text-primary transition-colors">
                            <i class="fa fa-microphone"></i>
                        </button>
                        <button id="emoji-btn" class="text-gray-400 hover:text-primary transition-colors">
                            <i class="fa fa-smile-o"></i>
                        </button>
                        <button id="upload-btn" class="text-gray-400 hover:text-primary transition-colors">
                            <i class="fa fa-paperclip"></i>
                        </button>
                    </div>
                    <div id="ff"  class="flex items-center space-x-2">
                        <textarea id="message-input" class="flex-1 bg-[#162032] border border-dark-border rounded-none px-4 py-2 focus:outline-none focus:ring-1 focus:ring-primary text-white resize-none" placeholder="输入你的消息..." rows="1"></textarea>
                        <button id="send-button" class="bg-primary hover:bg-blue-600 text-white rounded-none w-10 h-10 flex items-center justify-center transition-colors border-l-2 border-t-2 border-blue-400">
                            <i class="fa fa-paper-plane"></i>
                        </button>
                    </div>
                    <div id="ff" class="text-xs text-gray-500 mt-2 flex justify-between items-center">
                        <span>按 Enter 发送消息，Shift + Enter 换行</span>
                        <div class="flex items-center">
                            <span id="char-count" class="text-gray-400">0</span>
                            <span class="text-gray-500 mx-1">/</span>
                            <span class="text-gray-500">2000</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API 设置模态框 -->
    <div id="api-settings-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden">
        <div class="bg-dark-card border-l-2 border-t-2 border-primary p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">API 设置</h2>
                <button id="close-modal" class="text-gray-500 hover:text-gray-200">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="api-key" class="block text-sm font-medium text-gray-400 mb-1">OpenAI API 密钥</label>
                    <input type="password" id="api-key" class="w-full px-4 py-2 border border-dark-border rounded-none bg-[#0f172a] text-white focus:outline-none focus:ring-1 focus:ring-primary">
                    <p class="text-xs text-gray-500 mt-1">您可以在 <a href="https://platform.openai.com/api-keys" target="_blank" class="text-primary">OpenAI 平台</a> 获取 API 密钥</p>
                </div>
                <div>
                    <label for="model-select" class="block text-sm font-medium text-gray-400 mb-1">模型选择</label>
                    <select id="model-select" class="w-full px-4 py-2 border border-dark-border rounded-none bg-[#0f172a] text-white focus:outline-none focus:ring-1 focus:ring-primary">
                        <option value="gpt-4o-mini">GPT-4o-mini (推荐)</option>
                        <option value="gpt-4o">GPT-4o</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    </select>
                </div>
                <div>
                    <label for="system-prompt" class="block text-sm font-medium text-gray-400 mb-1">系统提示词</label>
                    <textarea id="system-prompt" class="w-full px-4 py-2 border border-dark-border rounded-none bg-[#0f172a] text-white h-24 resize-none focus:outline-none focus:ring-1 focus:ring-primary" placeholder="您是一个乐于助人的AI助手。"></textarea>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="use-api" class="mr-2">
                    <label for="use-api" class="text-sm text-gray-400">使用 OpenAI API (不勾选则使用模拟回复)</label>
                </div>
                <div class="pt-2">
                    <button id="save-api-settings" class="w-full bg-primary hover:bg-blue-600 text-white py-2 px-4 rounded-none transition-colors border-l-2 border-t-2 border-blue-400">保存设置</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 错误提示模态框 -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden">
        <div class="bg-dark-card border-l-2 border-t-2 border-danger p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-danger">
                    <i class="fa fa-exclamation-circle"></i> 错误
                </h2>
                <button id="close-error-modal" class="text-gray-500 hover:text-gray-200">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div id="error-message" class="text-gray-300 mb-4"></div>
            <div class="flex justify-end">
                <button id="error-ok-button" class="bg-danger hover:bg-red-600 text-white py-2 px-4 rounded-none transition-colors border-l-2 border-t-2 border-red-400">确定</button>
            </div>
        </div>
    </div>

    <!-- 通知提示 -->
    <div id="notification" class="fixed bottom-4 right-4 bg-dark-card border-l-2 border-t-2 border-primary px-4 py-2 text-white z-50 transform translate-y-20 opacity-0 transition-all duration-300">
        <p id="notification-message"></p>
    </div>

    <script>
        // DOM 元素
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const apiSettingsBtn = document.getElementById('api-settings-btn');
        const apiSettingsModal = document.getElementById('api-settings-modal');
        const closeModalButton = document.getElementById('close-modal');
        const saveApiSettingsButton = document.getElementById('save-api-settings');
        const apiKeyInput = document.getElementById('api-key');
        const modelSelect = document.getElementById('model-select');
        const systemPromptInput = document.getElementById('system-prompt');
        const useApiCheckbox = document.getElementById('use-api');
        const errorModal = document.getElementById('error-modal');
        const closeErrorModalButton = document.getElementById('close-error-modal');
        const errorOkButton = document.getElementById('error-ok-button');
        const errorMessageElement = document.getElementById('error-message');
        const apiStatusElement = document.getElementById('api-status');
        const currentModelElement = document.getElementById('current-model');
        const apiCallsElement = document.getElementById('api-calls');
        const totalMessagesElement = document.getElementById('total-messages');
        const avgResponseTimeElement = document.getElementById('avg-response-time');
        const conversationDurationElement = document.getElementById('conversation-duration');
        const charCountElement = document.getElementById('char-count');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notification-message');
        const voiceInputBtn = document.getElementById('voice-input-btn');
        const emojiBtn = document.getElementById('emoji-btn');
        const uploadBtn = document.getElementById('upload-btn');

        // API 设置
        let apiSettings = {
            apiKey: '',
            model: 'gpt-4o-mini',
            systemPrompt: '您是一个乐于助人的AI助手。',
            useApi: false
        };

        // 聊天历史记录（用于API调用）
        let chatHistory = [];
        
        // 统计数据
        let stats = {
            totalMessages: 0,
            apiCalls: 0,
            responseTimes: [],
            conversationStartTime: new Date(),
            messageTimestamps: []
        };

        // 图表数据
        const chartData = {
            labels: [],
            userMessages: [],
            aiMessages: []
        };
        
        // 初始化图表
        let conversationChart;
        
        // 主题切换
        function initTheme() {
            // 深色数据看板风格默认使用深色模式
            document.documentElement.classList.add('dark');
        }

        // 自动调整文本区域高度
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 150) + 'px';
            
            // 更新字符计数
            charCountElement.textContent = messageInput.value.length;
        });

        // 显示错误消息
        function showError(message) {
            errorMessageElement.textContent = message;
            errorModal.classList.remove('hidden');
        }

        // 隐藏错误消息
        function hideError() {
            errorModal.classList.add('hidden');
        }

        // 显示通知
        function showNotification(message, duration = 3000) {
            notificationMessage.textContent = message;
            notification.classList.remove('translate-y-20', 'opacity-0');
            
            setTimeout(() => {
                notification.classList.add('translate-y-20', 'opacity-0');
            }, duration);
        }

        // 加载 API 设置
        function loadApiSettings() {
            const savedSettings = localStorage.getItem('openaiApiSettings');
            if (savedSettings) {
                apiSettings = JSON.parse(savedSettings);
                apiKeyInput.value = apiSettings.apiKey;
                modelSelect.value = apiSettings.model;
                systemPromptInput.value = apiSettings.systemPrompt;
                useApiCheckbox.checked = apiSettings.useApi;
                
                // 更新API状态显示
                updateApiStatus();
            }
        }

        // 保存 API 设置
        function saveApiSettings() {
            apiSettings.apiKey = apiKeyInput.value.trim();
            apiSettings.model = modelSelect.value;
            apiSettings.systemPrompt = systemPromptInput.value.trim();
            apiSettings.useApi = useApiCheckbox.checked;
            
            localStorage.setItem('openaiApiSettings', JSON.stringify(apiSettings));
            
            // 如果启用了API且设置了密钥，初始化聊天历史
            if (apiSettings.useApi && apiSettings.apiKey) {
                initChatHistory();
            }
            
            // 关闭模态框
            apiSettingsModal.classList.add('hidden');
            
            // 显示保存成功提示
            showNotification('API 设置已保存');
            
            // 更新API状态显示
            updateApiStatus();
        }

        // 更新API状态显示
        function updateApiStatus() {
            if (apiSettings.useApi && apiSettings.apiKey) {
                apiStatusElement.textContent = '已连接';
                apiStatusElement.classList.remove('bg-[#1e293b]', 'border-gray-700');
                apiStatusElement.classList.add('bg-green-900', 'border-green-700', 'text-green-400');
                
                currentModelElement.textContent = apiSettings.model;
            } else {
                apiStatusElement.textContent = '未配置';
                apiStatusElement.classList.remove('bg-green-900', 'border-green-700', 'text-green-400');
                apiStatusElement.classList.add('bg-[#1e293b]', 'border-gray-700');
                
                currentModelElement.textContent = '模拟模式';
            }
            
            apiCallsElement.textContent = stats.apiCalls;
        }

        // 初始化聊天历史
        function initChatHistory() {
            chatHistory = [
                {
                    role: 'system',
                    content: apiSettings.systemPrompt
                }
            ];
            
            // 从聊天记录中提取消息
            const messages = chatContainer.querySelectorAll('.message-bubble');
            messages.forEach((message, index) => {
                const isUserMessage = message.classList.contains('user-message');
                const text = message.textContent.trim();
                
                if (text && index > 0) { // 跳过欢迎消息
                    chatHistory.push({
                        role: isUserMessage ? 'user' : 'assistant',
                        content: text
                    });
                }
            });
        }

        // 调用 OpenAI API
        async function callOpenAIAPI(userMessage) {
            try {
                // 添加用户消息到聊天历史
                chatHistory.push({
                    role: 'user',
                    content: userMessage
                });
                
                // 记录API调用开始时间
                const startTime = Date.now();
                
                // 发送请求
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiSettings.apiKey}`
                    },
                    body: JSON.stringify({
                        model: apiSettings.model,
                        messages: chatHistory,
                        temperature: 0.7,
                        max_tokens: 1024
                    })
                });
                
                // 记录API调用结束时间
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                // 更新统计数据
                stats.apiCalls++;
                stats.responseTimes.push(responseTime);
                
                // 更新API状态显示
                updateApiStatus();
                
                // 检查响应状态
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API 请求失败: ${response.statusText}`);
                }
                
                // 处理响应
                const data = await response.json();
                const aiResponse = data.choices[0].message.content.trim();
                
                // 添加AI回复到聊天历史
                chatHistory.push({
                    role: 'assistant',
                    content: aiResponse
                });
                
                return aiResponse;
            } catch (error) {
                console.error('API 调用错误:', error);
                throw error;
            }
        }

        // 添加消息到聊天区
        function addMessageToChat(message, sender, useTypingEffect = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start';
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'w-8 h-8 rounded-none bg-dark-card border-l-2 border-t-2 flex-shrink-0 flex items-center justify-center mr-2';
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `message-bubble ${sender}-message`;
            
            if (sender === 'user') {
                messageDiv.classList.add('justify-end');
                avatarDiv.classList.add('ml-2', 'mr-0');
                avatarDiv.classList.add('border-primary');
                avatarDiv.innerHTML = '<i class="fa fa-user text-primary"></i>';
            } else {
                avatarDiv.classList.add('border-secondary');
                avatarDiv.innerHTML = '<i class="fa fa-robot text-secondary"></i>';
            }
            
            if (useTypingEffect) {
                // 使用打字机效果显示消息
                typeMessage(bubbleDiv, message);
            } else {
                bubbleDiv.innerHTML = `<p>${formatMessage(message)}</p>`;
            }
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(bubbleDiv);
            chatContainer.appendChild(messageDiv);
            
            // 更新统计数据
            stats.totalMessages++;
            stats.messageTimestamps.push(new Date());
            
            // 更新统计显示
            updateStats();
            
            // 更新图表
            updateChart();
            
            // 滚动到底部
            scrollToBottom();
        }

        // 打字机效果
        function typeMessage(element, text, i = 0, speed = 20) {
            if (i < text.length) {
                element.innerHTML = `<p>${formatMessage(text.substring(0, i + 1))}<span class="border-r border-gray-500 dark:border-gray-400 animate-blink"></span></p>`;
                setTimeout(() => typeMessage(element, text, i + 1, speed), speed);
            } else {
                element.innerHTML = `<p>${formatMessage(text)}</p>`;
                scrollToBottom();
            }
        }

        // 格式化消息（添加换行）
        function formatMessage(message) {
            return message.replace(/\n/g, '<br>');
        }

        // 显示AI正在输入指示器
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'flex items-start';
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'w-8 h-8 rounded-none bg-dark-card border-l-2 border-t-2 border-secondary flex-shrink-0 flex items-center justify-center mr-2';
            avatarDiv.innerHTML = '<i class="fa fa-robot text-secondary"></i>';
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble ai-message flex items-center p-2';
            
            const dotsDiv = document.createElement('div');
            dotsDiv.className = 'typing-indicator';
            dotsDiv.innerHTML = `
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
            `;
            
            bubbleDiv.appendChild(dotsDiv);
            typingDiv.appendChild(avatarDiv);
            typingDiv.appendChild(bubbleDiv);
            chatContainer.appendChild(typingDiv);
            
            // 滚动到底部
            scrollToBottom();
        }

        // 移除输入指示器
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // 滚动聊天区到底部
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // 模拟AI回复
        function getAIResponse(userMessage) {
            // 简单的关键词匹配回复
            const lowerMessage = userMessage.toLowerCase();
            
            if (lowerMessage.includes('你好') || lowerMessage.includes('hi') || lowerMessage.includes('hello')) {
                return '你好！很高兴见到你。有什么我可以帮助你的吗？';
            } else if (lowerMessage.includes('名字') || lowerMessage.includes('叫什么')) {
                return '我是一个AI助手，可以回答你的问题和进行对话。你可以叫我ChatGPT。';
            } else if (lowerMessage.includes('天气')) {
                return '抱歉，我目前无法获取实时天气数据。你可以通过天气应用或网站查询最新的天气信息。';
            } else if (lowerMessage.includes('时间')) {
                const now = new Date();
                return `现在是${now.getHours()}点${now.getMinutes()}分。`;
            } else if (lowerMessage.includes('帮助') || lowerMessage.includes('怎么用')) {
                return '你可以直接在这里输入文字消息，我会尽力回答你的问题。你可以问我各种问题，或者只是和我聊天。';
            } else if (lowerMessage.includes('再见') || lowerMessage.includes('拜拜')) {
                return '再见！有任何问题随时来找我，我会在这里等你。';
            } else if (lowerMessage.includes('谢谢') || lowerMessage.includes('感谢')) {
                return '不客气！能帮到你我很开心。';
            } else if (lowerMessage.includes('喜欢') || lowerMessage.includes('爱')) {
                return '作为AI，我没有情感，但我很高兴能帮助你！';
            } else if (lowerMessage.includes('你是谁') || lowerMessage.includes('什么')) {
                return '我是一个基于AI的聊天助手，可以回答你的问题，提供信息，或者只是陪你聊天。';
            } else if (lowerMessage.includes('笑话') || lowerMessage.includes('搞笑')) {
                const jokes = [
                    '为什么程序员总是分不清万圣节和圣诞节？因为 Oct 31 = Dec 25。',
                    '为什么数学书总是很忧郁？因为它有太多的问题。',
                    '程序员最讨厌的海洋生物是什么？是海豹（Seal），因为它会阻止他们编译代码。'
                ];
                return jokes[Math.floor(Math.random() * jokes.length)];
            } else if (lowerMessage.includes('故事') || lowerMessage.includes('讲个')) {
                return '从前有一只小狐狸，它喜欢探险。一天，它发现了一片神奇的森林，里面的树木都是由代码组成的。小狐狸在森林里学到了很多编程知识，最终成为了一名优秀的程序员。';
            } else {
                // 默认回复
                const responses = [
                    '我明白了，你是说' + userMessage + '。这很有趣。',
                    '谢谢你的分享。关于这个话题，我认为有很多值得探讨的地方。',
                    '我理解你的观点。从另一个角度来看，这个问题可能还有其他解决方案。',
                    '这是个很好的问题。让我思考一下... 实际上，这个问题涉及到多个方面。',
                    '我很高兴你提出这个问题。根据我的了解，这是一个很有意义的话题。'
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
        }

        // 更新统计数据
        function updateStats() {
            // 更新总消息数
            totalMessagesElement.textContent = stats.totalMessages;
            
            // 计算平均响应时间
            if (stats.responseTimes.length > 0) {
                const avgTime = Math.round(stats.responseTimes.reduce((a, b) => a + b, 0) / stats.responseTimes.length);
                avgResponseTimeElement.textContent = `${(avgTime / 1000).toFixed(1)}s`;
            }
            
            // 计算对话时长
            const now = new Date();
            const durationMs = now - stats.conversationStartTime;
            const minutes = Math.floor(durationMs / 60000);
            const seconds = Math.floor((durationMs % 60000) / 1000);
            conversationDurationElement.textContent = `${minutes}m ${seconds}s`;
        }

        // 初始化图表
        function initChart() {
            const ctx = document.getElementById('conversationChart').getContext('2d');
            
            // 设置图表数据
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const time = new Date(now - i * 5 * 60000);
                chartData.labels.push(time.getHours() + ':' + (time.getMinutes() < 10 ? '0' : '') + time.getMinutes());
                chartData.userMessages.push(0);
                chartData.aiMessages.push(0);
            }
            
            conversationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: '用户消息',
                            data: chartData.userMessages,
                            borderColor: '#00c6ff',
                            backgroundColor: 'rgba(0, 198, 255, 0.2)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 4
                        },
                        {
                            label: 'AI消息',
                            data: chartData.aiMessages,
                            borderColor: '#0072ff',
                            backgroundColor: 'rgba(0, 114, 255, 0.2)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#e2e8f0',
                                usePointStyle: true,
                                pointStyle: 'rect'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(22, 32, 50, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#e2e8f0',
                            borderColor: '#2a3a50',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw + ' 条';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(42, 58, 80, 0.3)'
                            },
                            ticks: {
                                color: '#9ca3af',
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 3
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(42, 58, 80, 0.3)'
                            },
                            ticks: {
                                color: '#9ca3af',
                                precision: 0
                            },
                            min: 0
                        }
                    }
                }
            });
        }

        // 更新图表
        function updateChart() {
            if (!conversationChart) return;
            
            const now = new Date();
            const timeLabel = now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();
            
            // 更新图表数据
            chartData.labels.push(timeLabel);
            chartData.labels.shift();
            
            // 计算过去5分钟内的消息数量
            const userMessagesCount = Array.from(chatContainer.querySelectorAll('.user-message')).length;
            const aiMessagesCount = Array.from(chatContainer.querySelectorAll('.ai-message')).length - 1; // 减去欢迎消息
            
            chartData.userMessages.push(userMessagesCount);
            chartData.userMessages.shift();
            
            chartData.aiMessages.push(aiMessagesCount);
            chartData.aiMessages.shift();
            
            // 更新图表
            conversationChart.update();
        }

        // 发送消息
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (message === '') return;

            // 添加用户消息到聊天区
            addMessageToChat(message, 'user');
            
            // 清空输入框并重置高度
            messageInput.value = '';
            messageInput.style.height = 'auto';
            charCountElement.textContent = '0';
            
            // 显示AI正在输入
            showTypingIndicator();
            
            try {
                let aiResponse;
                
                // 检查是否使用API
                if (apiSettings.useApi && apiSettings.apiKey) {
                    // 调用OpenAI API
                    aiResponse = await callOpenAIAPI(message);
                } else {
                    // 使用模拟回复
                    const startTime = Date.now();
                    await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000));
                    aiResponse = getAIResponse(message);
                    
                    // 更新统计数据
                    const endTime = Date.now();
                    const responseTime = endTime - startTime;
                    stats.responseTimes.push(responseTime);
                }
                
                // 移除输入指示器
                removeTypingIndicator();
                
                // 添加AI回复
                addMessageToChat(aiResponse, 'ai', true);
            } catch (error) {
                // 移除输入指示器
                removeTypingIndicator();
                
                // 显示错误消息
                showError(`获取AI回复失败: ${error.message}`);
                
                // 添加错误提示到聊天区
                addMessageToChat('抱歉，获取回复时发生错误。请检查您的API设置或稍后再试。', 'ai');
            }
        }

        // 粒子背景
        function initParticleBackground() {
            const canvas = document.getElementById('particleBackground');
            const ctx = canvas.getContext('2d');
            
            // 设置画布尺寸
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // 粒子设置
            const particlesArray = [];
            const numberOfParticles = 100;
            
            // 创建粒子
            class Particle {
                constructor() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.size = Math.random() * 2 + 1;
                    this.speedX = Math.random() * 0.5 - 0.25;
                    this.speedY = Math.random() * 0.5 - 0.25;
                    this.color = 'rgba(0, 198, 255, 0.5)';
                }
                
                update() {
                    this.x += this.speedX;
                    this.y += this.speedY;
                    
                    // 边界检查
                    if (this.x > canvas.width) this.x = 0;
                    if (this.x < 0) this.x = canvas.width;
                    if (this.y > canvas.height) this.y = 0;
                    if (this.y < 0) this.y = canvas.height;
                }
                
                draw() {
                    ctx.fillStyle = this.color;
                    ctx.fillRect(this.x, this.y, this.size, this.size);
                }
            }
            
            // 初始化粒子
            function init() {
                for (let i = 0; i < numberOfParticles; i++) {
                    particlesArray.push(new Particle());
                }
            }
            
            // 鼠标位置追踪
            let mouseX = 0;
            let mouseY = 0;
            
            document.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
            });
            
            // 连接粒子
            function connectParticles() {
                for (let a = 0; a < particlesArray.length; a++) {
                    for (let b = a; b < particlesArray.length; b++) {
                        const dx = particlesArray[a].x - particlesArray[b].x;
                        const dy = particlesArray[a].y - particlesArray[b].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 100) {
                            ctx.beginPath();
                            ctx.strokeStyle = `rgba(0, 198, 255, ${0.1 * (1 - distance/100)})`;
                            ctx.lineWidth = 0.5;
                            ctx.moveTo(particlesArray[a].x, particlesArray[a].y);
                            ctx.lineTo(particlesArray[b].x, particlesArray[b].y);
                            ctx.stroke();
                        }
                    }
                }
            }
            
            // 动画循环
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                for (let i = 0; i < particlesArray.length; i++) {
                    particlesArray[i].update();
                    particlesArray[i].draw();
                }
                
                connectParticles();
                requestAnimationFrame(animate);
            }
            
            init();
            animate();
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            loadApiSettings();
            initParticleBackground();
            initChart();
            messageInput.focus();
            
            // 启动统计更新定时器
            setInterval(updateStats, 1000);
        });

        // 事件监听
        sendButton.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                await sendMessage();
            }
        });
        
        // API 设置模态框事件
        apiSettingsBtn.addEventListener('click', () => {
            apiSettingsModal.classList.remove('hidden');
        });
        
        closeModalButton.addEventListener('click', () => {
            apiSettingsModal.classList.add('hidden');
        });
        
        saveApiSettingsButton.addEventListener('click', saveApiSettings);
        
        // 错误模态框事件
        closeErrorModalButton.addEventListener('click', hideError);
        errorOkButton.addEventListener('click', hideError);
        
        // 按下ESC键关闭模态框
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                apiSettingsModal.classList.add('hidden');
                errorModal.classList.add('hidden');
            }
        });
        
        // 语音输入按钮
        voiceInputBtn.addEventListener('click', () => {
            showNotification('语音输入功能即将上线');
        });
        
        // 表情按钮
        emojiBtn.addEventListener('click', () => {
            showNotification('表情选择功能即将上线');
        });
        
        // 上传按钮
        uploadBtn.addEventListener('click', () => {
            showNotification('文件上传功能即将上线');
        });
    </script>
</body>
</html>


<style>

    #ff{


             background: linear-gradient(45deg,#ff7e5f,#feb47b,#ffed86,#9feb8f,#5fbfff,#9b8eff);

    }

body{

     background: linear-gradient(45deg,#ff7e5f,#feb47b,#ffed86,#9feb8f,#5fbfff,#9b8eff);

    
}

    #kk{

     background: linear-gradient(45deg,#ff7e5f,#feb47b,#ffed86,#9feb8f,#5fbfff,#9b8eff);

        
    }

    #tt{


             background: linear-gradient(45deg,#ff7e5f,#feb47b,#ffed86,#9feb8f,#5fbfff,#9b8eff);

    }


    #message-input｛
                 background: linear-gradient(45deg,#ff7e5f,#feb47b,#ffed86,#9feb8f,#5fbfff,#9b8eff);
            
    ｝
    </style>

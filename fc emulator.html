
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Web FC æ¨¡æ‹Ÿå™¨ - å…¬ç½‘ç›´æ’­ç‰ˆ</title>
    <script src="peerjs.js"></script> 
    <style>
        body {      background: linear-gradient(45deg,#ff7e5f,#feb47b,#ffed86,#9feb8f,#5fbfff,#9b8eff);
; color: #000; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; background: #444; }
        .btn:disabled { opacity: 0.3; }
        .btn-load { background: #e53935; }
        .btn-cast { background: #E91E63; }
        .screen-container { position: relative; border: 4px solid #333; background: #000; line-height: 0; }
        canvas { width: 512px; height: 480px; image-rendering: pixelated; }
        #interaction-layer { position: absolute; inset: 0; pointer-events: none; overflow: hidden; z-index: 5; }
        .floating-emoji { position: absolute; font-size: 40px; bottom: -50px; animation: floatUp 3s forwards; }
        .danmaku { position: absolute; white-space: nowrap; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 4px #000; animation: moveLeft 7s linear forwards; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 0; } 20% { opacity: 1; } 100% { transform: translateY(-400px) translateX(var(--rx)); opacity: 0; } }
        @keyframes moveLeft { from { left: 100%; } to { left: -100%; } }
        .cast-panel { margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center; }
        input { padding: 8px; border-radius: 4px; border: none; width: 180px; margin: 5px; }
    </style>
</head>
<body>
    <div class="toolbar">
        <input type="file" id="rom-upload" accept=".nes" style="display:none">
        <button class="btn btn-load" onclick="document.getElementById('rom-upload').click()">ğŸ“‚ åŠ è½½æ¸¸æˆ</button>
        <button id="btnScreenshot" class="btn" disabled>ğŸ“· æˆªå›¾</button>
        <button id="btnMute" class="btn" disabled>ğŸ”Š é™éŸ³</button>
    </div>

    <div class="screen-container">
        <canvas id="screen" width="256" height="240"></canvas>
        <div id="interaction-layer"></div>
    </div>

    <div class="cast-panel">
        <div>ğŸ“¡ ç›®æ ‡è§‚ä¼— ID: <input type="text" id="targetId" placeholder="ç²˜è´´è§‚ä¼—ç«¯çš„ID"></div>
        <button id="btnConnect" class="btn btn-cast" disabled>å¼€å§‹è¿æ¥å¹¶ç›´æ’­</button>
        <div id="status" style="font-size: 12px; margin-top: 10px; color: #FFC107;">è¯·å…ˆåŠ è½½æ¸¸æˆ ROM</div>
    </div>

    <script src="jsnes.min.js"></script>
    <script>
        const canvas = document.getElementById('screen');
        const ctx = canvas.getContext('2d');
        const imageData = ctx.createImageData(256, 240);
        const buf32 = new Uint32Array(imageData.data.buffer);
        let nes, audioHandler, isFileLoaded = false, peer = null, dataConn = null;

        // å…¬ç”¨ PeerJS é…ç½® (é€‚é… HTTPS)
        const peerConfig = {
            host: '0.peerjs.com',
            port: 443,
            path: '/',
            secure: true,
            debug: 1,
            pingInterval: 5000,
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun.anyfirewall.com:3478' }
                ]
            }
        };

        nes = new jsnes.NES({
            onFrame: (frameBuffer) => {
                for (let i = 0; i < 61440; i++) buf32[i] = 0xFF000000 | frameBuffer[i];
                ctx.putImageData(imageData, 0, 0);
            },
            onAudioSample: (v) => { if (audioHandler) audioHandler.writeSample(v); }
        });

        document.getElementById('btnConnect').onclick = () => {
            const targetId = document.getElementById('targetId').value.trim();
            if (!targetId) return alert("è¯·è¾“å…¥è§‚ä¼—æ˜¾ç¤ºçš„ VIEWER_XXXX ID");
            
            document.getElementById('status').innerText = "æ­£åœ¨æ¡æ‰‹å®˜æ–¹æœåŠ¡å™¨...";
            
            if (!peer) {
                peer = new Peer('HOST_' + Math.floor(Math.random()*1000), peerConfig);
            }

            peer.on('open', (id) => {
                document.getElementById('status').innerText = "å·²è¿ä¸Šå…¬ç½‘ï¼Œæ­£åœ¨å‘¼å«è§‚ä¼—...";
                const stream = canvas.captureStream(60);
                if (audioHandler) stream.addTrack(audioHandler.getAudioStream().getAudioTracks()[0]);
                
                peer.call(targetId, stream);
                dataConn = peer.connect(targetId);
                
                dataConn.on('open', () => {
                    document.getElementById('status').innerText = "âœ… ç›´æ’­å·²åŒæ­¥ï¼å¿«è®©è§‚ä¼—ç‚¹è¡¨æƒ…";
                    document.getElementById('btnConnect').innerText = "ç›´æ’­è¿›è¡Œä¸­";
                });

                dataConn.on('data', data => {
                    if (data.type === 'emoji') spawnEmoji(data.value);
                    if (data.type === 'chat') spawnDanmaku(data.value);
                });
            });

            peer.on('error', err => {
                document.getElementById('status').innerText = "è¿æ¥å¤±è´¥: " + err.type;
                console.error(err);
            });
        };

        // æ¨¡æ‹Ÿå™¨åŸºç¡€åŠŸèƒ½çœç•¥ (ä¿æŒä¹‹å‰çš„é€»è¾‘)
        function spawnEmoji(emoji) {
            const el = document.createElement('div'); el.className = 'floating-emoji'; el.innerText = emoji;
            el.style.left = Math.random() * 80 + 10 + '%'; el.style.setProperty('--rx', (Math.random() * 200 - 100) + 'px');
            document.getElementById('interaction-layer').appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }
        function spawnDanmaku(text) {
            const el = document.createElement('div'); el.className = 'danmaku'; el.innerText = text;
            el.style.top = Math.random() * 60 + 10 + '%';
            document.getElementById('interaction-layer').appendChild(el);
            setTimeout(() => el.remove(), 7000);
        }
        document.getElementById('rom-upload').onchange = (e) => {
            const reader = new FileReader();
            reader.readAsArrayBuffer(e.target.files[0]);
            reader.onload = (ev) => {
                const bytes = new Uint8Array(ev.target.result);
                let bin = ""; for(let i=0; i<bytes.length; i++) bin += String.fromCharCode(bytes[i]);
                nes.loadROM(bin);
                isFileLoaded = true;
                document.querySelectorAll('.btn').forEach(b => b.disabled = false);
                document.getElementById('status').innerText = "æ¸¸æˆå·²è½½å…¥ï¼Œå‡†å¤‡å¼€å§‹ç›´æ’­";
            };
        };
        const KEYMAP = { 38: 4, 40: 5, 37: 6, 39: 7, 88: 0, 90: 1, 13: 3, 17: 2 };
        document.addEventListener('keydown', e => { if(isFileLoaded && KEYMAP[e.keyCode]!==undefined) nes.buttonDown(1, KEYMAP[e.keyCode]); });
        document.addEventListener('keyup', e => { if(isFileLoaded && KEYMAP[e.keyCode]!==undefined) nes.buttonUp(1, KEYMAP[e.keyCode]); });
        function loop() { if (isFileLoaded) nes.frame(); requestAnimationFrame(loop); }
        loop();
    </script>
</body>
</html>

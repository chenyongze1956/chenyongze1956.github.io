
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Web FC æ¨¡æ‹Ÿå™¨ (ç´§å‡‘æŒ‰é’®ç‰ˆ)</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ä¿æŒä¸å˜ --- */
        body {
                 background: linear-gradient(45deg,#ff7e5f,#feb47b,#ffed86,#9feb8f,#5fbfff,#9b8eff);
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px 0;
            user-select: none;
            box-sizing: border-box;
        }
        h1 { margin: 10px 0; font-weight: 300; letter-spacing: 2px;}
        .screen-container {
            position: relative;
            border: 4px solid #444;
            box-shadow: 0 0 30px rgba(0,0,0,0.6);
            background: #000;
        }
        canvas {
            display: block;
            image-rendering: pixelated;
            width: 512px; 
            height: 480px;
        }
        .overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.8);
            color: #fff;
            font-size: 1.2em;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .overlay.visible { opacity: 1; }
                
        /* --- æŒ‰é’®åŒºåŸŸæ ·å¼ä¼˜åŒ– --- */
        .toolbar {
            display: flex;
            gap: 8px; /* ç•¥å¾®å‡å°é—´è· */
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* ç»Ÿä¸€æŒ‰é’®å°ºå¯¸çš„æ ¸å¿ƒä¿®æ”¹ï¼šæ›´ç´§å‡‘ */
        .btn {
            width: 90px;  /* ç»Ÿä¸€å®½åº¦è°ƒæ•´ä¸º 90px */
            height: 35px; /* ç»Ÿä¸€é«˜åº¦è°ƒæ•´ä¸º 35px */
            padding: 0; 
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em; /* å­—ä½“ç•¥å¾®è°ƒå° */
            transition: background 0.2s, opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #555 !important;
        }
        /* æŒ‰é’®é¢œè‰² */
        .btn-load { background: #e53935; }
        .btn-load:hover:not(:disabled) { background: #d32f2f; }
        .btn-screenshot { background: #795548; } 
        .btn-screenshot:hover:not(:disabled) { background: #6D4C41; }
        .btn-share { background: #00BCD4; }
        .btn-share:hover:not(:disabled) { background: #00ACC1; }
        .btn-record-start { background: #4CAF50; }
        .btn-record-start:hover:not(:disabled) { background: #45a049; }
        .btn-record-stop { 
            width: 90px; /* ç¡®ä¿åœæ­¢æŒ‰é’®ä¹Ÿç»Ÿä¸€å°ºå¯¸ */
            height: 35px; 
            background: #f44336; 
            display: none; 
        }
        .btn-record-stop:hover:not(:disabled) { background: #d32f2f; }
        
        /* é™éŸ³æŒ‰é’®æ ·å¼ */
        .btn-mute { background: #5D4037; }
        .btn-mute:hover:not(:disabled) { background: #4E342E; }

        .recording-indicator {
            display: none;
            align-items: center;
            color: #f44336;
            font-weight: bold;
            margin-left: 10px;
        }
        .recording-indicator::before {
            content: '';
            display: inline-block;
            width: 10px; height: 10px;
            background: #f44336;
            border-radius: 50%;
            margin-right: 5px;
            animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }
        .controls {
            margin-top: 20px;
            padding: 15px;
            background: #2a2a2a;
            border-radius: 8px;
            text-align: center;
            color: #ccc;
            font-size: 0.9em;
        }
        input[type="file"] { display: none; }
        .key-badge {
            display: inline-block;
            background: #444;
            padding: 2px 6px;
            border-radius: 4px;
            margin: 0 2px;
            font-family: monospace;
            font-weight: bold;
            color: #fff;
        }
    </style>
</head>
<body>
    
    <div class="toolbar">
        <input type="file" id="rom-upload" accept=".nes">
        <button class="btn btn-load" onclick="document.getElementById('rom-upload').click()">ğŸ“‚ åŠ è½½æ¸¸æˆ</button>
        
        <button id="btnScreenshot" class="btn btn-screenshot" disabled>ğŸ“· æˆªå›¾</button>
        <button id="btnMute" class="btn btn-mute" disabled>ğŸ”Š é™éŸ³</button>
        <button id="btnShare" class="btn btn-share" disabled>ğŸ”— åˆ†äº«</button>

        <div style="width: 2px; height: 30px; background: #444; margin: 0 10px;"></div>
        
        <button id="btnStartRec" class="btn btn-record-start" disabled>ğŸ”´ å½•åƒ</button> <button id="btnStopRec" class="btn btn-record-stop">â¬œ åœæ­¢</button>
        <div id="recIndicator" class="recording-indicator">REC</div>
    </div>
    
    <div class="screen-container">
        <canvas id="screen" width="256" height="240"></canvas>
        <div id="msg-overlay" class="overlay visible">è¯·åŠ è½½ ROM å¼€å§‹æ¸¸æˆ</div>
    </div>
    
    
    
    <script src="https://unpkg.com/jsnes/dist/jsnes.min.js"></script>
    
    <script>
        const SCREEN_WIDTH = 256;
        const SCREEN_HEIGHT = 240;
        const canvas = document.getElementById('screen');
        const ctx = canvas.getContext('2d');
        const imageData = ctx.createImageData(SCREEN_WIDTH, SCREEN_HEIGHT);
        const buf32 = new Uint32Array(imageData.data.buffer);
        const overlay = document.getElementById('msg-overlay');

        // --- DOM å…ƒç´ å¼•ç”¨ ---
        const btnScreenshot = document.getElementById('btnScreenshot');
        const btnShare = document.getElementById('btnShare');
        const btnStartRec = document.getElementById('btnStartRec');
        const btnStopRec = document.getElementById('btnStopRec');
        const recIndicator = document.getElementById('recIndicator');
        const btnMute = document.getElementById('btnMute'); 

        let audioHandler = null;
        let isFileLoaded = false;
        let lastScreenshotBlob = null; 
        
        // --- éŸ³é¢‘å¤„ç†ç±» ---        
        class AudioHandler {
            constructor() {
                this.actx = new (window.AudioContext || window.webkitAudioContext)();
                this.bufferSize = 4096;
                // âš ï¸ [Deprecation] æ­¤å¤„ä½¿ç”¨ ScriptProcessorNodeï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å»ºè®®æ›¿æ¢ä¸º AudioWorkletNode
                this.scriptNode = this.actx.createScriptProcessor(this.bufferSize, 0, 1);
                this.recordingDest = this.actx.createMediaStreamDestination();
                this.ringBuffer = new Float32Array(this.bufferSize * 3); 
                this.writeIndex = 0;
                this.readIndex = 0;
                                
                this.scriptNode.onaudioprocess = (e) => this.process(e);
                this.scriptNode.connect(this.actx.destination);
                this.scriptNode.connect(this.recordingDest);
            }

            // æ¢å¤æ’­æ”¾
            resume() {
                if (this.actx.state === 'suspended' || this.actx.state === 'closed') {
                    this.actx.resume();
                }
            }

            // æš‚åœæ’­æ”¾ (é™éŸ³åŠŸèƒ½çš„æ ¸å¿ƒ)
            pause() {
                if (this.actx.state === 'running') {
                    this.actx.suspend();
                }
            }

            getAudioStream() { return this.recordingDest.stream; }

            writeSample(value) {
                this.ringBuffer[this.writeIndex] = value;
                this.writeIndex++;
                if (this.writeIndex >= this.ringBuffer.length) this.writeIndex = 0;
            }

            process(e) {
                const output = e.outputBuffer.getChannelData(0);
                for (let i = 0; i < this.bufferSize; i++) {
                    if (this.readIndex === this.writeIndex) {
                        output[i] = 0; 
                    } else {
                        output[i] = this.ringBuffer[this.readIndex];
                        this.readIndex++;
                        if (this.readIndex >= this.ringBuffer.length) this.readIndex = 0;
                    }
                }
            }
        }

        // --- NES åˆå§‹åŒ– ---        
        var nes = new jsnes.NES({
            onFrame: function(frameBuffer) {
                let i = 0;
                for (let y = 0; y < SCREEN_HEIGHT; ++y) {
                    for (let x = 0; x < SCREEN_WIDTH; ++x) {
                        i = y * SCREEN_WIDTH + x;
                        buf32[i] = 0xFF000000 | frameBuffer[i]; 
                    }
                }
                ctx.putImageData(imageData, 0, 0);
            },
            onAudioSample: function(left, right) {
                if (audioHandler) {
                    audioHandler.writeSample(left); 
                }
            }
        });

        // --- æ¸¸æˆä¸»å¾ªç¯ ---        
        function onAnimationFrame() {
            window.requestAnimationFrame(onAnimationFrame);
            if (isFileLoaded) {
                nes.frame();
            }
        }
        window.requestAnimationFrame(onAnimationFrame);

        // --- ROM åŠ è½½ ---        
        document.getElementById('rom-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (!audioHandler) {
                audioHandler = new AudioHandler();
            }
            audioHandler.resume(); 

            const reader = new FileReader();
            reader.readAsBinaryString(file);
                        
            reader.onload = function(e) {
                try {
                    nes.loadROM(e.target.result);
                    isFileLoaded = true;
                    overlay.classList.remove('visible');
                                        
                    // æ¸¸æˆåŠ è½½æˆåŠŸåï¼Œå¯ç”¨æ‰€æœ‰åŠŸèƒ½æŒ‰é’®
                    btnStartRec.disabled = false;
                    btnScreenshot.disabled = false;
                    btnShare.disabled = true;
                    btnMute.disabled = false; 
                    
                    console.log("ROM Loaded OK");
                } catch(err) {
                    alert("åŠ è½½å¤±è´¥: " + err);
                }
            };
        });
        
        // --- é™éŸ³åŠŸèƒ½å®ç° ---
        btnMute.addEventListener('click', function() {
            if (!audioHandler) return;

            if (audioHandler.actx.state === 'running') {
                audioHandler.pause();
                btnMute.innerHTML = 'ğŸ”‡ å–æ¶ˆé™éŸ³';
                console.log("Audio Paused (Muted)");
            } else if (audioHandler.actx.state === 'suspended') {
                audioHandler.resume();
                btnMute.innerHTML = 'ğŸ”Š é™éŸ³';
                console.log("Audio Resumed (Unmuted)");
            }
        });


        // ============================        
        // --- æˆªå›¾ä¸åˆ†äº«åŠŸèƒ½å®ç° ---        
        // ============================
        function dataURLtoBlob(dataurl) {
            const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], {type:mime});
        }

        function takeScreenshot() {
            if (!isFileLoaded) return;
            const dataURL = canvas.toDataURL('image/png');
            const imageBlob = dataURLtoBlob(dataURL);
            lastScreenshotBlob = imageBlob;
            btnShare.disabled = false;
            const a = document.createElement('a');
            a.href = dataURL;
            const timestamp = new Date().toISOString().slice(0,19).replace(/[-T:]/g, '');
            a.download = `NES_Screenshot_${timestamp}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            alert("æˆªå›¾å·²ä¸‹è½½ï¼ç°åœ¨å¯ä»¥ç‚¹å‡»åˆ†äº«æŒ‰é’®ã€‚");
        }
                
        async function shareScreenshot() {
            if (!lastScreenshotBlob) {
                alert("è¯·å…ˆç‚¹å‡» 'æˆªå›¾' æŒ‰é’®ï¼");
                return;
            }
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([lastScreenshotBlob], 'screenshot.png', {type: 'image/png'})] })) {
                try {
                    await navigator.share({
                        files: [new File([lastScreenshotBlob], 'screenshot.png', {type: 'image/png'})],
                        title: 'æˆ‘çš„ FC æ¸¸æˆæˆªå›¾',
                        text: 'å¿«æ¥çœ‹æˆ‘çš„æ¸¸æˆè¿›åº¦ï¼ #NES #FCæ¨¡æ‹Ÿå™¨',
                    });
                    console.log('æˆªå›¾åˆ†äº«æˆåŠŸ');
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error('åˆ†äº«å¤±è´¥:', error);
                        alert('åˆ†äº«å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æ‰‹åŠ¨ä¸‹è½½æˆªå›¾ã€‚');
                    }
                }
            } else {
                alert("æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒé«˜çº§åˆ†äº«åŠŸèƒ½ã€‚æˆªå›¾å·²ä¸‹è½½ï¼Œè¯·æ‰‹åŠ¨åˆ†äº«ã€‚");
            }
        }

        btnScreenshot.addEventListener('click', takeScreenshot);
        btnShare.addEventListener('click', shareScreenshot);

        // ============================        
        // --- å½•åƒåŠŸèƒ½å®ç° ---        
        // ============================        
        let mediaRecorder;        
        let recordedChunks = [];        
        let isRecording = false;

        btnStartRec.addEventListener('click', startRecording);        
        btnStopRec.addEventListener('click', stopRecording);

        function getMimeTypeOptions() {
            const mp4Mime = 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"';
            const webmMime = 'video/webm; codecs=vp9,opus';
            if (MediaRecorder.isTypeSupported(mp4Mime)) { return { mimeType: mp4Mime }; } 
            if (MediaRecorder.isTypeSupported(webmMime)) { return { mimeType: webmMime }; } 
            return {};
        }

        function startRecording() {
            if (!isFileLoaded || !audioHandler || isRecording) return;
            // å½•åƒæ—¶å¼ºåˆ¶å–æ¶ˆé™éŸ³ï¼Œå¦åˆ™è§†é¢‘æ²¡æœ‰å£°éŸ³
            if (audioHandler.actx.state === 'suspended') {
                 audioHandler.resume();
                 btnMute.innerHTML = 'ğŸ”Š é™éŸ³'; // æ¢å¤å›¾æ ‡
            }

            const canvasStream = canvas.captureStream(60);
            const audioStream = audioHandler.getAudioStream();
            const combinedStream = new MediaStream([
                ...canvasStream.getVideoTracks(),
                ...audioStream.getAudioTracks()
            ]);

            const options = getMimeTypeOptions();
            if (!options.mimeType) { alert("å½•åƒåŠŸèƒ½ä¸å¯ç”¨ï¼Œæµè§ˆå™¨ä¸æ”¯æŒæ‰€éœ€çš„è§†é¢‘ç¼–ç ã€‚"); return; }

            try { mediaRecorder = new MediaRecorder(combinedStream, options); } 
            catch (e) { console.error("åˆå§‹åŒ– MediaRecorder å¤±è´¥:", e); alert("åˆå§‹åŒ–å½•åƒå¤±è´¥ã€‚"); return; }

            recordedChunks = [];
            mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = downloadRecording;

            mediaRecorder.start();
            isRecording = true;
            updateRecordUI(true);
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                updateRecordUI(false);
            }
        }

        function downloadRecording() {
            const blob = new Blob(recordedChunks, { type: mediaRecorder.mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
                        
            const actualMimeType = mediaRecorder.mimeType.toLowerCase();
            const fileExt = actualMimeType.includes('mp4') ? 'mp4' : 'webm';
                        
            const timestamp = new Date().toISOString().slice(0,19).replace(/[-T:]/g, '');
            a.download = `FC_Gameplay_${timestamp}.${fileExt}`;

            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                alert(`å½•åƒå·²å®Œæˆå¹¶å¼€å§‹ä¸‹è½½ï¼æ ¼å¼: .${fileExt}`);
            }, 100);
        }

        function updateRecordUI(recording) {
            if (recording) {
                btnStartRec.style.display = 'none';
                btnStopRec.style.display = 'flex';
                recIndicator.style.display = 'flex';
                document.querySelector('.btn-load').disabled = true;
                btnScreenshot.disabled = true;
                btnShare.disabled = true;
                btnMute.disabled = true; // å½•åƒæ—¶ç¦ç”¨é™éŸ³
            } else {
                btnStartRec.style.display = 'flex';
                btnStopRec.style.display = 'none';
                recIndicator.style.display = 'none';
                document.querySelector('.btn-load').disabled = false;
                btnScreenshot.disabled = false;
                btnShare.disabled = (lastScreenshotBlob === null);
                btnMute.disabled = false; // æ¢å¤é™éŸ³æŒ‰é’®
             }
        }

        // --- é”®ç›˜äº‹ä»¶ ---        
        const KEYMAP = { 
            88: jsnes.Controller.BUTTON_A,                  // X é”®
            90: jsnes.Controller.BUTTON_B,                  // Z é”®
            17: jsnes.Controller.BUTTON_SELECT,             // Ctrl é”®
            13: jsnes.Controller.BUTTON_START,              // Enter é”®
            38: jsnes.Controller.BUTTON_UP,
            40: jsnes.Controller.BUTTON_DOWN,
            37: jsnes.Controller.BUTTON_LEFT,
            39: jsnes.Controller.BUTTON_RIGHT
        };

        function handleKey(e, type) {
            if (KEYMAP[e.keyCode] !== undefined) {
                nes[type === 'down' ? 'buttonDown' : 'buttonUp'](1, KEYMAP[e.keyCode]);
                e.preventDefault();
            }
        }
        document.addEventListener('keydown', (e) => handleKey(e, 'down'));
        document.addEventListener('keyup', (e) => handleKey(e, 'up'));
    </script>
</body>
</html>

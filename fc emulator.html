
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.bootcdn.net/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script> 
    <style>
        body {      background: linear-gradient(45deg,#ff7e5f,#feb47b,#ffed86,#9feb8f,#5fbfff,#9b8eff);
 color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; padding: 20px 0; user-select: none; }
        .screen-container { position: relative; border: 4px solid #444; box-shadow: 0 0 30px rgba(0,0,0,0.8); background: #000; }
        canvas { display: block; image-rendering: pixelated; width: 512px; height: 480px; }
        .overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); color: #fff; font-size: 1.5em; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 10; }
        .overlay.visible { opacity: 1; }
        
        /* äº’åŠ¨å±‚ */
        #interaction-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 5; }
        .floating-emoji { position: absolute; font-size: 40px; bottom: -50px; animation: floatUp 3s ease-out forwards; }
        .danmaku { position: absolute; white-space: nowrap; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 4px #000; animation: moveLeft 7s linear forwards; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 0; } 20% { opacity: 1; } 100% { transform: translateY(-400px) translateX(var(--rx)); opacity: 0; } }
        @keyframes moveLeft { from { left: 100%; } to { left: -100%; } }

        .toolbar { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center; }
        .btn { padding: 8px 15px; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em; transition: 0.2s; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-load { background: #e53935; }
        .btn-screenshot { background: #795548; }
        .btn-share { background: #00BCD4; }
        .btn-record-start { background: #4CAF50; }
        .btn-record-stop { background: #f44336; display: none; }
        .btn-mute { background: #5D4037; }
        .btn-cast { background: #E91E63; }
        
        .recording-indicator { display: none; align-items: center; color: #f44336; font-weight: bold; margin-left: 10px; }
        .recording-indicator::before { content: ''; display: inline-block; width: 10px; height: 10px; background: #f44336; border-radius: 50%; margin-right: 5px; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        
        .controls-info { margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; font-size: 0.9em; text-align: center; width: 512px; }
        .key-badge { background: #444; padding: 2px 5px; border-radius: 3px; margin: 0 2px; }
    </style>
</head>
<body>
    <div class="toolbar">
        <input type="file" id="rom-upload" accept=".nes" style="display:none">
        <button class="btn btn-load" onclick="document.getElementById('rom-upload').click()">ğŸ“‚ åŠ è½½æ¸¸æˆ</button>
        <button id="btnScreenshot" class="btn btn-screenshot" disabled>ğŸ“· æˆªå›¾</button>
        <button id="btnMute" class="btn btn-mute" disabled>ğŸ”Š é™éŸ³</button>
        <button id="btnShare" class="btn btn-share" disabled>ğŸ”— åˆ†äº«</button>
        <button id="btnStartRec" class="btn btn-record-start" disabled>ğŸ”´ å½•åƒ</button>
        <button id="btnStopRec" class="btn btn-record-stop">â¬œ åœæ­¢</button>
        <div id="recIndicator" class="recording-indicator">REC</div>
    </div>

    <div class="screen-container">
        <canvas id="screen" width="256" height="240"></canvas>
        <div id="interaction-layer"></div>
        <div id="msg-overlay" class="overlay visible">è¯·é€‰æ‹© .nes æ¸¸æˆæ–‡ä»¶</div>
    </div>

    <div class="controls-info">
        <div style="margin-bottom: 10px;">
            ğŸ“º ç›´æ’­ç›®æ ‡ ID: <input type="text" id="targetPeerId" placeholder="ç²˜è´´è§‚ä¼—ç«¯æ˜¾ç¤ºçš„ID" style="padding: 5px; border-radius: 4px; border:none;">
            <button id="btnConnectCast" class="btn btn-cast" disabled>å¼€å§‹ç›´æ’­</button>
        </div>
        <div>æ–¹å‘é”®æ§åˆ¶ç§»åŠ¨ | Aé”®: <span class="key-badge">X</span> | Bé”®: <span class="key-badge">Z</span> | Start: <span class="key-badge">Enter</span> | Select: <span class="key-badge">Ctrl</span></div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/jsnes/1.2.1/jsnes.min.js"></script>
    <script>
        const canvas = document.getElementById('screen');
        const ctx = canvas.getContext('2d');
        const imageData = ctx.createImageData(256, 240);
        const buf32 = new Uint32Array(imageData.data.buffer);
        const overlay = document.getElementById('msg-overlay');

        let nes, audioHandler = null, isFileLoaded = false, lastScreenshotBlob = null;
        let mediaRecorder = null, recordedChunks = [];
        let peer = null, dataConn = null;

        // åˆå§‹åŒ– NES
        nes = new jsnes.NES({
            onFrame: (frameBuffer) => {
                for (let i = 0; i < 61440; i++) buf32[i] = 0xFF000000 | frameBuffer[i];
                ctx.putImageData(imageData, 0, 0);
            },
            onAudioSample: (left) => { if (audioHandler) audioHandler.writeSample(left); }
        });

        class AudioHandler {
            constructor() {
                this.actx = new (window.AudioContext || window.webkitAudioContext)();
                this.scriptNode = this.actx.createScriptProcessor(4096, 0, 1);
                this.recordingDest = this.actx.createMediaStreamDestination();
                this.ringBuffer = new Float32Array(4096 * 3);
                this.writeIndex = 0; this.readIndex = 0;
                this.scriptNode.onaudioprocess = (e) => {
                    const out = e.outputBuffer.getChannelData(0);
                    for (let i = 0; i < 4096; i++) {
                        out[i] = (this.readIndex === this.writeIndex) ? 0 : this.ringBuffer[this.readIndex];
                        if (this.readIndex !== this.writeIndex) this.readIndex = (this.readIndex + 1) % this.ringBuffer.length;
                    }
                };
                this.scriptNode.connect(this.actx.destination);
                this.scriptNode.connect(this.recordingDest);
            }
            resume() { if (this.actx.state === 'suspended') this.actx.resume(); }
            writeSample(v) { this.ringBuffer[this.writeIndex] = v; this.writeIndex = (this.writeIndex + 1) % this.ringBuffer.length; }
            getAudioStream() { return this.recordingDest.stream; }
        }

        // åŠŸèƒ½å‡½æ•°ï¼šæˆªå›¾/åˆ†äº«/å½•åƒ
        document.getElementById('btnScreenshot').onclick = () => {
            canvas.toBlob(blob => {
                lastScreenshotBlob = blob;
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob); a.download = `FC_Capture.png`; a.click();
                document.getElementById('btnShare').disabled = false;
            });
        };

        document.getElementById('btnStartRec').onclick = () => {
            recordedChunks = [];
            const stream = canvas.captureStream(60);
            if (audioHandler) stream.addTrack(audioHandler.getAudioStream().getAudioTracks()[0]);
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'gameplay.webm'; a.click();
            };
            mediaRecorder.start();
            document.getElementById('btnStartRec').style.display = 'none';
            document.getElementById('btnStopRec').style.display = 'inline-block';
            document.getElementById('recIndicator').style.display = 'flex';
        };

        document.getElementById('btnStopRec').onclick = () => {
            mediaRecorder.stop();
            document.getElementById('btnStartRec').style.display = 'inline-block';
            document.getElementById('btnStopRec').style.display = 'none';
            document.getElementById('recIndicator').style.display = 'none';
        };

        // ç›´æ’­é€»è¾‘
        document.getElementById('btnConnectCast').onclick = () => {
            const targetId = document.getElementById('targetPeerId').value.trim();
            if (!targetId) return alert("è¯·è¾“å…¥è§‚ä¼—ID");
            
            if (!peer) {
                peer = new Peer('HOST_' + Math.floor(Math.random()*100), { host: '127.0.0.1', port: 9000, path: '/' });
            }
            
            peer.on('open', () => {
                const stream = canvas.captureStream(60);
                if (audioHandler) stream.addTrack(audioHandler.getAudioStream().getAudioTracks()[0]);
                peer.call(targetId, stream);
                dataConn = peer.connect(targetId);
                dataConn.on('data', data => {
                    if (data.type === 'emoji') spawnEmoji(data.value);
                    if (data.type === 'chat') spawnDanmaku(data.value);
                });
                document.getElementById('btnConnectCast').innerText = "âœ… å·²åŒæ­¥";
            });
        };

        function spawnEmoji(emoji) {
            const el = document.createElement('div'); el.className = 'floating-emoji'; el.innerText = emoji;
            el.style.left = Math.random() * 80 + 10 + '%'; el.style.setProperty('--rx', (Math.random() * 200 - 100) + 'px');
            document.getElementById('interaction-layer').appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        function spawnDanmaku(text) {
            const el = document.createElement('div'); el.className = 'danmaku'; el.innerText = text;
            el.style.top = Math.random() * 60 + 10 + '%';
            document.getElementById('interaction-layer').appendChild(el);
            setTimeout(() => el.remove(), 7000);
        }

        // æ–‡ä»¶åŠ è½½
        document.getElementById('rom-upload').onchange = (e) => {
            const reader = new FileReader();
            reader.readAsArrayBuffer(e.target.files[0]);
            reader.onload = (ev) => {
                const bytes = new Uint8Array(ev.target.result);
                let bin = ""; for(let i=0; i<bytes.length; i++) bin += String.fromCharCode(bytes[i]);
                nes.loadROM(bin);
                isFileLoaded = true;
                if (!audioHandler) audioHandler = new AudioHandler();
                overlay.classList.remove('visible');
                document.querySelectorAll('.btn').forEach(b => b.disabled = false);
            };
        };

        const KEYMAP = { 38: 4, 40: 5, 37: 6, 39: 7, 88: 0, 90: 1, 13: 3, 17: 2 };
        document.addEventListener('keydown', e => { if(isFileLoaded && KEYMAP[e.keyCode]!==undefined) nes.buttonDown(1, KEYMAP[e.keyCode]); });
        document.addEventListener('keyup', e => { if(isFileLoaded && KEYMAP[e.keyCode]!==undefined) nes.buttonUp(1, KEYMAP[e.keyCode]); });

        function loop() { if (isFileLoaded) nes.frame(); requestAnimationFrame(loop); }
        loop();
    </script>
</body>
</html>

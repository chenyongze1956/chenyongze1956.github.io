
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title></title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body {
     background: linear-gradient(45deg,#ff7e5f,#feb47b,#ffed86,#9feb8f,#5fbfff,#9b8eff);
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px 0;
            box-sizing: border-box;
            user-select: none;
        }
        h1 { margin: 10px 0; font-weight: 300; letter-spacing: 2px;}

        /* --- CRT ç”µè§†æœºå¤–è§‚æ ¸å¿ƒæ ·å¼ --- */
        .tv-wrapper {
            background: #111;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 
                inset 0 0 50px rgba(0,0,0,0.8),
                0 20px 50px rgba(0,0,0,0.5);
            position: relative;
        }

        .screen-container {
            position: relative;
            background: #000;
            border: 2px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }

        canvas {
            display: block;
            image-rendering: pixelated;
            width: 512px; 
            height: 480px;
            filter: none; 
            transition: filter 0.3s;
        }

        /* --- æ»¤é•œæ ·å¼å®šä¹‰ --- */
        .filter-grayscale { filter: grayscale(100%); }
        .filter-sepia { filter: sepia(80%) brightness(110%); }
        .filter-blurry { filter: blur(1px) contrast(150%); }
        .filter-crt { filter: contrast(110%) brightness(110%); }

        /* --- æ‰«æçº¿æ•ˆæœ --- */
        .tv-wrapper .scanlines::after {
            content: '';
            display: block;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            background: linear-gradient( to bottom, rgba(0, 0, 0, 0.5) 50%, rgba(0, 0, 0, 0.1) 50% );
            background-size: 100% 4px;
            opacity: 0.2;
            mix-blend-mode: overlay;
        }
        
        /* --- UI æ ·å¼ --- */
        .overlay.visible { opacity: 1; }
        /* å·¥å…·æ æ¢å¤å±…ä¸­å’Œå…è®¸æ¢è¡Œ */
        .toolbar { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 15px; 
            align-items: center; 
            flex-wrap: wrap; 
            justify-content: center; 
        }

        /* --- æ ¸å¿ƒä¿®æ”¹ï¼šç»Ÿä¸€æŒ‰é’®å°ºå¯¸ (100px x 40px) --- */
        .btn {
            width: 100px; /* ç»Ÿä¸€å®½åº¦ */
            height: 40px; /* ç»Ÿä¸€é«˜åº¦ */
            padding: 0; /* ä½¿ç”¨ height å’Œ flex å±…ä¸­ */
            justify-content: center; 
            color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: background 0.2s, opacity 0.2s; 
            display: flex; 
            align-items: center; 
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; background: #555 !important; }
        .btn-load { background: #e53935; }
        .btn-load:hover:not(:disabled) { background: #d32f2f; }
        .btn-screenshot { background: #795548; } 
        .btn-screenshot:hover:not(:disabled) { background: #6D4C41; }
        .btn-share { background: #00BCD4; }
        .btn-share:hover:not(:disabled) { background: #00ACC1; }
        .btn-record-start { background: #4CAF50; }
        .btn-record-start:hover:not(:disabled) { background: #45a049; }
        .btn-record-stop { background: #f44336; display: none; }
        .btn-record-stop:hover:not(:disabled) { background: #d32f2f; }

        .recording-indicator { display: none; align-items: center; color: #f44336; font-weight: bold; margin-left: 10px; animation: blink 1s infinite; }
        .recording-indicator::before { content: ''; display: inline-block; width: 10px; height: 10px; background: #f44336; border-radius: 50%; margin-right: 5px; }
        @keyframes blink { 50% { opacity: 0; } }

        /* --- æ ¸å¿ƒä¿®æ”¹ï¼šç»Ÿä¸€æ»¤é•œä¸‹æ‹‰èœå•å°ºå¯¸ (100px x 40px) --- */
        #filter-select {
            width: 100px; 
            height: 40px; 
            padding: 0 12px; 
            border-radius: 4px;
            border: 1px solid #444;
            background: #333;
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .controls { margin-top: 20px; padding: 15px; background: #2a2a2a; border-radius: 8px; text-align: center; color: #ccc; font-size: 0.9em; }
        input[type="file"] { display: none; }
        .key-badge { display: inline-block; background: #444; padding: 2px 6px; border-radius: 4px; margin: 0 2px; font-family: monospace; font-weight: bold; color: #fff; }
    </style>
</head>
<body>

    
    <div class="toolbar">
        <input type="file" id="rom-upload" accept=".nes">
        <button class="btn btn-load" onclick="document.getElementById('rom-upload').click()">ğŸ“‚ åŠ è½½æ¸¸æˆ</button>
        
        <select id="filter-select">
            <option value="none">ğŸ•¹ï¸ é»˜è®¤ (æ¸…æ™°)</option>
            <option value="crt">ğŸ“º CRT æ‰«æçº¿</option>
            <option value="grayscale">é»‘ç™½ (Grayscale)</option>
            <option value="sepia">å¤å¤ (Sepia)</option>
            <option value="blurry">æ¨¡ç³Š (Blended)</option>
        </select>

        <button id="btnScreenshot" class="btn btn-screenshot" disabled>ğŸ“· æˆªå›¾</button>
        <button id="btnShare" class="btn btn-share" disabled>ğŸ”— åˆ†äº«</button>

        <button id="btnStartRec" class="btn btn-record-start" disabled>ğŸ”´ å¼€å§‹å½•åƒ</button>
        <button id="btnStopRec" class="btn btn-record-stop">â¬œ åœæ­¢å½•åƒ</button>
        
        <div id="recIndicator" class="recording-indicator">REC</div>
    </div>

    <div class="tv-wrapper" id="tv-wrapper">
        <div class="screen-container scanlines">
            <canvas id="screen" width="256" height="240"></canvas>
            <div id="msg-overlay" class="overlay visible"></div>
        </div>
    </div>

   

    <script src="https://unpkg.com/jsnes/dist/jsnes.min.js"></script>

    <script>
        // --- JS ä»£ç ä¿æŒä¸å˜ ---
        const SCREEN_WIDTH = 256;
        const SCREEN_HEIGHT = 240;
        const canvas = document.getElementById('screen');
        const ctx = canvas.getContext('2d');
        const imageData = ctx.createImageData(SCREEN_WIDTH, SCREEN_HEIGHT);
        const buf32 = new Uint32Array(imageData.data.buffer);
        const overlay = document.getElementById('msg-overlay');

        const btnScreenshot = document.getElementById('btnScreenshot');
        const btnShare = document.getElementById('btnShare');
        const btnStartRec = document.getElementById('btnStartRec');
        const btnStopRec = document.getElementById('btnStopRec');
        const recIndicator = document.getElementById('recIndicator');
        const filterSelect = document.getElementById('filter-select'); 

        let audioHandler = null;
        let isFileLoaded = false;
        let lastScreenshotBlob = null; 
        
        class AudioHandler {
            constructor() {
                this.actx = new (window.AudioContext || window.webkitAudioContext)();
                this.bufferSize = 4096;
                this.scriptNode = this.actx.createScriptProcessor(this.bufferSize, 0, 1);
                this.recordingDest = this.actx.createMediaStreamDestination();
                this.ringBuffer = new Float32Array(this.bufferSize * 3); 
                this.writeIndex = 0;
                this.readIndex = 0;
                this.scriptNode.onaudioprocess = (e) => this.process(e);
                this.scriptNode.connect(this.actx.destination);
                this.scriptNode.connect(this.recordingDest);
            }
            resume() { if (this.actx.state === 'suspended') { this.actx.resume(); } }
            getAudioStream() { return this.recordingDest.stream; }
            writeSample(value) {
                this.ringBuffer[this.writeIndex] = value;
                this.writeIndex++;
                if (this.writeIndex >= this.ringBuffer.length) this.writeIndex = 0;
            }
            process(e) {
                const output = e.outputBuffer.getChannelData(0);
                for (let i = 0; i < this.bufferSize; i++) {
                    if (this.readIndex === this.writeIndex) { output[i] = 0; } 
                    else {
                        output[i] = this.ringBuffer[this.readIndex];
                        this.readIndex++;
                        if (this.readIndex >= this.ringBuffer.length) self.readIndex = 0;
                    }
                }
            }
        }

        var nes = new jsnes.NES({
            onFrame: function(frameBuffer) {
                let i = 0;
                for (let y = 0; y < SCREEN_HEIGHT; ++y) {
                    for (let x = 0; x < SCREEN_WIDTH; ++x) {
                        i = y * SCREEN_WIDTH + x;
                        buf32[i] = 0xFF000000 | frameBuffer[i]; 
                    }
                }
                ctx.putImageData(imageData, 0, 0);
            },
            onAudioSample: function(left, right) {
                if (audioHandler) { audioHandler.writeSample(left); }
            }
        });

        function onAnimationFrame() {
            window.requestAnimationFrame(onAnimationFrame);
            if (isFileLoaded) { nes.frame(); }
        }
        window.requestAnimationFrame(onAnimationFrame);

        document.getElementById('rom-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (!audioHandler) { audioHandler = new AudioHandler(); }
            audioHandler.resume();
            const reader = new FileReader();
            reader.readAsBinaryString(file);
            reader.onload = function(e) {
                try {
                    nes.loadROM(e.target.result);
                    isFileLoaded = true;
                    overlay.classList.remove('visible');
                    btnStartRec.disabled = false;
                    btnScreenshot.disabled = false;
                    btnShare.disabled = true;
                } catch(err) { alert("åŠ è½½å¤±è´¥: " + err); }
            };
        });

        function handleFilterChange(event) {
            canvas.className = '';
            const selectedFilter = event.target.value;
            if (selectedFilter !== 'none') {
                canvas.classList.add(`filter-${selectedFilter}`);
            }
            if (selectedFilter === 'crt') {
                document.querySelector('.screen-container').classList.add('scanlines');
            } else {
                document.querySelector('.screen-container').classList.remove('scanlines');
            }
        }
        filterSelect.addEventListener('change', handleFilterChange);

        function dataURLtoBlob(dataurl) {
            const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while(n--){ u8arr[n] = bstr.charCodeAt(n); }
            return new Blob([u8arr], {type:mime});
        }

        function takeScreenshot() {
            if (!isFileLoaded) return;
            const dataURL = canvas.toDataURL('image/png');
            const imageBlob = dataURLtoBlob(dataURL);
            lastScreenshotBlob = imageBlob;
            btnShare.disabled = false;

            const a = document.createElement('a'); a.href = dataURL;
            const timestamp = new Date().toISOString().slice(0,19).replace(/[-T:]/g, '');
            a.download = `NES_Screenshot_${timestamp}.png`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            alert("æˆªå›¾å·²ä¸‹è½½ï¼ç°åœ¨å¯ä»¥ç‚¹å‡»åˆ†äº«æŒ‰é’®ã€‚");
        }
        
        async function shareScreenshot() {
            if (!lastScreenshotBlob) { alert("è¯·å…ˆç‚¹å‡» 'æˆªå›¾' æŒ‰é’®ï¼"); return; }
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([lastScreenshotBlob], 'screenshot.png', {type: 'image/png'})] })) {
                try {
                    await navigator.share({
                        files: [new File([lastScreenshotBlob], 'screenshot.png', {type: 'image/png'})],
                        title: 'æˆ‘çš„ FC æ¸¸æˆæˆªå›¾',
                        text: 'å¿«æ¥çœ‹æˆ‘çš„æ¸¸æˆè¿›åº¦ï¼ #NES #FCæ¨¡æ‹Ÿå™¨',
                    });
                } catch (error) {
                    if (error.name !== 'AbortError') { console.error('åˆ†äº«å¤±è´¥:', error); alert('åˆ†äº«å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æ‰‹åŠ¨ä¸‹è½½æˆªå›¾ã€‚'); }
                }
            } else { alert("æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒé«˜çº§åˆ†äº«åŠŸèƒ½ã€‚æˆªå›¾å·²ä¸‹è½½ï¼Œè¯·æ‰‹åŠ¨åˆ†äº«ã€‚"); }
        }
        btnScreenshot.addEventListener('click', takeScreenshot);
        btnShare.addEventListener('click', shareScreenshot);

        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;

        btnStartRec.addEventListener('click', startRecording);
        btnStopRec.addEventListener('click', stopRecording);

        function getMimeTypeOptions() {
            const mp4Mime = 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"';
            const webmMime = 'video/webm; codecs=vp9,opus';
            if (MediaRecorder.isTypeSupported(mp4Mime)) { return { mimeType: mp4Mime }; } 
            if (MediaRecorder.isTypeSupported(webmMime)) { return { mimeType: webmMime }; } 
            return {};
        }

        function startRecording() {
            if (!isFileLoaded || !audioHandler || isRecording) return;
            const canvasStream = canvas.captureStream(60);
            const audioStream = audioHandler.getAudioStream();
            const combinedStream = new MediaStream([...canvasStream.getVideoTracks(),...audioStream.getAudioTracks()]);
            const options = getMimeTypeOptions();
            if (!options.mimeType) { alert("å½•åƒåŠŸèƒ½ä¸å¯ç”¨ï¼Œæµè§ˆå™¨ä¸æ”¯æŒæ‰€éœ€çš„è§†é¢‘ç¼–ç ã€‚"); return; }
            try { mediaRecorder = new MediaRecorder(combinedStream, options); } 
            catch (e) { console.error("åˆå§‹åŒ– MediaRecorder å¤±è´¥:", e); alert("åˆå§‹åŒ–å½•åƒå¤±è´¥ã€‚"); return; }
            recordedChunks = [];
            mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = downloadRecording;
            mediaRecorder.start();
            isRecording = true;
            updateRecordUI(true);
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                updateRecordUI(false);
            }
        }

        function downloadRecording() {
            const blob = new Blob(recordedChunks, { type: mediaRecorder.mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.style.display = 'none'; a.href = url;
            const actualMimeType = mediaRecorder.mimeType.toLowerCase();
            const fileExt = actualMimeType.includes('mp4') ? 'mp4' : 'webm';
            const timestamp = new Date().toISOString().slice(0,19).replace(/[-T:]/g, '');
            a.download = `FC_Gameplay_${timestamp}.${fileExt}`;
            document.body.appendChild(a); a.click();
            setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); alert(`å½•åƒå·²å®Œæˆå¹¶å¼€å§‹ä¸‹è½½ï¼æ ¼å¼: .${fileExt}`); }, 100);
        }

        function updateRecordUI(recording) {
            if (recording) {
                btnStartRec.style.display = 'none'; btnStopRec.style.display = 'flex'; recIndicator.style.display = 'flex';
                document.getElementById('rom-upload').previousElementSibling.disabled = true; 
                btnScreenshot.disabled = true; btnShare.disabled = true;
                filterSelect.disabled = true;
            } else {
                btnStartRec.style.display = 'flex'; btnStopRec.style.display = 'none'; recIndicator.style.display = 'none';
                document.getElementById('rom-upload').previousElementSibling.disabled = false; 
                btnScreenshot.disabled = false;
                btnShare.disabled = (lastScreenshotBlob === null);
                filterSelect.disabled = false;
            }
        }

        const KEYMAP = { 88: 1, 90: 2, 17: 4, 13: 8, 38: 16, 40: 32, 37: 64, 39: 128 };
        function handleKey(e, type) {
            if (KEYMAP[e.keyCode] !== undefined) {
                nes[type === 'down' ? 'buttonDown' : 'buttonUp'](1, KEYMAP[e.keyCode]);
                e.preventDefault();
            }
        }
        document.addEventListener('keydown', (e) => handleKey(e, 'down'));
        document.addEventListener('keyup', (e) => handleKey(e, 'up'));

    </script>
</body>
</html>

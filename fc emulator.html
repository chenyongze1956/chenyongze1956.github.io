
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title></title>
    <style>
        body {
     background: linear-gradient(45deg,#ff7e5f,#feb47b,#ffed86,#9feb8f,#5fbfff,#9b8eff);
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            user-select: none;
        }
        h1 { margin-bottom: 10px; font-weight: 300; letter-spacing: 2px;}
        .screen-container {
            position: relative;
            border: 4px solid #444;
            box-shadow: 0 0 30px rgba(0,0,0,0.6);
            background: #000;
        }
        canvas {
            display: block;
            image-rendering: pixelated;
            width: 512px; 
            height: 480px;
        }
        .overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.8);
            color: #fff;
            font-size: 1.2em;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .overlay.visible { opacity: 1; }
        
        .controls {
            margin-top: 20px;
            padding: 15px;
            background: #2a2a2a;
            border-radius: 8px;
            text-align: center;
            color: #ccc;
            font-size: 0.9em;
        }
        .file-btn {
            margin-bottom: 15px;
            padding: 10px 20px;
     background: linear-gradient(45deg,#ff7e5f,#feb47b,#ffed86,#9feb8f,#5fbfff,#9b8eff);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.2s;
        }
        .file-btn:hover { background: #d32f2f; }
        input[type="file"] { display: none; }
        .key-badge {
            display: inline-block;
            background: #444;
            padding: 2px 6px;
            border-radius: 4px;
            margin: 0 2px;
            font-family: monospace;
            font-weight: bold;
            color: #fff;
        }
    </style>
</head>
<body>

    
    <input type="file" id="rom-upload" accept=".nes">
    <button class="file-btn" onclick="document.getElementById('rom-upload').click()">üìÇ Âä†ËΩΩÊ∏∏Êàè ROM (.nes)</button>

    <div class="screen-container">
        <canvas id="screen" width="256" height="240"></canvas>
        <div id="msg-overlay" class="overlay visible">ËØ∑Âä†ËΩΩ ROM ÂºÄÂßãÊ∏∏Êàè</div>
    </div>

   

    <script src="https://unpkg.com/jsnes/dist/jsnes.min.js"></script>

    <script>
        const SCREEN_WIDTH = 256;
        const SCREEN_HEIGHT = 240;
        const canvas = document.getElementById('screen');
        const ctx = canvas.getContext('2d');
        const imageData = ctx.createImageData(SCREEN_WIDTH, SCREEN_HEIGHT);
        const buf32 = new Uint32Array(imageData.data.buffer);
        const overlay = document.getElementById('msg-overlay');

        // --- Èü≥È¢ëÂ§ÑÁêÜÁ±ª (Ring Buffer) ---
        class AudioHandler {
            constructor() {
                this.actx = new (window.AudioContext || window.webkitAudioContext)();
                this.bufferSize = 4096;
                this.scriptNode = this.actx.createScriptProcessor(this.bufferSize, 0, 1);
                
                // ÁÆÄÂçïÁöÑÁéØÂΩ¢ÁºìÂÜ≤Âå∫
                this.ringBuffer = new Float32Array(this.bufferSize * 3); 
                this.writeIndex = 0;
                this.readIndex = 0;
                
                this.scriptNode.onaudioprocess = (e) => this.process(e);
                this.scriptNode.connect(this.actx.destination);
            }

            resume() {
                if (this.actx.state === 'suspended') {
                    this.actx.resume();
                }
            }

            // NES Ê†∏ÂøÉË∞ÉÁî®Ê≠§ÊñπÊ≥ïÂÜôÂÖ•Èü≥È¢ëÊ†∑Êú¨
            writeSample(value) {
                // ÁÆÄÂçïÁöÑÈü≥ÈáèÈôêÂà∂ÂíåÂÜôÂÖ•
                this.ringBuffer[this.writeIndex] = value;
                this.writeIndex++;
                if (this.writeIndex >= this.ringBuffer.length) {
                    this.writeIndex = 0;
                }
            }

            // WebAudio Ë∞ÉÁî®Ê≠§ÊñπÊ≥ïËØªÂèñÊï∞ÊçÆ
            process(e) {
                const output = e.outputBuffer.getChannelData(0);
                for (let i = 0; i < this.bufferSize; i++) {
                    if (this.readIndex === this.writeIndex) {
                        // ÁºìÂÜ≤Âå∫Á©∫‰∫ÜÔºåËæìÂá∫ÈùôÈü≥ (Èò≤Ê≠¢ÁàÜÈü≥)
                        output[i] = 0; 
                    } else {
                        output[i] = this.ringBuffer[this.readIndex];
                        this.readIndex++;
                        if (this.readIndex >= this.ringBuffer.length) {
                            this.readIndex = 0;
                        }
                    }
                }
            }
        }

        let audioHandler = null;

        // --- ÂàùÂßãÂåñ NES ---
        var nes = new jsnes.NES({
            onFrame: function(frameBuffer) {
                let i = 0;
                for (let y = 0; y < SCREEN_HEIGHT; ++y) {
                    for (let x = 0; x < SCREEN_WIDTH; ++x) {
                        i = y * SCREEN_WIDTH + x;
                        buf32[i] = 0xFF000000 | frameBuffer[i]; // Â°´ÂÖÖ Alpha ÈÄöÈÅì
                    }
                }
                ctx.putImageData(imageData, 0, 0);
            },
            onAudioSample: function(left, right) {
                // Â∞ÜÂ∑¶Âè≥Â£∞ÈÅìÊ∑∑Âêà‰∏∫ÂçïÂ£∞ÈÅì (Êõ¥ÁÆÄÂçï)
                if (audioHandler) {
                    audioHandler.writeSample(left); 
                }
            }
        });

        // --- Ê∏∏ÊàèÂæ™ÁéØ ---
        function onAnimationFrame() {
            window.requestAnimationFrame(onAnimationFrame);
            if (isFileLoaded) {
                // ÊØèÊ¨°Â±èÂπïÂà∑Êñ∞ÔºåËøêË°å‰∏ÄÂ∏ß NES ÈÄªËæë
                nes.frame();
            }
        }
        window.requestAnimationFrame(onAnimationFrame);

        // --- ROM Âä†ËΩΩ ---
        let isFileLoaded = false;
        document.getElementById('rom-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // ÂàùÂßãÂåñÈü≥È¢ë (ÂøÖÈ°ªÂú®Áî®Êà∑‰∫§‰∫íÂêé)
            if (!audioHandler) {
                audioHandler = new AudioHandler();
            }
            audioHandler.resume();

            const reader = new FileReader();
            reader.readAsBinaryString(file);
            
            reader.onload = function(e) {
                try {
                    nes.loadROM(e.target.result);
                    isFileLoaded = true;
                    overlay.classList.remove('visible'); // ÈöêËóèÈÅÆÁΩ©
                    console.log("ROM Loaded & Audio Started");
                } catch(err) {
                    alert("Âä†ËΩΩÂ§±Ë¥•: " + err);
                }
            };
        });

        // --- ÈîÆÁõòÊéßÂà∂ ---
        const KEYMAP = {
            88: jsnes.Controller.BUTTON_A,      // X
            90: jsnes.Controller.BUTTON_B,      // Z
            17: jsnes.Controller.BUTTON_SELECT, // Ctrl
            13: jsnes.Controller.BUTTON_START,  // Enter
            38: jsnes.Controller.BUTTON_UP,
            40: jsnes.Controller.BUTTON_DOWN,
            37: jsnes.Controller.BUTTON_LEFT,
            39: jsnes.Controller.BUTTON_RIGHT
        };

        function handleKey(e, type) {
            if (KEYMAP[e.keyCode] !== undefined) {
                nes[type === 'down' ? 'buttonDown' : 'buttonUp'](1, KEYMAP[e.keyCode]);
                e.preventDefault(); // Èò≤Ê≠¢ÊåâÊñπÂêëÈîÆÊó∂ÊªöÂä®È°µÈù¢
            }
        }

        document.addEventListener('keydown', (e) => handleKey(e, 'down'));
        document.addEventListener('keyup', (e) => handleKey(e, 'up'));

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Web FC æŠ•å±æ¥æ”¶ç«¯</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%; background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #fff;
        }
        #remoteVideo {
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            background: #111;
        }
        .control-panel {
            position: absolute;
            top: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            z-index: 10;
        }
        h2, p { margin: 5px 0; }
        strong { color: #4CAF50; }
    </style>
</head>
<body>

    <div class="control-panel">
        <h2>ğŸ“º WebRTC æ¥æ”¶ç«¯</h2>
        <p>æ‚¨çš„ç›´æ’­ ID (è¯·å‘ŠçŸ¥ä¸»æ’­): <strong id="myId">ç­‰å¾…ä¸­...</strong></p>
        <p id="status">çŠ¶æ€: æ­£åœ¨ç­‰å¾…ä¸»æ’­è¿æ¥...</p>
    </div>

    <video id="remoteVideo" autoplay playsinline></video>

    <script>
        const remoteVideo = document.getElementById('remoteVideo');
        const myIdEl = document.getElementById('myId');
        const statusEl = document.getElementById('status');
        let peer = null;

        function startViewer() {
            // 1. åˆå§‹åŒ– PeerJS (æŒ‡å‘æœ¬åœ° PeerServer)
            peer = new Peer({
                // !!! å…³é”®ä¿®æ”¹: æŒ‡å‘æœ¬åœ° PeerServer
                host: '127.0.0.1', 
                port: 9000,
                path: '/',
                secure: false // æœ¬åœ°è¿æ¥
            });

            peer.on('open', (id) => {
                myIdEl.textContent = id;
                statusEl.textContent = "çŠ¶æ€: å‡†å¤‡å°±ç»ªï¼Œè¯·å°†æ­¤ ID å‘ŠçŸ¥ä¸»æ’­";
                myIdEl.style.color = '#FFC107';
            });

            // 2. ç›‘å¬æ¥è‡ªä¸»æ’­çš„å‘¼å«
            peer.on('call', (call) => {
                statusEl.textContent = `çŠ¶æ€: æ”¶åˆ°æ¥è‡ª ${call.peer} çš„å‘¼å«ï¼Œæ­£åœ¨è¿æ¥...`;
                
                call.answer(); 

                // 3. æ¥æ”¶è§†é¢‘æµ
                call.on('stream', (remoteStream) => {
                    remoteVideo.srcObject = remoteStream;
                    remoteVideo.play().catch(e => {
                        console.error("Video playback failed:", e);
                        statusEl.textContent = "çŠ¶æ€: è§†é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·å°è¯•ç‚¹å‡»å±å¹•ï¼";
                    });
                    
                    statusEl.textContent = "çŠ¶æ€: æ­£åœ¨ç›´æ’­ï¼";
                    myIdEl.style.color = '#4CAF50';
                });
                
                call.on('close', () => {
                    statusEl.textContent = "çŠ¶æ€: ç›´æ’­å·²æ–­å¼€";
                    remoteVideo.srcObject = null;
                    myIdEl.style.color = '#FFC107';
                });
            });

            peer.on('error', (err) => {
                console.error("PeerJS é”™è¯¯:", err);
                statusEl.textContent = `P2P é”™è¯¯: ${err.type} (è¯·æ£€æŸ¥æœ¬åœ°PeerServeræ˜¯å¦è¿è¡Œ)`;
            });
        }

        startViewer();
    </script>
</body>
</html>
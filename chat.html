<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: sans-serif; margin: 20px;  background: linear-gradient(45deg,#ff7e5f,#feb47b,#ffed86,#9feb8f,#5fbfff,#9b8eff);
 }
        
        /* ä¾§è¾¹æ å’Œä¸»å®¹å™¨æ ·å¼ */
        #chatContainer { display: flex; max-width: 850px; margin: 0 auto; }
        #messagesDiv { flex-grow: 1; height: 400px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; margin-right: 10px; background-color: #f8f8f8;}
        #sidebar { width: 150px; padding: 10px; border: 1px solid #eee; background-color: #f9f9f9; }

        /* æ¶ˆæ¯åˆ—è¡¨æ ·å¼ */
        .message-item { margin-bottom: 5px; line-height: 1.4; padding: 2px 0;}
        .user { font-weight: bold; color: #007bff; }
        .user-private { font-weight: bold; color: #dc3545; }
        .timestamp { font-size: 0.8em; color: #999; margin-left: 10px; }
        .info { color: orange; font-style: italic; }
        .error { color: red; font-weight: bold; }
        
        /* åœ¨çº¿ç”¨æˆ·æŒ‡ç¤ºå™¨ */
        .online-user-item { cursor: pointer; padding: 5px; border-bottom: 1px dotted #ccc; display: flex; align-items: center; }
        .online-user-item:hover { background-color: #e9e9e9; }
        .online-indicator { height: 8px; width: 8px; background-color: #28a745; border-radius: 50%; margin-right: 8px; display: inline-block; }

        /* æ–‡ä»¶å’Œè¡¨æƒ…ç¬¦å· */
        .file-transfer a { color: #dc3545; text-decoration: none; word-break: break-all; }
        .emoji-item { font-size: 24px; padding: 5px; cursor: pointer; margin: 2px; display: inline-block; transition: transform 0.1s; }
        .emoji-item:hover { transform: scale(1.2); }
    </style>
</head>
<body>

    
    <div>
        <label for="username">æ‚¨çš„ç”¨æˆ·å:</label>
        <input type="text" id="username" value="UserA" required>
        <button onclick="refreshPage()">é‡æ–°è¿æ¥</button>
    </div>
    
    <hr>
    
    <div id="chatContainer">
        
        <div style="flex-grow: 1;">
            <div id="chatTabs" style="display: flex; margin-bottom: 10px;">
                <button id="publicTabBtn" onclick="switchChatTab('public')" 
                    style="padding: 10px; flex-grow: 1; cursor: pointer; background-color: #28a745; color: white; border: none;">
                    å…¬èŠ (Public)
                </button>
                <button id="privateTabBtn" onclick="switchChatTab('private')" disabled
                    style="padding: 10px; flex-grow: 1; cursor: default; background-color: #ccc; color: #666; border: none;">
                    ç§èŠ (æœªé€‰ä¸­)
                </button>
            </div>

            <div id="messagesDiv">
                </div>
            
            <div id="typingIndicator" style="height: 20px; color: #999; font-size: 0.9em; margin-top: 5px;">
                </div>

            <div id="privateChatStatus" style="color: #dc3545; font-weight: bold; margin-top: 5px; display: none;">
                æ­£åœ¨ä¸ <span id="privateTargetUser"></span> ç§èŠ...
            </div>
        </div>

        <div id="sidebar">
            <div id="onlineCount">åœ¨çº¿äººæ•°: 0</div>
            <strong>åœ¨çº¿ç”¨æˆ·:</strong>
            <div id="onlineUsersList">
                </div>
        </div>
    </div>
    
    <div style="display: flex; align-items: center; margin-top: 10px;">
        <button onclick="toggleEmojiPicker()" style="margin-right: 10px; padding: 5px 10px; cursor: pointer;">ğŸ˜€</button>
        
        <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." style="width: 500px;">
        <button onclick="sendMessage()">å‘é€</button>
        
        <input type="file" id="fileInput" onchange="enableFileSend()" style="margin-left: 20px;">
        <button id="sendFileBtn" onclick="sendFile()" disabled>å‘é€æ–‡ä»¶</button>
    </div>
    
    <div id="emojiPicker">
        <span class="emoji-item" onclick="insertEmoji('ğŸ˜€')">ğŸ˜€</span>
        <span class="emoji-item" onclick="insertEmoji('ğŸ˜‚')">ğŸ˜‚</span>
        <span class="emoji-item" onclick="insertEmoji('ğŸ˜')">ğŸ˜</span>
        <span class="emoji-item" onclick="insertEmoji('ğŸ¤”')">ğŸ¤”</span>
        <span class="emoji-item" onclick="insertEmoji('ğŸ¥³')">ğŸ¥³</span>
        <span class="emoji-item" onclick="insertEmoji('ğŸ˜­')">ğŸ˜­</span>
        <span class="emoji-item" onclick="insertEmoji('ğŸ‘')">ğŸ‘</span>
        <span class="emoji-item" onclick="insertEmoji('ğŸ™')">ğŸ™</span>
        <span class="emoji-item" onclick="insertEmoji('ğŸ”¥')">ğŸ”¥</span>
        <span class="emoji-item" onclick="insertEmoji('ğŸ‰')">ğŸ‰</span>
        <span class="emoji-item" onclick="insertEmoji('ğŸš€')">ğŸš€</span>
        <span class="emoji-item" onclick="insertEmoji('ğŸ’¡')">ğŸ’¡</span>
    </div>

    <script>
        // --- æ ¸å¿ƒå˜é‡å®šä¹‰ ---
        const SOCKET_URL = "ws://localhost:8775";
        const messagesDiv = document.getElementById("messagesDiv");
        const messageInput = document.getElementById("messageInput");
        const usernameInput = document.getElementById("username");
        const onlineCountDiv = document.getElementById("onlineCount");
        const onlineUsersListDiv = document.getElementById("onlineUsersList");
        const fileInput = document.getElementById("fileInput");
        const sendFileBtn = document.getElementById("sendFileBtn");
        const emojiPicker = document.getElementById("emojiPicker");
        const typingIndicatorDiv = document.getElementById("typingIndicator");

        let socket;
        let activeTab = 'public'; 
        let privateChatTarget = null; 
        const privateConversations = {}; 
        const publicMessages = []; 

        // è¾“å…¥çŠ¶æ€ç®¡ç†
        const typingUsers = {};
        let isTyping = false; 
        let typingTimeout = null; 
        
        // --- è¿æ¥å’Œåˆå§‹åŒ– ---
        
        function connect() {
            const user = usernameInput.value.trim();
            if (!user) { alert("è¯·å…ˆè¾“å…¥ä¸€ä¸ªç”¨æˆ·åï¼"); return; }
            if (socket && socket.readyState === WebSocket.OPEN) { socket.close(); }
            
            socket = new WebSocket(SOCKET_URL);

            socket.onopen = function(e) {
                const registrationMessage = { type: "register", user: user };
                socket.send(JSON.stringify(registrationMessage));
                
                const element = createMessageElement("ç³»ç»Ÿ", `ä»¥ç”¨æˆ·å **${user}** è¿æ¥æœåŠ¡å™¨æˆåŠŸï¼`, "info");
                appendMessage(element, 'info', "ç³»ç»Ÿ");
            };

            socket.onclose = function(event) {
                 const element = createMessageElement("ç³»ç»Ÿ", `è¿æ¥å·²æ–­å¼€ (ä»£ç : ${event.code})`, "info");
                 appendMessage(element, 'info', "ç³»ç»Ÿ");
            };

            socket.onerror = function(error) {
                const element = createMessageElement("ç³»ç»Ÿ", `è¿æ¥å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œã€‚`, "error");
                appendMessage(element, 'error', "ç³»ç»Ÿ");
            };

            // 2. æ¥æ”¶æ¶ˆæ¯ - **æ ¸å¿ƒè·¯ç”±**
            socket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    const time = data.time || new Date().toISOString();
                    
                    if (data.type === "chat" || data.type === "info" || data.type === "error") {
                        const element = createMessageElement(data.user || "ç³»ç»Ÿ", data.message, data.type, time);
                        appendMessage(element, data.type, data.user || "ç³»ç»Ÿ");
                    
                    } else if (data.type === "private") {
                        initiatePrivateChat(data.user); 
                        const element = createMessageElement(data.user, data.message, 'private', time, data.to_user);
                        appendMessage(element, 'private', data.user, data.to_user);

                    } else if (data.type === "count") {
                        onlineCountDiv.textContent = `åœ¨çº¿äººæ•°: ${data.data}`;
                        updateOnlineUsersList(data.users);
                        
                    } else if (data.type === "file") {
                        addFileLink(data.user, data.filename, data.file_data, time);

                    } else if (data.type === "history") {
                        const startElement = createMessageElement("ç³»ç»Ÿ", "--- åŠ è½½å†å²æ¶ˆæ¯ ---", "info");
                        appendMessage(startElement, 'info', "ç³»ç»Ÿ");
                        data.messages.forEach(msg => {
                            const element = createMessageElement(msg.user, msg.message, "chat", msg.time);
                            appendMessage(element, 'chat', msg.user);
                        });
                        const endElement = createMessageElement("ç³»ç»Ÿ", "--- å†å²æ¶ˆæ¯åŠ è½½å®Œæ¯• ---", "info");
                        appendMessage(endElement, 'info', "ç³»ç»Ÿ");
                        
                    } else if (data.type === "typing_notification") {
                        const user = data.user;
                        const status = data.is_typing;
                        typingUsers[user] = status;
                        if (!status) { delete typingUsers[user]; }
                        updateTypingIndicator();
                    }

                } catch (e) {
                    console.error("è§£ææ¶ˆæ¯å¤±è´¥:", e);
                }
            };
        }
        
        window.onload = connect;

        // --- æ ‡ç­¾é¡µç®¡ç† ---

        function switchChatTab(tabName) {
            if (activeTab === tabName) return;

            activeTab = tabName;
            messagesDiv.innerHTML = ''; 

            const publicBtn = document.getElementById('publicTabBtn');
            const privateBtn = document.getElementById('privateTabBtn');
            const statusDiv = document.getElementById('privateChatStatus');

            if (tabName === 'public') {
                publicBtn.style.backgroundColor = '#28a745';
                privateBtn.style.backgroundColor = '#ccc';
                privateBtn.style.color = '#666';
                statusDiv.style.display = 'none';
                publicMessages.forEach(msg => messagesDiv.appendChild(msg));

            } else if (tabName === 'private' && privateChatTarget) {
                publicBtn.style.backgroundColor = '#ccc';
                privateBtn.style.backgroundColor = '#dc3545';
                privateBtn.style.color = 'white';
                statusDiv.style.display = 'block';
                document.getElementById('privateTargetUser').textContent = privateChatTarget;

                const convos = privateConversations[privateChatTarget] || [];
                convos.forEach(msg => messagesDiv.appendChild(msg));
            }
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•° (æ¶ˆæ¯åˆ›å»ºå’Œå­˜å‚¨) ---

        function createMessageElement(user, message, type, time, targetUser = null) {
            const messageItem = document.createElement("div");
            messageItem.classList.add("message-item");
            messageItem.classList.add(type);

            let timeString = '';
            if (time) {
                try {
                    const date = new Date(time);
                    timeString = `<span class="timestamp">${date.toLocaleTimeString()}</span>`;
                } catch (e) { timeString = ''; }
            }
            
            if (type === 'private') {
                const myUser = usernameInput.value.trim();
                const sender = user === myUser ? 'æ‚¨' : user;
                const receiver = targetUser === myUser ? 'æ‚¨' : targetUser;
                messageItem.innerHTML = `<span class="user-private">[${sender} &rarr; ${receiver}]:</span> ${message} ${timeString}`;
            } else {
                messageItem.innerHTML = `<span class="user">${user}</span>: ${message} ${timeString}`;
            }
            return messageItem;
        }

        function appendMessage(element, type, fromUser, toUser = null) {
            const myUser = usernameInput.value.trim();

            if (type === 'chat' || type === 'info' || type === 'error') {
                publicMessages.push(element);
                if (activeTab === 'public') { messagesDiv.appendChild(element); }
            } else if (type === 'private') {
                const otherUser = (fromUser === myUser) ? toUser : fromUser;
                
                if (!privateConversations[otherUser]) { privateConversations[otherUser] = []; }
                privateConversations[otherUser].push(element);

                if (activeTab === 'private' && privateChatTarget === otherUser) { messagesDiv.appendChild(element); }
            }

            if ((activeTab === 'public' && (type === 'chat' || type === 'info' || type === 'error')) || 
                (activeTab === 'private' && type === 'private' && (fromUser === privateChatTarget || toUser === privateChatTarget))) {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }
        
        // --- äº¤äº’åŠŸèƒ½å‡½æ•° ---

        function initiatePrivateChat(targetUser) {
            if (usernameInput.value.trim() === targetUser) {
                const element = createMessageElement("ç³»ç»Ÿ", "ä¸èƒ½å’Œè‡ªå·±ç§èŠã€‚", "error");
                appendMessage(element, 'error', "ç³»ç»Ÿ");
                return;
            }
            
            privateChatTarget = targetUser;
            const privateBtn = document.getElementById('privateTabBtn');
            privateBtn.disabled = false;
            privateBtn.textContent = `ç§èŠ (${targetUser})`;
            
            switchChatTab('private');
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            const user = usernameInput.value.trim();

            if (!message || !user || socket.readyState !== WebSocket.OPEN) { 
                console.error("æ— æ³•å‘é€æ¶ˆæ¯ï¼šè¿æ¥æœªæ‰“å¼€æˆ–æ¶ˆæ¯ä¸ºç©ºã€‚");
                return; 
            }
            
            if (isTyping) { sendTypingStatus(false); }

            if (activeTab === 'public') {
                // å…¬èŠï¼šå‘é€ 'public_chat' å’Œ 'message' å­—æ®µ
                const chat_data = JSON.stringify({ 
                    type: "public_chat", 
                    user: user, 
                    message: message 
                });
                socket.send(chat_data);

            } else if (activeTab === 'private' && privateChatTarget) {
                // ç§èŠï¼šå‘é€ 'private_transfer' å’Œ 'message' å­—æ®µ
                const private_data = JSON.stringify({ 
                    type: "private_transfer", 
                    from_user: user, 
                    to_user: privateChatTarget, 
                    message: message 
                });
                socket.send(private_data);
                
                // ç«‹å³æ¸²æŸ“è‡ªå·±çš„ç§èŠæ¶ˆæ¯ (æœ¬åœ°æ˜¾ç¤º)
                const now = new Date().toISOString();
                const element = createMessageElement(user, message, 'private', now, privateChatTarget);
                appendMessage(element, 'private', user, privateChatTarget);
            }
            
            messageInput.value = '';
        }

        function updateOnlineUsersList(users) {
            onlineUsersListDiv.innerHTML = ''; 
            const currentUser = usernameInput.value.trim();
            
            users.forEach(user => {
                const item = document.createElement('div');
                item.classList.add('online-user-item');

                const indicator = document.createElement('span');
                indicator.classList.add('online-indicator');
                item.appendChild(indicator);
                
                const nameText = document.createElement('span');
                
                if (user === currentUser) {
                    nameText.textContent = `${user} (æ‚¨)`;
                    item.style.fontWeight = 'bold';
                    item.style.color = 'green';
                    item.style.cursor = 'default';
                } else {
                    nameText.textContent = user;
                    item.onclick = () => { initiatePrivateChat(user); };
                }
                
                item.appendChild(nameText);
                onlineUsersListDiv.appendChild(item);
            });
        }
        
        function enableFileSend() {
            sendFileBtn.disabled = (fileInput.files.length === 0);
        }
        
        function sendFile() {
             const file = fileInput.files[0];
             const user = usernameInput.value.trim();
        
             if (!file || socket.readyState !== WebSocket.OPEN) {
                 const element = createMessageElement("ç³»ç»Ÿ", "è¯·å…ˆé€‰æ‹©æ–‡ä»¶æˆ–æ£€æŸ¥è¿æ¥çŠ¶æ€ã€‚", "info");
                 appendMessage(element, 'info', "ç³»ç»Ÿ");
                 return;
             }
             if (file.size > 5 * 1024 * 1024) { 
                 const element = createMessageElement("ç³»ç»Ÿ", "æ–‡ä»¶è¿‡å¤§ï¼Œå½“å‰ç¤ºä¾‹ä»…æ”¯æŒ 5MB ä»¥ä¸‹çš„æ–‡ä»¶ã€‚", "error");
                 appendMessage(element, 'error', "ç³»ç»Ÿ");
                 return;
             }
        
             const reader = new FileReader();
             
             reader.onload = function(event) {
                 const fileDataObject = {
                     type: "file_transfer",
                     user: user,
                     filename: file.name,
                     file_type: file.type,
                     file_data: event.target.result 
                 };
                 
                 socket.send(JSON.stringify(fileDataObject));
                 
                 fileInput.value = ''; 
                 enableFileSend(); 
             };
        
             reader.readAsDataURL(file);
        }

        function addFileLink(user, filename, fileData, time) {
            const fileElement = createMessageElement(user, "", "file", time); 
            fileElement.classList.add("file-transfer");

            const link = document.createElement('a');
            link.href = fileData; 
            link.download = filename; 
            link.textContent = `ç‚¹å‡»ä¸‹è½½æ–‡ä»¶: ${filename}`;
            link.style.fontWeight = 'bold';
            
            fileElement.innerHTML = `<span class="user">${user}</span> å‘é€äº†ä¸€ä¸ªæ–‡ä»¶: `;
            fileElement.appendChild(link);
            fileElement.innerHTML += ` <span class="timestamp">${new Date(time).toLocaleTimeString()}</span>`;

            publicMessages.push(fileElement);
            if (activeTab === 'public') {
                messagesDiv.appendChild(fileElement);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        // --- è¡¨æƒ…ç¬¦å·åŠŸèƒ½ ---
        function toggleEmojiPicker() {
             emojiPicker.style.display = (emojiPicker.style.display === 'block') ? 'none' : 'block';
             if (emojiPicker.style.display === 'none') { messageInput.focus(); }
        }
        function insertEmoji(emoji) {
            const input = messageInput;
            const start = input.selectionStart;
            const end = input.selectionEnd;
            input.value = input.value.substring(0, start) + emoji + input.value.substring(end);
            input.selectionStart = input.selectionEnd = start + emoji.length;
            input.focus();
        }
        messageInput.addEventListener('focus', () => { emojiPicker.style.display = 'none'; });

        // --- è¾“å…¥çŠ¶æ€åŠŸèƒ½ ---
        function sendTypingStatus(status) {
            if (socket.readyState === WebSocket.OPEN) {
                const statusMessage = { type: "typing_status", is_typing: status };
                socket.send(JSON.stringify(statusMessage));
                isTyping = status;
            }
        }
        function handleInputDetection() {
            if (!isTyping) { sendTypingStatus(true); }
            if (typingTimeout) { clearTimeout(typingTimeout); }
            typingTimeout = setTimeout(() => { sendTypingStatus(false); }, 1500);
        }
        messageInput.addEventListener('input', handleInputDetection);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && isTyping) { sendTypingStatus(false); }
        });

        function updateTypingIndicator() {
            const usersTyping = Object.keys(typingUsers).filter(user => typingUsers[user]);
            if (usersTyping.length === 0) {
                typingIndicatorDiv.textContent = '';
            } else if (usersTyping.length === 1) {
                typingIndicatorDiv.textContent = `${usersTyping[0]} æ­£åœ¨è¾“å…¥...`;
            } else {
                typingIndicatorDiv.textContent = `${usersTyping.join(', ')} æ­£åœ¨è¾“å…¥...`;
            }
        }

        // --- å®ç”¨å·¥å…· ---
        function refreshPage() { window.location.reload(); }
        
        messageInput.addEventListener("keypress", function(event) {
            if (event.key === "Enter") { sendMessage(); }
        });
    </script>

</body>
</html>

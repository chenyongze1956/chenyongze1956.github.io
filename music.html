
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --player-bg-dark: #2a2a2a;
            --player-bg-light: #4c4c4c;
            --button-bg-color: #6a6a6a;
            --button-active-color: #929292;
            --led-color: #ff4500;
            --tape-window-bg: #1c1c1c;
            --tape-reel-color: #333;
            --accent-color: #007bff;
            --font-pixel: 'Press Start 2P', cursive;
            --font-regular: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        body {
            font-family: var(--font-regular);
            background: linear-gradient(45deg,#ff7e5f,#feb47b,#ffed86,#9feb8f,#5fbfff,#9b8eff);
            display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; overflow: hidden;
        }
        .cassette-player {
            background: linear-gradient(45deg,#ff7e5f,#feb47b,#ffed86,#9feb8f,#5fbfff,#9b8eff);            border-radius: 15px; padding: 25px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5), inset 0 -5px 10px rgba(0, 0, 0, 0.6);
            width: 90%; max-width: 500px; text-align: center; border: 2px solid #555; position: relative;
        }
        .player-header h1 { 
            font-family: var(--font-pixel); color: #eee; font-size: 1.2rem; 
            text-shadow: 2px 2px 5px #000; margin-bottom: 20px; min-height: 1.5rem;
        }
        
        .tape-window {
            background-color: var(--tape-window-bg);
            border: 2px solid #555; border-radius: 5px; height: 120px;
            margin-bottom: 25px; display: flex; justify-content: space-around;
            align-items: center; padding: 10px; position: relative; overflow: hidden;
        }
        #visualizerCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; opacity: 0.5; }
        .tape-reel {
            width: 50px; height: 50px; border-radius: 50%; background: var(--tape-reel-color);
            border: 2px solid #666; position: relative; z-index: 2;
        }
        .tape-reel.playing { animation: rotateReel 2s linear infinite; }
        @keyframes rotateReel { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        #timeDisplay {
            font-family: var(--font-pixel); color: var(--led-color); background: #0d0d0d;
            padding: 8px 12px; margin-bottom: 20px; border-radius: 4px; font-size: 0.9rem;
            display: inline-block; box-shadow: inset 0 0 8px rgba(255, 69, 0, 0.5);
        }

        .player-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .control-btn { 
            padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; 
            color: #fff; background: #555; transition: 0.2s; box-shadow: 0 4px 0 #222;
        }
        .control-btn:active { transform: translateY(3px); box-shadow: 0 1px 0 #222; }
        #playBtn { background: #28a745; }
        #pauseBtn { background: #ffc107; color: #333; }
        #stopBtn { background: #dc3545; }

        .slider-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; color: #ccc; font-size: 0.8rem; }
        input[type="range"] { flex: 1; cursor: pointer; accent-color: var(--accent-color); }
        input[type="file"] { display: none; }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; padding: 10px 20px; border-radius: 20px; display: none; z-index: 100; }
    </style>
</head>
<body>

<div class="cassette-player">
    <div class="player-header"><h1 id="currentTrackTitle">READY</h1></div>
    <div class="tape-window">
        <canvas id="visualizerCanvas"></canvas>
        <div class="tape-reel left"></div>
        <div style="width: 40%; height: 10px; background: #333; z-index: 2; border-radius: 2px;"></div>
        <div class="tape-reel right"></div>
    </div>
    <div id="timeDisplay">00:00 / 00:00</div>
    <input type="file" id="localFileInput" accept="audio/*">
    <button onclick="document.getElementById('localFileInput').click()" class="control-btn" style="width:100%; background: #4a4a4a; margin-bottom: 10px;">ğŸ“‚ æ‰“å¼€æœ¬åœ°æ–‡ä»¶</button>
    <audio id="audioPlayer"></audio>
    <div class="player-buttons">
        <button id="playBtn" class="control-btn">â–¶ æ’­æ”¾</button>
        <button id="pauseBtn" class="control-btn">â¸ æš‚åœ</button>
        <button id="stopBtn" class="control-btn">â–  åœæ­¢</button>
    </div>
    <div class="sliders-group">
        <div class="slider-wrapper"><label>è¿›åº¦</label><input type="range" id="progressBar" value="0"></div>
        <div class="slider-wrapper"><label>éŸ³é‡</label><input type="range" id="volumeSlider" value="100"></div>
    </div>
</div>
<div id="toast"></div>

<script>
    const audio = document.getElementById('audioPlayer');
    const canvas = document.getElementById('visualizerCanvas');
    const ctx = canvas.getContext('2d');
    const trackTitle = document.getElementById('currentTrackTitle');
    
    let audioCtx, analyser, source, dataArray, hissNode, hissGain;

    // --- ğŸ”Š éŸ³æ•ˆåˆæˆé€»è¾‘ ---
    
    // 1. åˆæˆæœºæ¢°æŒ‰é”®éŸ³ "Click"
    function playClickSound() {
        if (!audioCtx) initAudioContext();
        const osc = audioCtx.createOscillator();
        const clickGain = audioCtx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
        clickGain.gain.setValueAtTime(0.3, audioCtx.currentTime);
        clickGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.connect(clickGain);
        clickGain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);
    }

    // 2. åˆæˆç£å¸¦åº•å™ª "Tape Hiss" (ç™½å™ªå£°)
    function createHiss() {
        const bufferSize = 2 * audioCtx.sampleRate,
        noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate),
        output = noiseBuffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) {
            output[i] = Math.random() * 2 - 1;
        }
        hissNode = audioCtx.createBufferSource();
        hissNode.buffer = noiseBuffer;
        hissNode.loop = true;
        hissGain = audioCtx.createGain();
        hissGain.gain.value = 0; // é»˜è®¤é™éŸ³
        hissNode.connect(hissGain);
        hissGain.connect(audioCtx.destination);
        hissNode.start();
    }

    function setHiss(volume) {
        if (hissGain) hissGain.gain.setTargetAtTime(volume, audioCtx.currentTime, 0.1);
    }

    // --- æ ¸å¿ƒé€»è¾‘ ---
    function initAudioContext() {
        if (audioCtx) return;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        source = audioCtx.createMediaElementSource(audio);
        source.connect(analyser);
        analyser.connect(audioCtx.destination);
        analyser.fftSize = 128;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        createHiss();
        draw();
    }

    function draw() {
        requestAnimationFrame(draw);
        const WIDTH = canvas.width = canvas.offsetWidth;
        const HEIGHT = canvas.height = canvas.offsetHeight;
        if (analyser) analyser.getByteFrequencyData(dataArray);
        ctx.clearRect(0, 0, WIDTH, HEIGHT);
        const barWidth = (WIDTH / dataArray.length) * 2.5;
        let x = 0;
        for (let i = 0; i < dataArray.length; i++) {
            const barHeight = (dataArray[i] / 255) * HEIGHT;
            ctx.fillStyle = `rgb(${barHeight+50}, 150, 255)`;
            ctx.fillRect(x, HEIGHT - barHeight, barWidth, barHeight);
            x += barWidth + 1;
        }
    }

    document.getElementById('playBtn').onclick = () => {
        if (!audio.src) return showToast("è¯·å…ˆé€‰æ‹©æœ¬åœ°æ–‡ä»¶");
        playClickSound();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        audio.play();
        setHiss(0.02); // å¼€å¯è½»å¾®åº•å™ª
        document.querySelectorAll('.tape-reel').forEach(r => r.classList.add('playing'));
    };

    document.getElementById('pauseBtn').onclick = () => {
        playClickSound();
        audio.pause();
        setHiss(0); // å…³é—­åº•å™ª
        document.querySelectorAll('.tape-reel').forEach(r => r.classList.remove('playing'));
    };

    document.getElementById('stopBtn').onclick = () => {
        playClickSound();
        audio.pause(); audio.currentTime = 0;
        setHiss(0);
        document.querySelectorAll('.tape-reel').forEach(r => r.classList.remove('playing'));
    };

    document.getElementById('localFileInput').onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            playClickSound();
            audio.src = URL.createObjectURL(file);
            trackTitle.innerText = file.name.toUpperCase();
        }
    };

    audio.ontimeupdate = () => {
        if (isNaN(audio.duration)) return;
        document.getElementById('progressBar').value = (audio.currentTime / audio.duration) * 100;
        document.getElementById('timeDisplay').innerText = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;
    };

    document.getElementById('progressBar').oninput = (e) => {
        if (audio.duration) audio.currentTime = (e.target.value / 100) * audio.duration;
    };

    document.getElementById('volumeSlider').oninput = (e) => {
        audio.volume = e.target.value / 100;
    };

    function formatTime(s) {
        const m = Math.floor(s / 60); const sec = Math.floor(s % 60);
        return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }
</script>
</body>
</html>

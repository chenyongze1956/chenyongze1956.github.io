<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* æ²‰æµ¸å¼åŠ¨æ€èƒŒæ™¯ */
        body {
            margin: 0; padding: 0; width: 100vw; height: 100vh;
            background: linear-gradient(45deg,#ff7e5f,#feb47b,#ffed86,#9feb8f,#5fbfff,#9b8eff);
            background-size: cover; background-position: center;
            font-family: 'Segoe UI', system-ui, sans-serif;
            display: flex; align-items: center; justify-content: center; color: #fff;
            transition: background 0.8s ease; 
        }
        .container {
            width: 90%; max-width: 450px; background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(25px); padding: 30px; border-radius: 28px;
            border: 1px solid rgba(255, 255, 255, 0.1); text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            max-height: 90vh; overflow-y: auto;
        }
        .search-box { display: flex; gap: 10px; margin-bottom: 10px; }
        input[type="text"] {
            flex: 1; padding: 14px; border-radius: 12px; border: 1px solid #444;
            background: rgba(0,0,0,0.5); color: #fff; outline: none; font-size: 1rem;
        }
        button {
            padding: 0 20px; background: #e94560; color: white; border: none;
            border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        button:hover { background: #ff5e78; transform: scale(1.05); }

        /* æœç´¢å†å²æ ·å¼ */
        .history-container { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; justify-content: center; }
        .history-tag { 
            padding: 4px 12px; background: rgba(255,255,255,0.1); border-radius: 20px; 
            font-size: 0.75rem; cursor: pointer; transition: 0.2s; 
        }
        .history-tag:hover { background: #e94560; }

        #resultArea { background: rgba(255,255,255,0.05); border-radius: 20px; padding: 20px; text-align: left; display: none; }
        .rating { color: #f1c40f; font-weight: bold; font-size: 1.2rem; }
        .desc { font-size: 0.85rem; color: #ddd; line-height: 1.6; margin: 15px 0; max-height: 100px; overflow-y: auto; }
        
        /* æ’­æ”¾æºæ ·å¼ */
        .section-box { margin-bottom: 15px; padding: 12px; border-radius: 12px; background: rgba(255,255,255,0.05); }
        .section-title { font-size: 0.8rem; color: #00d2ff; font-weight: bold; margin-bottom: 10px; }
        .icon-list { display: flex; gap: 10px; flex-wrap: wrap; }
        .provider-img { width: 35px; height: 35px; border-radius: 8px; transition: 0.2s; }
        .provider-img:hover { transform: scale(1.1); }

        .quick-btn { 
            padding: 5px 12px; border-radius: 6px; font-size: 0.7rem; 
            text-decoration: none; color: white; font-weight: bold; transition: 0.2s;
        }
        .quick-btn:hover { opacity: 0.8; transform: translateY(-2px); }

        .cast-scroll { display: flex; overflow-x: auto; gap: 12px; scrollbar-width: none; }
        .cast-item { flex: 0 0 60px; text-align: center; font-size: 0.7rem; }
        .cast-img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(233, 69, 96, 0.4); }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color: #e94560; margin-top: 0;">ğŸ¬ å½±è¿·ç™¾ç§‘æœç´¢</h2>
    <div class="search-box">
        <input type="text" id="keywordInput" placeholder="è¾“å…¥å½±è§†å‰§ã€åŠ¨æ¼«åç§°...">
        <button id="searchBtn">æœç´¢</button>
    </div>
    <div class="history-container" id="historyContainer"></div>

    <div id="resultArea">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <b id="mTitle" style="font-size: 1.3rem;"></b>
            <span id="mRating" class="rating"></span>
        </div>
        <div id="mYear" style="font-size: 0.75rem; color: #888; margin-top: 4px;"></div>
        <p id="mDesc" class="desc"></p>

        <div class="section-box">
            <div class="section-title">ğŸ”— å¿«é€Ÿç›´è¾¾æœç´¢</div>
            <div class="icon-list" id="quickLinkList"></div>
        </div>

        <div id="providerSection" class="section-box" style="display: none;">
            <div class="section-title">ğŸ“º è§†é¢‘æºè¯¦æƒ… (ç‚¹æ’­/ç§Ÿèµ)</div>
            <div class="icon-list" id="providerList"></div>
        </div>
        
        <div style="font-size: 0.85rem; color: #e94560; font-weight: bold; margin-bottom: 10px;">ğŸŒŸ é¢†è¡”ä¸»æ¼”</div>
        <div class="cast-scroll" id="castList"></div>
    </div>
</div>

<script>
    const TMDB_KEY = 'a2a3fdd1a00d32cca3550a8884a82327';
    const keywordInput = document.getElementById('keywordInput');
    const searchBtn = document.getElementById('searchBtn');
    const historyContainer = document.getElementById('historyContainer');

    // åŠ è½½æœç´¢å†å²
    let searchHistory = JSON.parse(localStorage.getItem('search_history')) || [];

    function renderHistory() {
        historyContainer.innerHTML = '';
        searchHistory.forEach(item => {
            const span = document.createElement('span');
            span.className = 'history-tag';
            span.innerText = item;
            span.onclick = () => {
                keywordInput.value = item;
                startSearch();
            };
            historyContainer.appendChild(span);
        });
    }

    searchBtn.onclick = startSearch;
    keywordInput.onkeypress = (e) => e.key === 'Enter' && startSearch();

    async function startSearch() {
        const kw = keywordInput.value.trim();
        if (!kw) return;
        
        searchBtn.innerText = "...";
        searchBtn.disabled = true;

        // ä¿å­˜å†å²é€»è¾‘
        if (!searchHistory.includes(kw)) {
            searchHistory.unshift(kw);
            if (searchHistory.length > 5) searchHistory.pop();
            localStorage.setItem('search_history', JSON.stringify(searchHistory));
            renderHistory();
        }

        try {
            const resp = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${TMDB_KEY}&query=${encodeURIComponent(kw)}&language=zh-CN`);
            const data = await resp.json();
            if (data.results && data.results.length > 0) {
                await showResult(data.results[0]);
            } else {
                alert("æœªæ‰¾åˆ°å†…å®¹");
            }
        } catch (e) {
            alert("ç½‘ç»œå¼‚å¸¸");
        } finally {
            searchBtn.innerText = "æœç´¢";
            searchBtn.disabled = false;
        }
    }

    async function showResult(item) {
        const resultArea = document.getElementById('resultArea');
        resultArea.style.display = 'block';

        // 1. è®¾ç½®èƒŒæ™¯å›¾
        if (item.backdrop_path) {
            document.body.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url('https://image.tmdb.org/t/p/original${item.backdrop_path}')`;
        }

        const title = item.title || item.name;
        document.getElementById('mTitle').innerText = title;
        document.getElementById('mRating').innerText = "â˜… " + (item.vote_average || 0).toFixed(1);
        document.getElementById('mYear').innerText = "ğŸ“… " + (item.release_date || item.first_air_date || "å¹´ä»½æœªçŸ¥");
        document.getElementById('mDesc').innerText = item.overview || "æš‚æ— ç®€ä»‹ã€‚";

        const type = item.media_type === 'tv' ? 'tv' : 'movie';

        // 2. å¿«æ·æœç´¢é“¾æ¥
        const quickLinkList = document.getElementById('quickLinkList');
        quickLinkList.innerHTML = '';
        const platforms = [
            { name: 'è…¾è®¯', url: 'https://v.qq.com/x/search/?q=', color: '#ff5c24' },
            { name: 'çˆ±å¥‡è‰º', url: 'https://www.iqiyi.com/search/', color: '#00d015' },
            { name: 'Bç«™', url: 'https://search.bilibili.com/all?keyword=', color: '#fb7299' },
            { name: 'è±†ç“£', url: 'https://www.douban.com/search?q=', color: '#007722' }
        ];
        platforms.forEach(p => {
            const a = document.createElement('a');
            a.href = p.url + encodeURIComponent(title);
            a.target = "_blank";
            a.className = "quick-btn";
            a.style.background = p.color;
            a.innerText = p.name;
            quickLinkList.appendChild(a);
        });

        // 3. è·å–ç‚¹æ’­æº
        const pResp = await fetch(`https://api.themoviedb.org/3/${type}/${item.id}/watch/providers?api_key=${TMDB_KEY}`);
        const pData = await pResp.json();
        const regionData = pData.results?.CN || pData.results?.US; // ä¼˜å…ˆå›½å†…ï¼Œæ¬¡é€‰ç¾åŒº
        
        const providerSection = document.getElementById('providerSection');
        const providerList = document.getElementById('providerList');
        providerList.innerHTML = '';

        if (regionData) {
            const all = [...(regionData.flatrate || []), ...(regionData.rent || []), ...(regionData.buy || [])];
            const unique = Array.from(new Map(all.map(p => [p.provider_id, p])).values());
            if (unique.length > 0) {
                providerSection.style.display = 'block';
                unique.forEach(p => {
                    const a = document.createElement('a');
                    a.href = regionData.link;
                    a.target = "_blank";
                    const img = document.createElement('img');
                    img.className = 'provider-img';
                    img.src = `https://image.tmdb.org/t/p/original${p.logo_path}`;
                    img.title = p.provider_name;
                    a.appendChild(img);
                    providerList.appendChild(a);
                });
            } else { providerSection.style.display = 'none'; }
        } else { providerSection.style.display = 'none'; }

        // 4. æ¼”å‘˜
        const cResp = await fetch(`https://api.themoviedb.org/3/${type}/${item.id}/credits?api_key=${TMDB_KEY}&language=zh-CN`);
        const cData = await cResp.json();
        const list = document.getElementById('castList');
        list.innerHTML = '';
        cData.cast.slice(0, 8).forEach(p => {
            const div = document.createElement('div');
            div.className = 'cast-item';
            const imgUrl = p.profile_path ? 'https://image.tmdb.org/t/p/w200' + p.profile_path : 'https://via.placeholder.com/50';
            div.innerHTML = `<img src="${imgUrl}" class="cast-img"><div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.name}</div>`;
            list.appendChild(div);
        });
    }

    // åˆå§‹æ¸²æŸ“å†å²è®°å½•
    renderHistory();
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Terminal CLI (全功能)</title>
    <style>
         @keyframes rainbow-color-change {
            0%, 100% { color: #ff0000; } /* Red */
            14% { color: #ff8b00; } /* Orange */
            28% { color: #e8ff00; } /* Yellow */
            42% { color: #5dff00; } /* Green */
            56% { color: #00b9ff; } /* Blue */
            70% { color: #5d00ff; } /* Indigo */
            84% { color: #e800ff; } /* Violet */
        }
        /* CSS Reset and Global Styles */
        * {
            box-sizing: border-box;
        }
        :root {
            --terminal-bg: #000000;
            --terminal-text: #00ff00; /* Bright Green */
            --prompt-color: #00ffff; /* Cyan for the prompt text */
            --dir-color: #33ccff; /* Blue for directories */
            --file-color: #ffffff; /* White for files */
            --terminal-width-desktop: 800px;
            --terminal-height-desktop: 600px;
            --font-size-desktop: 1rem;
            --font-size-mobile: 0.9rem;
        }
        body {
            background: linear-gradient(45deg,#ff7e5f,#feb47b,#ffed86,#9feb8f,#5fbfff,#9b8eff);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            font-family: Comic Sans MS, cursive, sans-serif;
            color: var(--terminal-text);
            font-size: var(--font-size-desktop);
            animation: rainbow-color-change 3s linear infinite alternate;
        }
        /* --- 终端容器 --- */
        #terminal-container {
            position: relative; 
            background-color: var(--terminal-bg);
            width: 100%;
            max-width: var(--terminal-width-desktop);
            height: 100vh; 
            max-height: var(--terminal-height-desktop); 
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;         
        }
        /* --- 输出区域 --- */
        #output {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            line-height: 1.4;
            white-space: pre-wrap; 
            word-break: break-all;
            position: relative; 
            z-index: 2; 
        }
        /* Custom Scrollbar for better retro look */
        #output::-webkit-scrollbar {
            width: 8px;
        }
        #output::-webkit-scrollbar-track {
            background: #222;
        }
        #output::-webkit-scrollbar-thumb {
            background: #004d00;
            border-radius: 4px;
        }
        #output::-webkit-scrollbar-thumb:hover {
            background: var(--terminal-text);
        }                        
        /* --- 输入行 --- */
        #input-line {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-top: 1px solid #004d00;
            flex-shrink: 0; 
            position: relative;
            z-index: 3; 
        }
        #prompt {
            color: var(--prompt-color);
            margin-right: 8px;
            flex-shrink: 0;
            transition: color 0.3s;
        }
        #commandInput {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: var(--terminal-text);
            font-family: inherit;
            font-size: inherit;
            outline: none;
            caret-color: var(--terminal-text); 
            padding: 0;
            margin: 0;
        }                        
        /* --- 输出行样式 --- */
        .output-line {
            margin: 0;
        }
        .output-line span {
            color: var(--prompt-color);         
        }
        .error {
            color: #ff4500; 
        }
        .welcome {
            color: #ffff00; 
            margin-bottom: 10px;
        }
        .dir {
            color: var(--dir-color);
            font-weight: bold;
        }                        
        .file {
            color: var(--file-color);
        }
        .output-line img {
            max-width: 100%; 
            height: auto; 
            margin-top: 10px; 
            border: 1px solid #00ff00; 
            display: block; 
        }
        #sl-train-animation, #gifwrap-animation, #gkrellm-monitor, #cbonsai-animation {
            white-space: pre;
            font-family: monospace; 
        }

        /* --- XSNOW 样式和动画 (深度修正) --- */
        #xsnow-container {
            z-index: 1; 
        }
        @keyframes fall {
            0% { 
                transform: translateY(0) translateX(0) rotate(0deg); 
            }
            50% { 
                transform: translateY(50vh) translateX(5vw); 
            }
            100% { 
                /* 确保雪花降落覆盖整个视口高度 */
                transform: translateY(105vh) translateX(0) rotate(360deg); 
            }
        }
        .snowflake {
            animation-name: fall;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
            animation-direction: normal;
            animation-fill-mode: forwards;
            position: absolute; 
        }

        /* --- 移动端优化 --- */
        @media (max-width: 768px) {
            body {
                font-size: var(--font-size-mobile);
                padding: 0;
            }
            #terminal-container {
                border-radius: 0;
                height: 100vh; 
            }
            #output {
                padding: 10px;
            }
            #input-line {
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <div id="terminal-container">
        <div id="output">
        </div>
        <div id="input-line">
            <span id="prompt">user@web-cli:~$</span>
            <input type="text" id="commandInput" autofocus>
        </div>
    </div>
    <script>
        const output = document.getElementById('output');
        const input = document.getElementById('commandInput');
        const promptSpan = document.getElementById('prompt');
        const initialPromptText = "user@web-cli:";
        const CLI_USER = 'web-cli-user';
                        
        let history = [];
        let historyIndex = -1;
        let currentPath = '/home/user'; 
        
        // --- 全局定时器 ID ---
        let gkrellmIntervalId = null; 
        let gifwrapIntervalId = null; 
        let slIntervalId = null; 
        let xsnowIntervalId = null; 
        let cbonsaiIntervalId = null; 
        let pingIntervalId = null; // 新增 ping 定时器
        // ----------------------
                        
        // --- 全局数据 (Fortunes, fileSystem, etc.) ---        
        const fortunes = [
            "知者不言，言者不知。",
            "人生就像一盒巧克力，你永远不知道下一块会是什么味道。",
            "重要的不是你站的位置，而是你朝向的方向。",
            "我们最大的荣耀不在于永不跌倒，而在于每次跌倒后都能站起来。",
            "衡量一个人幸福与否的标准，不是他拥有什么，而是他对失去的恐惧程度。",
            "自然是一座神殿，那里活的支柱 / 有时吐出混乱的语言； / 人行走在符号的森林中， / 符号用熟悉的目光观察他。",
            "一切都在改变，没有事物消亡。",
            "梦想是注定孤独的旅行，路上少不了质疑和嘲笑。",
            "工资就像方便面，加量不加价。"
        ];
        const fileSystem = {
            name: '/',
            type: 'dir',
            contents: {
                'home': {
                    name: 'home', type: 'dir', contents: {
                        'user': {
                            name: 'user', type: 'dir', contents: {
                                'Documents': { name: 'Documents', type: 'dir', contents: {} },
                                'Images': { name: 'Images', type: 'dir', contents: {} },
                                'music.mp3': { name: 'music.mp3', type: 'file' },
                                'README.txt': { name: 'README.txt', type: 'file' }
                            }
                        }
                    }
                },
                'etc': { name: 'etc', type: 'dir', contents: { 'hosts': { name: 'hosts', type: 'file' } } },
                'bin': { name: 'bin', type: 'dir', contents: {} }
            }
        };
                
        // --- 辅助函数 ---        
        function getDirNode(path) {
            let parts = path.split('/').filter(p => p.length > 0);
            let currentNode = fileSystem;                        
            
            for (const part of parts) {
                if (currentNode.contents && currentNode.contents[part]) {
                    currentNode = currentNode.contents[part];
                } else {
                    return null;                                 
                }
            }
            return currentNode;
        }

        function getCurrentDirNode() {
            return getDirNode(currentPath);
        }

        function updatePrompt() {
            promptSpan.innerText = `${initialPromptText}${currentPath}~$`;
        }                
        
        function writeOutput(text, className = 'output-text') {
            const lines = text.split('\n');
            lines.forEach(line => {
                const p = document.createElement('p');
                p.className = `output-line ${className}`;
                p.textContent = line;
                output.appendChild(p);
            });
            scrollToBottom();
        }                

        function writeHtmlOutput(htmlContent) {
            const p = document.createElement('p');
            p.className = 'output-line';
            p.innerHTML = htmlContent;
            output.appendChild(p);
            scrollToBottom();
        }

        function writeCommandHistory(commandLine) {
            const p = document.createElement('p');
            p.className = 'output-line';
            p.innerHTML = `<span style="color:var(--prompt-color);">${promptSpan.innerText}</span> ${commandLine}`;
            output.appendChild(p);
        }

        function scrollToBottom() {
            output.scrollTop = output.scrollHeight;
        }
        
        function autoComplete() {
            const fullInput = input.value;
            const parts = fullInput.trim().split(/\s+/);
            const lastPart = parts.pop();
            const prefix = parts.join(' ') + (parts.length > 0 ? ' ' : '');

            // 1. 补全命令本身
            if (parts.length === 0 || (parts.length === 1 && fullInput.endsWith(parts[0]))) {
                const matchingCommands = Object.keys(commands).filter(cmd => cmd.startsWith(fullInput.trim()));

                if (matchingCommands.length === 1) {
                    input.value = matchingCommands[0] + ' ';
                } else if (matchingCommands.length > 1) {
                    writeCommandHistory(fullInput);
                    writeOutput(matchingCommands.join('\t'));
                }
                return;
            }

            // 2. 补全文件/目录 (仅支持当前目录内的相对路径)
            if (lastPart.includes('/') && !lastPart.startsWith('/')) {
                return;
            }

            let searchDir = getCurrentDirNode();
            let searchPrefix = lastPart;
            
            function simpleResolvePath(inputPath) {
                let parts = inputPath.split('/');
                let targetName = parts.pop() || '';
                let parentPath = parts.join('/') || '/';
                return { parentPath, targetName };
            }

            if (lastPart.startsWith('/')) {
                const { parentPath, targetName } = simpleResolvePath(lastPart);
                searchDir = getDirNode(parentPath);
                searchPrefix = targetName;
            }

            if (!searchDir || !searchDir.contents) {
                return; 
            }

            const candidates = Object.keys(searchDir.contents).filter(name => name.startsWith(searchPrefix));
            
            if (candidates.length === 1) {
                const targetName = candidates[0];
                const targetNode = searchDir.contents[targetName];
                let suffix = targetNode.type === 'dir' ? '/' : ' ';
                
                let newValue;
                if (lastPart.startsWith('/')) {
                    newValue = prefix + lastPart.substring(0, lastPart.lastIndexOf('/') + 1) + targetName + suffix;
                } else {
                    newValue = prefix + targetName + suffix;
                }
                input.value = newValue;

            } else if (candidates.length > 1) {
                writeCommandHistory(fullInput);

                let commonPrefix = candidates.reduce((prev, curr) => {
                    let i = 0;
                    while (i < prev.length && i < curr.length && prev[i] === curr[i]) {
                        i++;
                    }
                    return prev.substring(0, i);
                });

                if (commonPrefix.length > searchPrefix.length) {
                    input.value = prefix + commonPrefix;
                } else {
                    const displayList = candidates.map(name => {
                        return searchDir.contents[name].type === 'dir' ? `<span class="dir">${name}/</span>` : name;
                    }).join('&nbsp;&nbsp;&nbsp;');
                    writeHtmlOutput(displayList);
                }
            }
        }


        // --- 核心命令执行 ---                        
        const commands = {
            'help': { description: '显示可用命令列表。', execute: () => {
                    let helpOutput = '可用命令 (总计 ' + Object.keys(commands).length + ' 个):\n';
                    for (const cmd in commands) {
                        helpOutput += `  ${cmd.padEnd(12)} - ${commands[cmd].description}\n`;
                    }
                    writeOutput(helpOutput);
                }
            },
            'clear': { description: '清空终端屏幕。', execute: () => { output.innerHTML = ''; writeWelcome(); } },
            'ls': { description: '列出当前目录内容。', execute: () => {
                    const node = getCurrentDirNode();
                    if (!node || node.type !== 'dir') { writeOutput(`错误: 无法读取目录 ${currentPath}`, 'error'); return; }                                                            
                    const items = Object.values(node.contents).sort((a, b) => {
                        if (a.type === 'dir' && b.type === 'file') return -1;
                        if (a.type === 'file' && b.type === 'dir') return 1;
                        return a.name.localeCompare(b.name);
                    });
                    items.forEach(item => {
                        const typeClass = item.type === 'dir' ? 'dir' : 'file';
                        const name = item.type === 'dir' ? item.name + '/' : item.name;
                        const span = document.createElement('span');
                        span.className = `output-item ${typeClass}`;
                        span.textContent = name;
                        output.appendChild(span);
                        output.innerHTML += '&nbsp;&nbsp;&nbsp;'; 
                    });
                    output.appendChild(document.createElement('br'));
                    scrollToBottom();
                }
            },
            'cd': { description: '切换目录。用法: cd <目录名>', execute: (args) => {
                    const target = args[0];
                    if (!target) { currentPath = '/home/user'; updatePrompt(); return; }
                    let newPath;
                    if (target === '/') { newPath = '/'; } 
                    else if (target.startsWith('/')) { newPath = target; } 
                    else if (target === '..') {
                        if (currentPath === '/') return;
                        newPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
                        if (newPath === '') newPath = '/'; 
                    } else { newPath = currentPath === '/' ? `/${target}` : `${currentPath}/${target}`; }

                    newPath = newPath.replace(/\/\/+/g, '/');
                    const node = getDirNode(newPath);

                    if (!node) { writeOutput(`cd: 目录不存在: ${target}`, 'error'); } 
                    else if (node.type !== 'dir') { writeOutput(`cd: 不是目录: ${target}`, 'error'); } 
                    else {
                        currentPath = newPath.endsWith('/') && newPath.length > 1 ? newPath.slice(0, -1) : newPath;
                        updatePrompt();
                    }
                }
            },
            'fortune': { description: '显示一句随机的箴言或名言。', execute: () => {
                    if (fortunes.length === 0) { writeOutput("fortune: 没有找到任何箴言。", 'error'); return; }
                    const randomIndex = Math.floor(Math.random() * fortunes.length);
                    const quote = fortunes[randomIndex];                                                            
                    const line = '='.repeat(quote.length + 4);
                    writeOutput(`\n${line}`);
                    writeOutput(`| ${quote} |`);
                    writeOutput(`${line}\n`);
                }
            },
            'echo': { description: '在终端上打印文本。', execute: (args) => { writeOutput(args.join(' ')); } },
            'date': { description: '显示当前日期和时间。', execute: () => { writeOutput(new Date().toLocaleString()); } },
            'whoami': { description: '显示当前用户名。', execute: () => { writeOutput(CLI_USER); } },
            
            // --- 文件系统修正命令 ---
            
            'pwd': { 
                description: '打印当前工作目录。', 
                execute: () => { 
                    writeOutput(currentPath); 
                } 
            },
            'touch': { 
                description: '在当前目录或指定路径创建空文件。', 
                execute: (args) => { 
                    if (args.length === 0) { 
                        writeOutput('touch: 缺少文件操作数。', 'error'); 
                        return;
                    }
                    const fileName = args[0];
                    const currentNode = getCurrentDirNode();

                    if (!currentNode || currentNode.type !== 'dir') {
                        writeOutput(`touch: 无法访问: ${fileName}: No such file or directory`, 'error');
                        return;
                    }
                    
                    if (!currentNode.contents[fileName]) {
                        currentNode.contents[fileName] = { name: fileName, type: 'file' };
                    }
                } 
            },
            'mkdir': { 
                description: '创建一个新目录。用法: mkdir <目录名>', 
                execute: (args) => { 
                    if (args.length === 0) { 
                        writeOutput('mkdir: 缺少目录名。', 'error'); 
                        return;
                    }
                    const dirName = args[0];
                    const currentNode = getCurrentDirNode();
                    
                    if (!currentNode || currentNode.type !== 'dir') {
                        writeOutput(`mkdir: 无法访问: ${dirName}: No such file or directory`, 'error');
                        return;
                    }

                    if (currentNode.contents[dirName]) {
                        writeOutput(`mkdir: 目录已存在: ${dirName}`, 'error');
                    } else {
                        currentNode.contents[dirName] = { name: dirName, type: 'dir', contents: {} };
                    }
                } 
            },
            'rmdir': { 
                description: '删除空目录。用法: rmdir <目录名>', 
                execute: (args) => { 
                    if (args.length === 0) { 
                        writeOutput('rmdir: 缺少操作数。', 'error'); 
                        return;
                    }
                    const dirName = args[0];
                    const currentNode = getCurrentDirNode();

                    if (!currentNode || !currentNode.contents[dirName]) {
                        writeOutput(`rmdir: 无法删除 ‘${dirName}’: 目录不存在`, 'error');
                        return;
                    }
                    
                    const targetNode = currentNode.contents[dirName];

                    if (targetNode.type !== 'dir') {
                        writeOutput(`rmdir: 无法删除 ‘${dirName}’: 不是目录`, 'error');
                        return;
                    }
                    
                    if (Object.keys(targetNode.contents).length > 0) {
                        writeOutput(`rmdir: 无法删除 ‘${dirName}’: 目录非空`, 'error');
                    } else {
                        delete currentNode.contents[dirName];
                    }
                } 
            },
            'rm': { 
                description: '删除文件或目录(使用 -r 递归删除)。用法: rm [-r] <文件/目录>', 
                execute: (args) => { 
                    let recursive = false;
                    let targetIndex = 0;

                    if (args[0] === '-r') {
                        recursive = true;
                        targetIndex = 1;
                    }
                    
                    const targetName = args[targetIndex];

                    if (!targetName) {
                        writeOutput('rm: 缺少操作数。', 'error'); 
                        return;
                    }

                    const currentNode = getCurrentDirNode();
                    if (!currentNode || !currentNode.contents[targetName]) {
                        writeOutput(`rm: 无法删除 ‘${targetName}’: 文件或目录不存在`, 'error');
                        return;
                    }
                    
                    const targetNode = currentNode.contents[targetName];

                    if (targetNode.type === 'dir' && !recursive) {
                        writeOutput(`rm: 无法删除 ‘${targetName}’: 是目录 (使用 -r 递归删除)`, 'error');
                        return;
                    }
                    
                    // 模拟删除
                    delete currentNode.contents[targetName];
                } 
            },
            
            'linuxlogo': { description: '显示 logo 和系统信息。', execute: () => { writeOutput(`      /\\ /\\         OS: Web-CLI FunOS\n     ( ◕ ◕ )        Kernel: 5.15.0-js-web\n   <  / ^ \\  >      Uptime: ...\n    \\ \\_/ /       User: ${CLI_USER}\n     '---'        CPU: Browser Core (x86_64)`, 'welcome'); } },

            // --- 网络/多媒体修正命令 ---
            
            'curl': { 
                description: '模拟 HTTP GET 请求。用法: curl <URL> (模拟延迟)', 
                execute: (args) => { 
                    const url = args[0] || 'https://www.example.com';
                    const downloadDelay = 2000; // 模拟下载延迟 2秒
                    
                    writeOutput(`curl ${url}`);
                    writeOutput(`  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                     Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0`);
                    
                    input.disabled = true;
                    promptSpan.innerText = 'CURLING... (等待下载)';
                    promptSpan.style.color = '#00ff40'; 

                    // 创建一个段落用于显示动态进度
                    const updateCurlOutput = document.createElement('p');
                    updateCurlOutput.style.whiteSpace = 'pre';
                    updateCurlOutput.className = 'curl-output';
                    output.appendChild(updateCurlOutput);
                    scrollToBottom();
                    
                    // 模拟下载过程中的输出更新 (分两帧更新)
                    const updateFrames = [
                        ' 50   628   50   628    0     0    314      0 0:00:04 0:00:02 0:00:02   314',
                        ' 80  1004   80  1004    0     0    502      0 0:00:02 0:00:01 0:00:01   502'
                    ];
                    
                    let frameIndex = 0;
                    const updateInterval = setInterval(() => {
                        if (frameIndex < updateFrames.length) {
                             updateCurlOutput.textContent = updateFrames[frameIndex];
                             frameIndex++;
                             scrollToBottom();
                        }
                    }, 500);


                    setTimeout(() => {
                        clearInterval(updateInterval); // 停止进度更新
                        
                        const finalOutput = `
100  1256  100  1256    0     0  28984      0 --:--:-- --:--:-- --:--:-- 28984
<!doctype html>
<html>
<head><title>Example Domain</title>...</head>
<body><h1>Example Domain</h1>...</body>
</html>`;
                        
                        updateCurlOutput.textContent = finalOutput.trim();

                        input.disabled = false;
                        updatePrompt();
                        input.focus();
                        promptSpan.style.color = 'var(--prompt-color)';
                        scrollToBottom();
                    }, downloadDelay);
                } 
            },
            'ping': { 
                description: '测试网络连接。用法: ping <IP/域名> (模拟延迟, Ctrl+C 停止)', 
                execute: (args) => { 
                    if (pingIntervalId !== null) { writeOutput('ping 已经在运行。', 'error'); return; }

                    const host = args[0] || '127.0.0.1';
                    const delay = 1000; // 模拟每秒发送一个包
                    let seq = 0;
                    const maxSeq = 4;
                    
                    writeOutput(`PING ${host} (127.0.0.1) 56(84) bytes of data.`);
                    input.disabled = true;
                    promptSpan.innerText = `PING ${host}... (按 Ctrl+C 停止)`;
                    promptSpan.style.color = '#ff8000'; 

                    const pingPacket = () => {
                        if (seq >= maxSeq) {
                            clearInterval(pingIntervalId);
                            pingIntervalId = null;

                            const stats = `
^C
--- ${host} ping statistics ---
${maxSeq} packets transmitted, ${maxSeq} received, 0% packet loss, time ${maxSeq * delay}ms
rtt min/avg/max/mdev = 0.038/0.041/0.045/0.003 ms
`;
                            writeOutput(stats.trim());
                            
                            input.disabled = false;
                            updatePrompt();
                            input.focus();
                            promptSpan.style.color = 'var(--prompt-color)';
                            return;
                        }

                        const time = (Math.random() * 50 + 30).toFixed(3);
                        writeOutput(`64 bytes from ${host}: icmp_seq=${seq + 1} ttl=64 time=${time} ms`);
                        seq++;
                    };

                    pingIntervalId = setInterval(pingPacket, delay); // 使用全局 ID
                } 
            },
            'ncat': { 
                description: '模拟网络连接和端口扫描。用法: ncat -z <IP> <port>', 
                execute: (args) => { 
                    const target = args[2] || 'localhost';
                    const port = args[3] || '80';
                    writeOutput(`ncat -z ${target} ${port}`);
                    // 模拟网络延迟
                    input.disabled = true;
                    promptSpan.innerText = 'CONNECTING...';
                    promptSpan.style.color = '#ff00ff'; 

                    setTimeout(() => {
                        if (Math.random() > 0.3) {
                             writeOutput(`Ncat: Connected to ${target}:${port}.`);
                        } else {
                             writeOutput(`Ncat: Connection refused.`, 'error');
                        }
                        
                        input.disabled = false;
                        updatePrompt();
                        input.focus();
                        promptSpan.style.color = 'var(--prompt-color)';
                    }, 500);
                } 
            },
            'display': { 
                description: '在终端中模拟显示图像。用法: display [URL]', 
                execute: (args) => { 
                    const imageUrl = args[0] || 'https://via.placeholder.com/300x150/00FF00/000000?text=Web-CLI+Image'; 
                    
                    writeOutput(`display: 正在尝试从 ${imageUrl} 加载图像...`, 'welcome');
                    
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = '模拟图像';
                    img.style.maxWidth = '300px'; 
                    img.style.height = 'auto';
                    img.style.display = 'block'; 

                    output.appendChild(img);
                    scrollToBottom();

                    writeOutput('图像加载完毕。', 'welcome');
                } 
            },
            
            // CBONSAI 命令 (已修正为动画)
            'cbonsai': {
                description: '模拟 cbonsai 盆栽生长动画。Ctrl+C 退出。',
                execute: () => {
                    if (cbonsaiIntervalId !== null) { writeOutput('cbonsai 已经在生长。', 'error'); return; }

                    output.innerHTML = ''; 
                    writeOutput('正在种植盆栽 (C-Bonsai)...', 'welcome');
                    
                    const bonsaiDiv = document.createElement('div');
                    bonsaiDiv.id = 'cbonsai-animation';
                    bonsaiDiv.style.color = '#33cc33'; 
                    bonsaiDiv.style.whiteSpace = 'pre'; 
                    output.appendChild(bonsaiDiv);

                    input.disabled = true;
                    promptSpan.innerText = 'GROWING... (按 Ctrl+C 停止)';
                    promptSpan.style.color = '#33cc33'; 
                    
                    const frames = [
                        `
                          .
                         / \\
                        /___\\
                       |     |
                       |_____|
                        \\___/
                         | |
                         |_|
                        
`,
                        `
                          .
                         / \\
                        /___\\
                       | @   |
                       |_____|
                        \\___/
                         | |
                         |_|
`,
                        `
                          /\\
                         /  \\
                        / @  \\
                       | / \\ |
                       |_____|
                        \\___/
                         | |
                         |_|
`,
                        `
                      _.._
                     / \\  \\
                    /  @   \\
                   | /\\ /\\ |
                   |_______|
                    \\_____/
                     | | |
                     | | |
`,
                        `
                       _..._
                     ,dP""YMb,
                    dP'  @  'YMb
                   |    / \\    |
                   |___/___\\___|
                    \\_________ /
                     |  |  |  |
                     |  |  |  |
`,
                        `
                      _..._
                     ,d88""Y8b,
                    d88' @  '88b
                   |888 / \\ 888|
                   |___/___\\___|
                    \\_________ /
                     |  |  |  |
                     |  |  |  |
`
                    ];
                    let currentFrame = 0;
                    const TOTAL_FRAMES = frames.length;

                    const growBonsai = () => {
                        if (currentFrame >= TOTAL_FRAMES) {
                            clearInterval(cbonsaiIntervalId);
                            cbonsaiIntervalId = null;
                            input.disabled = false;
                            updatePrompt();
                            input.focus();
                            promptSpan.style.color = 'var(--prompt-color)';
                            writeOutput('\nBonsai 生长完成！ 输入 Ctrl+C 即可清除画面。', 'welcome');
                            return;
                        }
                        
                        bonsaiDiv.textContent = frames[currentFrame];
                        currentFrame++;
                        scrollToBottom();
                    };

                    cbonsaiIntervalId = setInterval(growBonsai, 500);
                }
            },
            
            // SL 命令
            'sl': {
                description: '运行一辆 ASCII 蒸汽火车穿越终端。Ctrl+C 退出。',
                execute: () => {
                    if (slIntervalId !== null) { writeOutput('sl 已经在运行。', 'error'); return; }
                    output.innerHTML = ''; 
                    writeOutput('正在启动 SL 蒸汽火车...', 'welcome');
                    const slDiv = document.createElement('p');
                    slDiv.id = 'sl-train-animation';
                    slDiv.style.color = '#ffff00'; 
                    slDiv.style.whiteSpace = 'pre'; 
                    output.appendChild(slDiv);
                    input.disabled = true;
                    promptSpan.innerText = 'SL RUNNING... (按 Ctrl+C 停止)';
                    promptSpan.style.color = '#ff0000'; 
                    const train = `
    W W     WWWWWWWWWWWWWW
  /|||||||||||||||||||\\
 /_ _________________ _\\
| O O O O O O O O O O |
 \`--o-o--'--o-o--'-o-o-'\`
`;
                    const smokeFrames = ['  _',' _ ', '__', ' _ ','  __'];
                    let smokeIndex = 0;
                    let position = -40; 
                    const refreshTrain = () => {
                        const width = output.clientWidth;
                        if (position > width / 6) { 
                            clearInterval(slIntervalId);
                            slIntervalId = null;
                            output.innerHTML = ''; 
                            writeOutput('蒸汽火车已通过。', 'welcome');
                            input.disabled = false;
                            updatePrompt();
                            input.focus();
                            promptSpan.style.color = 'var(--prompt-color)';
                            return;
                        }
                        const currentSmoke = smokeFrames[smokeIndex].padEnd(4, ' ');
                        const trainWithSmoke = train.replace('W W', currentSmoke); 
                        smokeIndex = (smokeIndex + 1) % smokeFrames.length;
                        slDiv.style.paddingLeft = position + 'px';
                        slDiv.textContent = trainWithSmoke;
                        position += 2; 
                        scrollToBottom();
                    };
                    slIntervalId = setInterval(refreshTrain, 80);
                }
            },

            // GIFWRAP 命令
            'gifwrap': {
                description: '模拟在终端中播放 ASCII 动画。Ctrl+C 退出。',
                execute: () => {
                    if (gifwrapIntervalId !== null) { writeOutput('gifwrap 已经在运行。', 'error'); return; }
                    output.innerHTML = ''; 
                    writeOutput('正在启动 GIFWRAP 动画...', 'welcome');
                    const gifwrapDiv = document.createElement('div');
                    gifwrapDiv.id = 'gifwrap-animation';
                    output.appendChild(gifwrapDiv);
                    input.disabled = true;
                    promptSpan.innerText = 'ANIMATING... (按 Ctrl+C 停止)';
                    promptSpan.style.color = '#ff8000'; 
                    const frames = [
                        `\n  (^_^)/\n   | |\n  / \\`,
                        `\n  \\(^_^)/\n    | |\n   / \\`,
                        `\n  /(^_^)\\\n   | |\n  / \\`,
                        `\n  (^_^)\\\n   | |\n  / \\`
                    ];
                    let currentFrame = 0;
                    const refreshAnimation = () => {
                        currentFrame = (currentFrame + 1) % frames.length;
                        gifwrapDiv.textContent = frames[currentFrame];
                        scrollToBottom();
                    };
                    gifwrapIntervalId = setInterval(refreshAnimation, 150);
                }
            },
            
            // GKRELLM 命令
            'gkrellm': {
                description: '模拟 GKrellM 系统监视器。Ctrl+C 退出。',
                execute: () => {
                    if (gkrellmIntervalId !== null) { writeOutput('gkrellm 已经在运行。', 'error'); return; }
                    output.innerHTML = '';
                    writeOutput('正在启动 GKrellM 模拟器...', 'welcome');
                    const gkrellmDiv = document.createElement('div');
                    gkrellmDiv.id = 'gkrellm-monitor';
                    output.appendChild(gkrellmDiv);
                    input.disabled = true;
                    promptSpan.innerText = 'MONITORING... (按 Ctrl+C 停止)';
                    promptSpan.style.color = '#ff00ff'; 
                    let cpuUsage = 15, memUsage = 60, netRx = 0.1, netTx = 0.05;
                    const refreshMonitor = () => {
                        cpuUsage = Math.min(100, Math.max(5, cpuUsage + (Math.random() * 8 - 4)));
                        memUsage = Math.min(95, Math.max(50, memUsage + (Math.random() * 2 - 1)));
                        netRx = Math.max(0.01, netRx + (Math.random() * 0.2 - 0.1));
                        netTx = Math.max(0.01, netTx + (Math.random() * 0.1 - 0.05));
                        const cpuBar = '█'.repeat(Math.round(cpuUsage / 10)).padEnd(10, '░');
                        const memBar = '█'.repeat(Math.round(memUsage / 10)).padEnd(10, '░');
                        const monitorAscii = `
┌───────────────────────────┐
│ Web-CLI GKrellM Simulator │
├───────────────────────────┤
│ CPU: [${cpuBar}] ${cpuUsage.toFixed(1).padEnd(5, ' ')}%     │
│ Memory: [${memBar}] ${memUsage.toFixed(1).padEnd(5, ' ')}%    │
│ Net I/F: Rx: ${netRx.toFixed(2).padEnd(5, '0')} MB/s        │
└───────────────────────────┘
`;
                        gkrellmDiv.textContent = monitorAscii;
                        scrollToBottom();
                    };
                    refreshMonitor();
                    gkrellmIntervalId = setInterval(refreshMonitor, 1000);
                }
            },
            
            // XSNOW 命令 (已修正降落深度和速度)
            'xsnow': {
                description: '模拟终端降雪效果。按 Ctrl+C 退出。',
                execute: () => {
                    if (xsnowIntervalId !== null) { writeOutput('xsnow 已经在运行。请按 Ctrl+C 退出。', 'error'); return; }
                    const terminalContainer = document.getElementById('terminal-container');
                    const snowContainer = document.createElement('div');
                    snowContainer.id = 'xsnow-container';
                    snowContainer.style.position = 'absolute';
                    snowContainer.style.top = '0';
                    snowContainer.style.left = '0';
                    snowContainer.style.width = '100%';
                    snowContainer.style.height = '100%';
                    snowContainer.style.pointerEvents = 'none'; 
                    snowContainer.style.overflow = 'hidden'; 
                    snowContainer.style.zIndex = '1'; 
                    terminalContainer.appendChild(snowContainer); 
                    input.disabled = true;
                    promptSpan.innerText = 'SNOWING... (按 Ctrl+C 停止)';
                    promptSpan.style.color = '#87ceeb'; 
                    let flakeCount = 0; 
                    const MAX_FLAKES = 100;
                    const createFlake = () => {
                        if (xsnowIntervalId === null || flakeCount >= MAX_FLAKES) return; 
                        flakeCount++;
                        const flake = document.createElement('span');
                        flake.textContent = (Math.random() > 0.5 ? '*' : '•');
                        flake.className = 'snowflake';
                        const startX = Math.random() * 100; 
                        const size = Math.random() * 0.8 + 0.4; 
                        const duration = Math.random() * 10 + 5; // 5s 到 15s 降落时间
                        const delay = Math.random() * 10; 
                        flake.style.cssText = `
                            position: absolute;
                            top: -5%; 
                            left: ${startX}%;
                            font-size: ${size}rem;
                            color: white; 
                            opacity: ${Math.random() * 0.5 + 0.5};
                            pointer-events: none;
                            z-index: 999;
                            animation: fall ${duration}s linear infinite;
                            animation-delay: -${delay}s; 
                        `;
                        snowContainer.appendChild(flake);
                        setTimeout(() => {
                            if (flake.parentNode) {
                                flakeCount--;
                                flake.remove();
                            }
                        }, duration * 1000 + 1000); 
                    };
                    output.innerHTML = '';
                    writeOutput('❄️ XSnow: 启动降雪模式 (降落深度已修正)...', 'welcome');
                    scrollToBottom();
                    xsnowIntervalId = setInterval(createFlake, 200); 
                }
            }
        };

        // --- 事件监听和初始化 ---
        function handleInput() {
            const commandLine = input.value.trim();
            if (commandLine === '') return;

            writeCommandHistory(commandLine);
            history.push(commandLine);
            historyIndex = history.length; 

            const parts = commandLine.split(/\s+/);
            const command = parts[0].toLowerCase();
            const args = parts.slice(1);

            const cmd = commands[command];
            if (cmd) {
                // 特效/动画命令
                if (['curl', 'ping', 'ncat', 'gkrellm', 'gifwrap', 'sl', 'xsnow', 'cbonsai', 'display'].includes(command)) {
                    // 对于模拟延迟或动画命令，不要清空 input.value，直到它们完成或被中断
                    cmd.execute(args);
                } else {
                    cmd.execute(args);
                    input.value = '';
                    input.focus();
                }
            } else {
                writeOutput(`命令未找到: ${command}. 输入 'help' 查看命令。`, 'error');
                input.value = '';
                input.focus();
            }
        }                

        function writeWelcome() {
            writeOutput('', '');
            writeOutput('', '');
            writeOutput('', '');
            writeOutput('', '');
            writeOutput('', '');
        }

        input.addEventListener('keydown', (e) => {
            // 监听 Ctrl+C 组合键 (清理所有特效的关键部分)
            if ((e.key === 'c' || e.key === 'C') && e.ctrlKey) {
                // 检查所有定时器 ID
                if (gkrellmIntervalId !== null || gifwrapIntervalId !== null || slIntervalId !== null || xsnowIntervalId !== null || cbonsaiIntervalId !== null || pingIntervalId !== null) {
                    e.preventDefault(); 
                    
                    // 清理所有定时器
                    if (gkrellmIntervalId !== null) {
                        clearInterval(gkrellmIntervalId);
                        gkrellmIntervalId = null;
                    }
                    if (gifwrapIntervalId !== null) {
                        clearInterval(gifwrapIntervalId);
                        gifwrapIntervalId = null;
                    }
                    if (slIntervalId !== null) {
                        clearInterval(slIntervalId);
                        slIntervalId = null;
                    }
                    if (cbonsaiIntervalId !== null) { 
                        clearInterval(cbonsaiIntervalId);
                        cbonsaiIntervalId = null;
                    }
                    // 清理 ping 定时器
                    if (pingIntervalId !== null) { 
                        clearInterval(pingIntervalId);
                        pingIntervalId = null;
                    }
                    if (xsnowIntervalId !== null) {
                        clearInterval(xsnowIntervalId);
                        xsnowIntervalId = null;
                        const snowContainer = document.getElementById('xsnow-container');
                        if (snowContainer) {
                            snowContainer.remove();
                        }
                    }
                    
                    output.innerHTML = ''; 
                    writeOutput('^C', 'error'); 
                    writeOutput('操作已中断。', 'welcome');
                    
                    input.disabled = false;
                    updatePrompt();
                    input.focus();
                    promptSpan.style.color = 'var(--prompt-color)';
                    input.value = ''; // 确保中断后输入框是清空的
                    return;
                }
            }

            if (e.key === 'Enter') {
                if (input.disabled) return; 
                handleInput();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (historyIndex > 0) {
                    historyIndex--;
                    input.value = history[historyIndex];
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (historyIndex < history.length - 1) {
                    historyIndex++;
                    input.value = history[historyIndex];
                } else {
                    historyIndex = history.length;
                    input.value = '';
                }
            } else if (e.key === 'Tab') {
                e.preventDefault();
                if (!input.disabled) {
                    autoComplete();
                }
            }
        });

        document.getElementById('terminal-container').addEventListener('click', () => {
            if (!input.disabled) {
                input.focus();
            }
        });

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            updatePrompt();
            writeWelcome();
            input.focus();
        });
    </script>
</body>
</html>
